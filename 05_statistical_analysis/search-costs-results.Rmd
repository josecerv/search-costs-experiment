---
title: "Search Costs Field Experiment"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
    fig_caption: true
    keep_tex: true
    keep_md: true
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{float}
  - \usepackage{pdflscape}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
  - \usepackage{caption}
  - \captionsetup[table]{position=below,skip=10pt}
  - \usepackage{dcolumn}
  - \usepackage{adjustbox}
  - \usepackage{tabularx}
  - \newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      fig.pos = 'H', results = 'asis')

# Load required libraries
library(tidyverse)
library(stargazer)
library(lmtest)
library(sandwich)
library(systemfit)
library(knitr)
library(kableExtra)
library(car)  # For linearHypothesis

# Note: We'll use manual table generation instead of modelsummary
# to have full control over column spacing

# Set stargazer options
options(width = 200)

data <- read.csv("outputs/master_analysis_dataset.csv")


# Data validation
# cat("Data loaded successfully. N =", nrow(data), "\n")
# cat("Treatment:", sum(data$treatment), "Control:", sum(1-data$treatment), "\n\n")

# Create bin_11_17 dummy variable (since we're using bin_17_26 as reference)
# This represents the (11,17] bin category
data$bin_11_17 <- as.numeric(data$bin_category == "(11,17]")

# Create all derived variables at once
data <- data %>%
  mutate(
    # Non-URM counts
    num_non_urm = speakers_with_demographics - num_urm,
    fall_num_non_urm = fall_speakers_with_demographics - fall_num_urm,
    spring_num_non_urm = spring_speakers_with_demographics - spring_num_urm,
    
    # Non-demographic counts
    num_non_black = speakers_with_demographics - num_black,
    num_non_hispanic = speakers_with_demographics - num_hispanic,
    num_non_female = speakers_with_demographics - num_female,
    
    fall_num_non_black = fall_speakers_with_demographics - fall_num_black,
    fall_num_non_hispanic = fall_speakers_with_demographics - fall_num_hispanic,
    fall_num_non_female = fall_speakers_with_demographics - fall_num_female,
    
    spring_num_non_black = spring_speakers_with_demographics - spring_num_black,
    spring_num_non_hispanic = spring_speakers_with_demographics - spring_num_hispanic,
    spring_num_non_female = spring_speakers_with_demographics - spring_num_female,
    
    # Non-URM percentages
    pct_non_urm = ifelse(speakers_with_demographics > 0, 100 - pct_urm, 0),
    fall_pct_non_urm = ifelse(fall_speakers_with_demographics > 0, 100 - fall_pct_urm, 0),
    spring_pct_non_urm = ifelse(spring_speakers_with_demographics > 0, 100 - spring_pct_urm, 0),
    
    # Binary indicators
    has_any_non_urm = as.numeric(num_non_urm > 0),
    fall_has_any_urm = as.numeric(fall_num_urm > 0),
    spring_has_any_urm = as.numeric(spring_num_urm > 0),
    fall_has_any_non_urm = as.numeric(fall_num_non_urm > 0),
    spring_has_any_non_urm = as.numeric(spring_num_non_urm > 0),
    
    # Additional binary indicators for Black, Hispanic, and Female
    fall_has_any_black = as.numeric(fall_num_black > 0),
    spring_has_any_black = as.numeric(spring_num_black > 0),
    fall_has_any_hispanic = as.numeric(fall_num_hispanic > 0),
    spring_has_any_hispanic = as.numeric(spring_num_hispanic > 0),
    fall_has_any_female = as.numeric(fall_num_female > 0),
    spring_has_any_female = as.numeric(spring_num_female > 0),
    
    # For total speakers analysis
    pct_speakers = 100,  # All seminars have speakers by definition
    has_speakers = 1     # All seminars in dataset have speakers
  )

# Function to create clustered standard errors
get_clustered_se <- function(model, cluster_var) {
  vcov_cluster <- vcovCL(model, cluster = cluster_var)
  return(sqrt(diag(vcov_cluster)))
}

# Function to run regression with clustered SEs
run_regression <- function(formula_str, data_subset, cluster_var = "department_std") {
  # Remove rows with missing values in the model variables
  model_vars <- all.vars(as.formula(formula_str))
  # Ensure all model_vars are actually columns in data_subset
  model_vars <- model_vars[model_vars %in% names(data_subset)]
  
  data_complete <- data_subset[complete.cases(data_subset[, model_vars, drop = FALSE]), ]
  
  if (nrow(data_complete) < 30) {
    # warning("Less than 30 observations after removing missing values for formula: ", formula_str)
    return(NULL)
  }
  
  model <- lm(as.formula(formula_str), data = data_complete)
  
  # Get clustered standard errors
  cluster_data <- data_complete[[cluster_var]]
  model$cluster_se <- get_clustered_se(model, cluster_data)
  
  return(model)
}

# Define control variables
# Note: We omit batch_10 and bin_17_26 as reference categories to avoid perfect multicollinearity
# The bin categories in the data are: [0,1], (1,3], (3,5], (5,7], (7,11], (11,17], (17,26]
# We need to create bin_11_17 dummy since we're using bin_17_26 as reference
base_controls <- c("bin_0_1", "bin_1_3", "bin_3_5", "bin_5_7", "bin_7_11", "bin_11_17",
                   "disc_mathematics", "disc_physics", "disc_computer_science", 
                   "disc_mechanical_engineering",
                   "batch_1", "batch_2", "batch_3", "batch_4", "batch_5", 
                   "batch_6", "batch_7", "batch_8", "batch_9")

extended_controls <- c("total_faculty", "frac_urm_faculty", "frac_women_faculty",
                       "dept_ranking", "missing_dept_rank", 
                       "total_urm_peer_faculty", "total_peer_departments",
                       "num_recipients")

create_regression_table <- function(models, title, label, demographic_group = NULL, 
                                   is_moderator = FALSE, moderator_name = NULL) {
  
  # Filter out NULL models
  valid_models <- models[!sapply(models, is.null)]
  if (length(valid_models) == 0) {
    return(invisible(NULL))
  }
  
  n_models <- length(valid_models)
  
  # Name the models for modelsummary
  names(valid_models) <- paste0("(", 1:n_models, ")")
  
  # Determine which coefficients to show
  if (is_moderator) {
    # For moderation tables, we need to find the moderator and interaction names
    mod_name <- NULL
    int_name <- NULL
    for (m in valid_models) {
      coef_names <- names(coef(m))
      potential_mod <- setdiff(coef_names, c("treatment", "(Intercept)"))
      potential_mod <- potential_mod[!grepl(":", potential_mod)]
      if (length(potential_mod) > 0) {
        mod_name <- potential_mod[1]
        int_candidates <- coef_names[grepl(":", coef_names)]
        if (length(int_candidates) > 0) {
          int_name <- int_candidates[1]
          break
        }
      }
    }
    
    # Create coefficient map for moderation
    coef_map <- c("treatment" = "Treatment",
                  "(Intercept)" = "Constant")
    if (!is.null(mod_name)) {
      coef_map[mod_name] <- moderator_name
    }
    if (!is.null(int_name)) {
      coef_map[int_name] <- paste0("Treatment $\\times$ ", moderator_name)
    }
  } else {
    # For regular tables, just show treatment and intercept
    coef_map <- c("treatment" = "Treatment",
                  "(Intercept)" = "Constant")
  }
  
  # Always use manual approach for consistent spacing
  if (TRUE) {
    # Manual table generation (same as before but for all model counts)
    
    # Extract coefficients and standard errors
    extract_coef_se <- function(models, var_name) {
      coefs <- sapply(models, function(m) {
        if (var_name %in% names(coef(m))) {
          sprintf("%.3f", coef(m)[var_name])
        } else "—"
      })
      
      ses <- sapply(models, function(m) {
        if (var_name %in% names(m$cluster_se)) {
          sprintf("(%.3f)", m$cluster_se[var_name])
        } else ""
      })
      
      p_vals <- sapply(models, function(m) {
        if (var_name %in% names(coef(m)) && var_name %in% names(m$cluster_se)) {
          t_stat <- coef(m)[var_name] / m$cluster_se[var_name]
          2 * pt(-abs(t_stat), df = length(m$residuals) - length(coef(m)))
        } else NA
      })
      
      stars <- sapply(p_vals, function(p) {
        if (is.na(p)) return("")
        if (p < 0.001) return("***")
        if (p < 0.01) return("**")
        if (p < 0.05) return("*")
        if (p < 0.1) return("+")
        return("")
      })
      
      coef_stars <- ifelse(coefs == "—", "—", paste0(coefs, "$^{", stars, "}$"))
      
      list(coef_stars = coef_stars, ses = ses)
    }
    
    # Build the table manually
    cat("\\begin{table}[H]\n")
    cat(paste0("\\caption{", title, "}\n"))
    cat(paste0("\\label{", label, "}\n"))
    cat("\\centering\n")
    cat("\\scriptsize\n")
    
    # Try tabularx for better spacing control
    if (n_models == 6) {
      # Use tabularx with fixed total width
      cat("\\begin{tabularx}{\\textwidth}{l*{6}{>{\\centering\\arraybackslash}X}}\n")
    } else {
      cat(paste0("\\begin{tabular}{l", paste(rep("c", n_models), collapse = ""), "}\n"))
    }
    
    cat("\\toprule\n")
    
    # Headers for different table types - try without multicolumn to diagnose
    if (n_models == 6) {
      if (is_moderator) {
        # Place headers above individual columns without multicolumn
        cat(" & \\% URM & \\% URM & Count URM & Count URM & Any URM & Any URM \\\\\n")
      } else if (!is.null(demographic_group)) {
        cat(paste0(" & \\% ", demographic_group, " & \\% ", demographic_group, 
                   " & Count ", demographic_group, " & Count ", demographic_group,
                   " & Any ", demographic_group, " & Any ", demographic_group, " \\\\\n"))
      } else {
        cat(" & Model 1 & Model 2 & Model 3 & Model 4 & Model 5 & Model 6 \\\\\n")
      }
    }
    
    # Model numbers
    cat(" & ", paste(paste0("(", 1:n_models, ")"), collapse = " & "), " \\\\\n")
    cat("\\midrule\n")
    
    # Add coefficient rows based on coef_map
    for (var_name in names(coef_map)) {
      var_data <- extract_coef_se(valid_models, var_name)
      cat(coef_map[var_name], " & ", paste(var_data$coef_stars, collapse = " & "), " \\\\\n")
      if (any(var_data$ses != "")) {
        cat(" & ", paste(var_data$ses, collapse = " & "), " \\\\\n")
      }
    }
    
    # Statistics
    cat("\\midrule\n")
    
    # Controls row
    if (n_models %% 2 == 0) {
      controls_text <- paste(rep(c("Simple", "Extended"), n_models/2), collapse = " & ")
    } else {
      controls_text <- paste(rep("Yes", n_models), collapse = " & ")
    }
    cat("Controls & ", controls_text, " \\\\\n")
    
    # N and R²
    n_obs <- sapply(valid_models, function(m) format(length(m$residuals), big.mark=","))
    adj_r2 <- sapply(valid_models, function(m) sprintf("%.3f", summary(m)$adj.r.squared))
    
    cat("N & ", paste(n_obs, collapse = " & "), " \\\\\n")
    cat("Adjusted $R^2$ & ", paste(adj_r2, collapse = " & "), " \\\\\n")
    
    cat("\\bottomrule\n")
    cat(paste0("\\multicolumn{", n_models + 1, "}{l}{\\parbox{\\linewidth}{\\footnotesize \\vspace{2pt}Clustered standard errors at department level in parentheses.}}\\\\\n"))
    cat(paste0("\\multicolumn{", n_models + 1, "}{l}{\\parbox{\\linewidth}{\\footnotesize $^{+}p<0.1$; $^{*}p<0.05$; $^{**}p<0.01$; $^{***}p<0.001$\\vspace{2pt}}}\\\\\n"))
    
    # Close the appropriate table environment
    if (n_models == 6) {
      cat("\\end{tabularx}\n")
    } else {
      cat("\\end{tabular}\n")
    }
    cat("\\end{table}\n")
    
    return(invisible(NULL))
  }
}

# Wrapper functions for compatibility
create_stargazer_table <- function(models, dep_var_labels, title, label, 
                                  keep_vars = c("treatment", "Constant"),
                                  covariate_labels = c("Treatment", "Constant"),
                                  demographic_group = NULL) {
  create_regression_table(models, title, label, demographic_group, 
                         is_moderator = FALSE, moderator_name = NULL)
}

create_moderator_table <- function(models, dep_var_labels, title, label, moderator_name) {
  create_regression_table(models, title, label, NULL, 
                         is_moderator = TRUE, moderator_name = moderator_name)
}


# Helper function to create intersectional variables
create_intersectional_vars <- function(data, demo1, demo2, label) {
  pct_col <- paste0("pct_", label)
  num_col <- paste0("approx_num_", label)
  has_col <- paste0("has_any_", label)
  
  data[[pct_col]] <- (data[[paste0("pct_", demo1)]] / 100) * 
                     (data[[paste0("pct_", demo2)]] / 100) * 100
  
  data[[num_col]] <- ifelse(data$speakers_with_demographics > 0,
                           round((data[[paste0("num_", demo1)]] / data$speakers_with_demographics) * 
                                 (data[[paste0("num_", demo2)]] / data$speakers_with_demographics) * 
                                 data$speakers_with_demographics),
                           0) 
  
  data[[num_col]][is.na(data[[num_col]])] <- 0
  data[[pct_col]][is.na(data[[pct_col]])] <- 0 
  
  data[[has_col]] <- as.numeric(data[[num_col]] > 0)
  
  return(data)
}

# Create all intersectional variables
data <- create_intersectional_vars(data, "urm", "female", "urm_female")
data <- create_intersectional_vars(data, "black", "female", "black_female")
data <- create_intersectional_vars(data, "black", "male", "black_male") 
data <- create_intersectional_vars(data, "hispanic", "female", "hispanic_female")
data <- create_intersectional_vars(data, "hispanic", "male", "hispanic_male") 


# Initialize list to store all models for significant results extraction
all_models_list <- list()

# Function to escape LaTeX special characters
escape_latex <- function(x) {
  if (is.null(x) || is.na(x)) return(x)
  x <- gsub("&", "\\\\&", x)
  x <- gsub("%", "\\\\%", x)
  x <- gsub("#", "\\\\#", x)
  x <- gsub("_", "\\\\_", x)
  x <- gsub("\\{", "\\\\{", x)
  x <- gsub("\\}", "\\\\}", x)
  x <- gsub("~", "\\\\textasciitilde{}", x)
  x <- gsub("\\^", "\\\\textasciicircum{}", x)
  return(x)
}
```



\newpage

# Summary Statistics

## Overall Summary Statistics

### Seminar Speaker Demographics

```{r summary-stats-overall-seminars}
# Overall summary statistics for seminar speakers
summary_seminars <- data %>%
  summarise(
    n_seminars = n(),
    n_unique_departments = n_distinct(department_std),
    total_speakers_all = sum(total_speakers, na.rm = TRUE),
    mean_speakers_per_seminar = mean(total_speakers, na.rm = TRUE),
    sd_speakers_per_seminar = sd(total_speakers, na.rm = TRUE),
    min_speakers = min(total_speakers, na.rm = TRUE),
    max_speakers = max(total_speakers, na.rm = TRUE),
    
    # URM stats
    mean_pct_urm = mean(pct_urm, na.rm = TRUE),
    sd_pct_urm = sd(pct_urm, na.rm = TRUE),
    mean_num_urm = mean(num_urm, na.rm = TRUE),
    sd_num_urm = sd(num_urm, na.rm = TRUE),
    pct_seminars_has_urm = mean(has_any_urm, na.rm = TRUE) * 100,
    
    # Black stats
    mean_pct_black = mean(pct_black, na.rm = TRUE),
    sd_pct_black = sd(pct_black, na.rm = TRUE),
    mean_num_black = mean(num_black, na.rm = TRUE),
    sd_num_black = sd(num_black, na.rm = TRUE),
    pct_seminars_has_black = mean(has_any_black, na.rm = TRUE) * 100,
    
    # Hispanic stats
    mean_pct_hispanic = mean(pct_hispanic, na.rm = TRUE),
    sd_pct_hispanic = sd(pct_hispanic, na.rm = TRUE),
    mean_num_hispanic = mean(num_hispanic, na.rm = TRUE),
    sd_num_hispanic = sd(num_hispanic, na.rm = TRUE),
    pct_seminars_has_hispanic = mean(has_any_hispanic, na.rm = TRUE) * 100,
    
    # Female stats
    mean_pct_female = mean(pct_female, na.rm = TRUE),
    sd_pct_female = sd(pct_female, na.rm = TRUE),
    mean_num_female = mean(num_female, na.rm = TRUE),
    sd_num_female = sd(num_female, na.rm = TRUE),
    pct_seminars_has_female = mean(has_any_female, na.rm = TRUE) * 100
  )

# First table: Basic seminar information
cat("\\begin{table}[H]\n")
cat("\\caption{Overall Seminar Statistics}\n")
cat("\\label{tab:summary_seminars_basic}\n")
cat("\\centering\n")
cat("\\begin{tabular}{lr}\n")
cat("\\toprule\n")
cat("Statistic & Value \\\\\n")
cat("\\midrule\n")
cat(sprintf("Number of seminars & %d \\\\\n", summary_seminars$n_seminars))
cat(sprintf("Number of unique departments & %d \\\\\n", summary_seminars$n_unique_departments))
cat(sprintf("Total speakers across all seminars & %d \\\\\n", summary_seminars$total_speakers_all))
cat(sprintf("Mean speakers per seminar & %.2f \\\\\n", summary_seminars$mean_speakers_per_seminar))
cat(sprintf("SD speakers per seminar & %.2f \\\\\n", summary_seminars$sd_speakers_per_seminar))
cat(sprintf("Min speakers in a seminar & %d \\\\\n", summary_seminars$min_speakers))
cat(sprintf("Max speakers in a seminar & %d \\\\\n", summary_seminars$max_speakers))
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\end{table}\n")

# Second table: Speaker demographics in seminars
cat("\n\\begin{table}[H]\n")
cat("\\caption{Seminar Speaker Demographics (Across All Seminars)}\n")
cat("\\label{tab:summary_seminar_demographics}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccc}\n")
cat("\\toprule\n")
cat("Demographic Group & Mean \\% & SD \\% & Mean Count & SD Count & Pct. Any \\\\\n")
cat("\\midrule\n")
cat(sprintf("URM & %.2f & %.2f & %.2f & %.2f & %.1f \\\\\n",
            summary_seminars$mean_pct_urm, summary_seminars$sd_pct_urm,
            summary_seminars$mean_num_urm, summary_seminars$sd_num_urm,
            summary_seminars$pct_seminars_has_urm))
cat(sprintf("Black & %.2f & %.2f & %.2f & %.2f & %.1f \\\\\n",
            summary_seminars$mean_pct_black, summary_seminars$sd_pct_black,
            summary_seminars$mean_num_black, summary_seminars$sd_num_black,
            summary_seminars$pct_seminars_has_black))
cat(sprintf("Hispanic & %.2f & %.2f & %.2f & %.2f & %.1f \\\\\n",
            summary_seminars$mean_pct_hispanic, summary_seminars$sd_pct_hispanic,
            summary_seminars$mean_num_hispanic, summary_seminars$sd_num_hispanic,
            summary_seminars$pct_seminars_has_hispanic))
cat(sprintf("Female & %.2f & %.2f & %.2f & %.2f & %.1f \\\\\n",
            summary_seminars$mean_pct_female, summary_seminars$sd_pct_female,
            summary_seminars$mean_num_female, summary_seminars$sd_num_female,
            summary_seminars$pct_seminars_has_female))
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\parbox{\\linewidth}{\\footnotesize Note: N = ", summary_seminars$n_seminars, " seminars. Percentages calculated among speakers with demographic data available. 'Pct. Any' indicates the percentage of seminars that have at least one speaker from that demographic group.}\n")
cat("\\end{table}\n")
```

### Department Faculty Demographics

```{r summary-stats-overall-departments}
# Department faculty demographics (aggregated to department level)
dept_summary <- data %>%
  group_by(department_std) %>%
  summarise(
    # Take the first value for each department (since faculty demographics are constant within department)
    total_faculty = first(total_faculty),
    frac_urm_faculty = first(frac_urm_faculty),
    frac_women_faculty = first(frac_women_faculty),
    .groups = 'drop'
  ) %>%
  summarise(
    n_departments = n(),
    mean_total_faculty = mean(total_faculty, na.rm = TRUE),
    sd_total_faculty = sd(total_faculty, na.rm = TRUE),
    mean_pct_urm_faculty = mean(frac_urm_faculty * 100, na.rm = TRUE),
    sd_pct_urm_faculty = sd(frac_urm_faculty * 100, na.rm = TRUE),
    mean_pct_women_faculty = mean(frac_women_faculty * 100, na.rm = TRUE),
    sd_pct_women_faculty = sd(frac_women_faculty * 100, na.rm = TRUE)
  )

# Department faculty table
cat("\n\\begin{table}[H]\n")
cat("\\caption{Department Faculty Demographics}\n")
cat("\\label{tab:summary_dept_faculty}\n")
cat("\\centering\n")
cat("\\begin{tabular}{lcc}\n")
cat("\\toprule\n")
cat("Statistic & Mean & SD \\\\\n")
cat("\\midrule\n")
cat(sprintf("Total faculty per department & %.1f & %.1f \\\\\n",
            dept_summary$mean_total_faculty, dept_summary$sd_total_faculty))
cat(sprintf("\\%% URM faculty & %.2f & %.2f \\\\\n",
            dept_summary$mean_pct_urm_faculty, dept_summary$sd_pct_urm_faculty))
cat(sprintf("\\%% Women faculty & %.2f & %.2f \\\\\n",
            dept_summary$mean_pct_women_faculty, dept_summary$sd_pct_women_faculty))
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\parbox{\\linewidth}{\\footnotesize Note: N = ", dept_summary$n_departments, " unique departments. Department faculty demographics based on 2024 coding.}\n")
cat("\\end{table}\n")
```

## Summary Statistics by Discipline

### Seminar Speaker Demographics by Discipline

```{r summary-stats-discipline-seminars}
# Summary statistics by discipline for seminars
summary_by_disc_seminars <- data %>%
  mutate(discipline = case_when(
    disc_mathematics == 1 ~ "Mathematics",
    disc_physics == 1 ~ "Physics",
    disc_computer_science == 1 ~ "Computer Science",
    disc_mechanical_engineering == 1 ~ "Mechanical Engineering",
    TRUE ~ "Chemistry" # Default if none of the others are 1
  )) %>%
  group_by(discipline) %>%
  summarise(
    n_seminars = n(),
    n_departments = n_distinct(department_std),
    mean_speakers_per_seminar = mean(total_speakers, na.rm = TRUE),
    sd_speakers_per_seminar = sd(total_speakers, na.rm = TRUE),
    
    # URM stats
    mean_pct_urm = mean(pct_urm, na.rm = TRUE),
    sd_pct_urm = sd(pct_urm, na.rm = TRUE),
    mean_num_urm = mean(num_urm, na.rm = TRUE),
    pct_has_urm = mean(has_any_urm, na.rm = TRUE) * 100,
    
    # Black stats
    mean_pct_black = mean(pct_black, na.rm = TRUE),
    mean_num_black = mean(num_black, na.rm = TRUE),
    pct_has_black = mean(has_any_black, na.rm = TRUE) * 100,
    
    # Hispanic stats
    mean_pct_hispanic = mean(pct_hispanic, na.rm = TRUE),
    mean_num_hispanic = mean(num_hispanic, na.rm = TRUE),
    pct_has_hispanic = mean(has_any_hispanic, na.rm = TRUE) * 100,
    
    # Female stats
    mean_pct_female = mean(pct_female, na.rm = TRUE),
    mean_num_female = mean(num_female, na.rm = TRUE),
    pct_has_female = mean(has_any_female, na.rm = TRUE) * 100,
    
    .groups = 'drop'
  ) %>%
  arrange(discipline)

# Create formatted table for basic info
cat("\n\\begin{table}[H]\n")
cat("\\caption{Seminar Statistics by Discipline}\n")
cat("\\label{tab:summary_disc_basic}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lcccc}\n")
cat("\\toprule\n")
cat("Discipline & N Seminars & N Depts & Mean Speakers & SD Speakers \\\\\n")
cat("\\midrule\n")
for (i in 1:nrow(summary_by_disc_seminars)) {
  cat(sprintf("%s & %d & %d & %.1f & %.1f \\\\\n",
              summary_by_disc_seminars$discipline[i],
              summary_by_disc_seminars$n_seminars[i],
              summary_by_disc_seminars$n_departments[i],
              summary_by_disc_seminars$mean_speakers_per_seminar[i],
              summary_by_disc_seminars$sd_speakers_per_seminar[i]))
}
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\end{table}\n")

# Create formatted table for URM
cat("\n\\begin{table}[H]\n")
cat("\\caption{Seminar Speaker Demographics by Discipline: URM}\n")
cat("\\label{tab:summary_disc_urm}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccc}\n")
cat("\\toprule\n")
cat("Discipline & N Seminars & Mean \\% & SD \\% & Mean Count & Pct. Has Any \\\\\n")
cat("\\midrule\n")
for (i in 1:nrow(summary_by_disc_seminars)) {
  cat(sprintf("%s & %d & %.2f & %.2f & %.2f & %.1f \\\\\n",
              summary_by_disc_seminars$discipline[i],
              summary_by_disc_seminars$n_seminars[i],
              summary_by_disc_seminars$mean_pct_urm[i],
              summary_by_disc_seminars$sd_pct_urm[i],
              summary_by_disc_seminars$mean_num_urm[i],
              summary_by_disc_seminars$pct_has_urm[i]))
}
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\parbox{\\linewidth}{\\footnotesize Note: Statistics are for seminar speakers. 'Pct. Has Any' indicates percentage of seminars with at least one URM speaker.}\n")
cat("\\end{table}\n")

# Create formatted table for other demographics
cat("\n\\begin{table}[H]\n")
cat("\\caption{Seminar Speaker Demographics by Discipline: Other Groups}\n")
cat("\\label{tab:summary_disc_other}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lcccccc}\n")
cat("\\toprule\n")
cat(" & \\multicolumn{2}{c}{Black} & \\multicolumn{2}{c}{Hispanic} & \\multicolumn{2}{c}{Female} \\\\\n")
cat("Discipline & Mean \\% & Pct. Any & Mean \\% & Pct. Any & Mean \\% & Pct. Any \\\\\n")
cat("\\midrule\n")
for (i in 1:nrow(summary_by_disc_seminars)) {
  cat(sprintf("%s & %.2f & %.1f & %.2f & %.1f & %.2f & %.1f \\\\\n",
              summary_by_disc_seminars$discipline[i],
              summary_by_disc_seminars$mean_pct_black[i],
              summary_by_disc_seminars$pct_has_black[i],
              summary_by_disc_seminars$mean_pct_hispanic[i],
              summary_by_disc_seminars$pct_has_hispanic[i],
              summary_by_disc_seminars$mean_pct_female[i],
              summary_by_disc_seminars$pct_has_female[i]))
}
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\parbox{\\linewidth}{\\footnotesize Note: Statistics are for seminar speakers. 'Pct. Any' indicates percentage of seminars with at least one speaker from that group.}\n")
cat("\\end{table}\n")

```

### Department Faculty Demographics by Discipline

```{r summary-stats-discipline-departments, results='asis'}
# Department faculty demographics by discipline
dept_by_disc <- data %>%
  mutate(discipline = case_when(
    disc_mathematics == 1 ~ "Mathematics",
    disc_physics == 1 ~ "Physics",
    disc_computer_science == 1 ~ "Computer Science",
    disc_mechanical_engineering == 1 ~ "Mechanical Engineering",
    TRUE ~ "Chemistry"
  )) %>%
  group_by(discipline, department_std) %>%
  summarise(
    total_faculty = first(total_faculty),
    frac_urm_faculty = first(frac_urm_faculty),
    frac_women_faculty = first(frac_women_faculty),
    .groups = 'drop'
  ) %>%
  group_by(discipline) %>%
  summarise(
    n_departments = n(),
    mean_total_faculty = mean(total_faculty, na.rm = TRUE),
    sd_total_faculty = sd(total_faculty, na.rm = TRUE),
    mean_pct_urm_faculty = mean(frac_urm_faculty * 100, na.rm = TRUE),
    sd_pct_urm_faculty = sd(frac_urm_faculty * 100, na.rm = TRUE),
    mean_pct_women_faculty = mean(frac_women_faculty * 100, na.rm = TRUE),
    sd_pct_women_faculty = sd(frac_women_faculty * 100, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  arrange(discipline)

# Create department faculty table
cat("\n\\begin{table}[H]\n")
cat("\\caption{Department Faculty Demographics by Discipline}\n")
cat("\\label{tab:summary_disc_dept_faculty}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccccc}\n")
cat("\\toprule\n")
cat(" & & \\multicolumn{2}{c}{Faculty Size} & \\multicolumn{2}{c}{\\% URM Faculty} & \\multicolumn{2}{c}{\\% Women Faculty} \\\\\n")
cat("Discipline & N Depts & Mean & SD & Mean & SD & Mean & SD \\\\\n")
cat("\\midrule\n")
for (i in 1:nrow(dept_by_disc)) {
  cat(sprintf("%s & %d & %.1f & %.1f & %.2f & %.2f & %.2f & %.2f \\\\\n",
              dept_by_disc$discipline[i],
              dept_by_disc$n_departments[i],
              dept_by_disc$mean_total_faculty[i],
              dept_by_disc$sd_total_faculty[i],
              dept_by_disc$mean_pct_urm_faculty[i],
              dept_by_disc$sd_pct_urm_faculty[i],
              dept_by_disc$mean_pct_women_faculty[i],
              dept_by_disc$sd_pct_women_faculty[i]))
}
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\parbox{\\linewidth}{\\footnotesize Note: Department faculty demographics based on 2024 coding.}\n")
cat("\\end{table}\n")
```

## Summary Statistics by Semester

```{r summary-stats-semester}
# Fall semester statistics
fall_summary <- data %>%
  filter(has_fall_speakers == 1) %>%
  summarise(
    n = n(),
    mean_pct_urm = mean(fall_pct_urm, na.rm = TRUE),
    sd_pct_urm = sd(fall_pct_urm, na.rm = TRUE),
    mean_num_urm = mean(fall_num_urm, na.rm = TRUE),
    pct_has_urm = mean(fall_has_any_urm, na.rm = TRUE) * 100,
    mean_pct_black = mean(fall_pct_black, na.rm = TRUE),
    pct_has_black = mean(fall_has_any_black, na.rm = TRUE) * 100,
    mean_pct_hispanic = mean(fall_pct_hispanic, na.rm = TRUE),
    pct_has_hispanic = mean(fall_has_any_hispanic, na.rm = TRUE) * 100,
    mean_pct_female = mean(fall_pct_female, na.rm = TRUE),
    mean_num_female = mean(fall_num_female, na.rm = TRUE),
    pct_has_female = mean(fall_has_any_female, na.rm = TRUE) * 100,
    mean_total = mean(fall_total_speakers, na.rm = TRUE),
    sd_total = sd(fall_total_speakers, na.rm = TRUE) # Added SD for total speakers
  )

# Spring semester statistics
spring_summary <- data %>%
  filter(has_spring_speakers == 1) %>%
  summarise(
    n = n(),
    mean_pct_urm = mean(spring_pct_urm, na.rm = TRUE),
    sd_pct_urm = sd(spring_pct_urm, na.rm = TRUE),
    mean_num_urm = mean(spring_num_urm, na.rm = TRUE),
    pct_has_urm = mean(spring_has_any_urm, na.rm = TRUE) * 100,
    mean_pct_black = mean(spring_pct_black, na.rm = TRUE),
    pct_has_black = mean(spring_has_any_black, na.rm = TRUE) * 100,
    mean_pct_hispanic = mean(spring_pct_hispanic, na.rm = TRUE),
    pct_has_hispanic = mean(spring_has_any_hispanic, na.rm = TRUE) * 100,
    mean_pct_female = mean(spring_pct_female, na.rm = TRUE),
    mean_num_female = mean(spring_num_female, na.rm = TRUE),
    pct_has_female = mean(spring_has_any_female, na.rm = TRUE) * 100,
    mean_total = mean(spring_total_speakers, na.rm = TRUE),
    sd_total = sd(spring_total_speakers, na.rm = TRUE) # Added SD for total speakers
  )

# Create formatted table
cat("\n\\begin{table}[H]\n")
cat("\\caption{Summary Statistics by Semester}\n")
cat("\\label{tab:summary_semester}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccccc}\n")
cat("\\toprule\n")
cat(" & \\multicolumn{3}{c}{URM} & \\multicolumn{2}{c}{Black} & \\multicolumn{2}{c}{Hispanic} \\\\\n")
cat("Semester (N) & Mean \\% & Mean Count & Pct. Any & Mean \\% & Pct. Any & Mean \\% & Pct. Any \\\\\n")
cat("\\midrule\n")
cat(sprintf("Fall (%d) & %.2f & %.2f & %.1f & %.2f & %.1f & %.2f & %.1f \\\\\n",
            fall_summary$n,
            fall_summary$mean_pct_urm,
            fall_summary$mean_num_urm,
            fall_summary$pct_has_urm,
            fall_summary$mean_pct_black,
            fall_summary$pct_has_black,
            fall_summary$mean_pct_hispanic,
            fall_summary$pct_has_hispanic))
cat(sprintf("Spring (%d) & %.2f & %.2f & %.1f & %.2f & %.1f & %.2f & %.1f \\\\\n",
            spring_summary$n,
            spring_summary$mean_pct_urm,
            spring_summary$mean_num_urm,
            spring_summary$pct_has_urm,
            spring_summary$mean_pct_black,
            spring_summary$pct_has_black,
            spring_summary$mean_pct_hispanic,
            spring_summary$pct_has_hispanic))
cat("\\midrule\n")
cat(" & \\multicolumn{3}{c}{Female} & \\multicolumn{2}{c}{Total Speakers} & & \\\\\n")
cat("Semester & Mean \\% & Mean Count & Pct. Any & Mean & SD & & \\\\\n")
cat("\\midrule\n")
cat(sprintf("Fall & %.2f & %.2f & %.1f & %.2f & %.2f & & \\\\\n", # Added SD
            fall_summary$mean_pct_female,
            fall_summary$mean_num_female,
            fall_summary$pct_has_female,
            fall_summary$mean_total,
            fall_summary$sd_total)) # Added SD
cat(sprintf("Spring & %.2f & %.2f & %.1f & %.2f & %.2f & & \\\\\n", # Added SD
            spring_summary$mean_pct_female,
            spring_summary$mean_num_female,
            spring_summary$pct_has_female,
            spring_summary$mean_total,
            spring_summary$sd_total)) # Added SD
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\end{table}\n")

```

\newpage

# Main Effects Analysis

## Main Question 1: URM Speaker Representation

```{r mq1-urm}
# MQ1: URM percentage, count, and binary
# Model 1 - Basic controls
pct_urm_m1 <- run_regression(paste("pct_urm ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_urm_m1 <- run_regression(paste("num_urm ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_urm_m1 <- run_regression(paste("has_any_urm ~ treatment +", paste(base_controls, collapse = " + ")), data)

# Model 2 - Extended controls
pct_urm_m2 <- run_regression(paste("pct_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_urm_m2 <- run_regression(paste("num_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_urm_m2 <- run_regression(paste("has_any_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_urm_m1, analysis = "Main Effects", outcome = "% URM", model_type = "Simple"),
  list(model = pct_urm_m2, analysis = "Main Effects", outcome = "% URM", model_type = "Extended"),
  list(model = count_urm_m1, analysis = "Main Effects", outcome = "Count URM", model_type = "Simple"),
  list(model = count_urm_m2, analysis = "Main Effects", outcome = "Count URM", model_type = "Extended"),
  list(model = binary_urm_m1, analysis = "Main Effects", outcome = "Any URM", model_type = "Simple"),
  list(model = binary_urm_m2, analysis = "Main Effects", outcome = "Any URM", model_type = "Extended")
))

create_stargazer_table(
  list(pct_urm_m1, pct_urm_m2, count_urm_m1, count_urm_m2, binary_urm_m1, binary_urm_m2),
  c("\\\\% URM", "\\\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Main Question 1: Effect on URM Speaker Representation",
  "tab:mq1_urm",
  demographic_group = "URM"
)
```

\newpage

## Main Questions 2a-2c: Effects on Speaker Counts

```{r mq2-all}
# MQ2a: Total speakers
count_total_m1 <- run_regression(paste("total_speakers ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_total_m2 <- run_regression(paste("total_speakers ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# MQ2b: URM speakers (count)
# count_urm_m1 and count_urm_m2 are already defined in mq1-urm, re-using them.

# MQ2c: Non-URM speakers
count_non_urm_m1 <- run_regression(paste("num_non_urm ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_non_urm_m2 <- run_regression(paste("num_non_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = count_total_m1, analysis = "Main Effects", outcome = "Total Speakers", model_type = "Simple"),
  list(model = count_total_m2, analysis = "Main Effects", outcome = "Total Speakers", model_type = "Extended"),
  # URM count models already added in mq1-urm
  list(model = count_non_urm_m1, analysis = "Main Effects", outcome = "Count Non-URM", model_type = "Simple"),
  list(model = count_non_urm_m2, analysis = "Main Effects", outcome = "Count Non-URM", model_type = "Extended")
))

# Combined table
create_stargazer_table(
  list(count_total_m1, count_total_m2, count_urm_m1, count_urm_m2, count_non_urm_m1, count_non_urm_m2),
  c("Total", "Total", "URM", "URM", "Non-URM", "Non-URM"),
  "Main Questions 2a-2c: Effects on Speaker Counts",
  "tab:mq2_all",
  demographic_group = "Count" # This will set the column headers for % Count, Count Count, Any Count
)
```

## Seemingly Unrelated Regression (SUR) Analysis

```{r sur-analysis}
# SUR to test whether effects on URM and non-URM speakers are equal and opposite
# Per pre-registration: test if treatment increases URM at expense of non-URM

# Function to safely run SUR with error handling (Model 1 only)
run_sur_analysis <- function(data, base_controls) {
  
  tryCatch({
    # Prepare equations for SUR
    # Model 1 - Basic controls only
    eq1_m1 <- as.formula(paste("num_urm ~ treatment +", paste(base_controls, collapse = " + ")))
    eq2_m1 <- as.formula(paste("num_non_urm ~ treatment +", paste(base_controls, collapse = " + ")))
    
    # Run SUR model with control for method
    sur_m1 <- systemfit(list(URM = eq1_m1, NonURM = eq2_m1), 
                       method = "SUR", 
                       data = data,
                       control = systemfit.control(tol = 1e-5))
    
    # Test whether treatment effects are equal and opposite
    # H0: b1_URM + b1_NonURM = 0 (effects sum to zero)
    # H1: b1_URM + b1_NonURM ≠ 0
    
    test_m1 <- linearHypothesis(sur_m1, "URM_treatment + NonURM_treatment = 0")
    
    # Extract coefficients and SEs
    urm_coef_m1 <- coef(sur_m1$eq[[1]])["treatment"]
    urm_se_m1 <- sqrt(diag(vcov(sur_m1$eq[[1]]))["treatment"])
    non_urm_coef_m1 <- coef(sur_m1$eq[[2]])["treatment"]
    non_urm_se_m1 <- sqrt(diag(vcov(sur_m1$eq[[2]]))["treatment"])
    
    return(list(
      success = TRUE,
      urm_coef_m1 = urm_coef_m1, urm_se_m1 = urm_se_m1,
      non_urm_coef_m1 = non_urm_coef_m1, non_urm_se_m1 = non_urm_se_m1,
      test_m1 = test_m1
    ))
    
  }, error = function(e) {
    # If SUR fails, fall back to individual OLS estimates
    # These are already computed above as count_urm_m1, count_non_urm_m1
    
    # Extract coefficients from individual models
    urm_coef_m1 <- if(!is.null(count_urm_m1)) coef(count_urm_m1)["treatment"] else NA
    urm_se_m1 <- if(!is.null(count_urm_m1)) count_urm_m1$cluster_se["treatment"] else NA
    non_urm_coef_m1 <- if(!is.null(count_non_urm_m1)) coef(count_non_urm_m1)["treatment"] else NA
    non_urm_se_m1 <- if(!is.null(count_non_urm_m1)) count_non_urm_m1$cluster_se["treatment"] else NA
    
    return(list(
      success = FALSE,
      error_msg = e$message,
      urm_coef_m1 = urm_coef_m1, urm_se_m1 = urm_se_m1,
      non_urm_coef_m1 = non_urm_coef_m1, non_urm_se_m1 = non_urm_se_m1,
      test_m1 = NULL
    ))
  })
}

# Run the analysis
sur_results <- run_sur_analysis(data, base_controls)

# Create summary table
cat("\n\\begin{table}[H]\n")
cat("\\caption{SUR Analysis: Testing Substitution Between URM and Non-URM Speakers}\n")
cat("\\label{tab:sur_analysis}\n")
cat("\\centering\n")
cat("\\begin{tabular}{lcc}\n")
cat("\\toprule\n")
cat("Outcome & Coefficient & SE \\\\\n")
cat("\\midrule\n")

cat(sprintf("URM Speakers & %.4f & (%.4f) \\\\\n",
            sur_results$urm_coef_m1, sur_results$urm_se_m1))
cat(sprintf("Non-URM Speakers & %.4f & (%.4f) \\\\\n",
            sur_results$non_urm_coef_m1, sur_results$non_urm_se_m1))
cat("\\midrule\n")
cat(sprintf("Sum of Effects & %.4f & --- \\\\\n",
            sur_results$urm_coef_m1 + sur_results$non_urm_coef_m1))

if (sur_results$success && !is.null(sur_results$test_m1)) {
  cat("\\midrule\n")
  cat("\\multicolumn{3}{l}{\\textit{Wald Test: H0: Treatment effect on URM + Treatment effect on Non-URM = 0}} \\\\\n")
  cat(sprintf("Chi-squared & %.3f & \\\\\n", 
              sur_results$test_m1$Chisq[2]))
  cat(sprintf("p-value & %.4f & \\\\\n", 
              sur_results$test_m1$`Pr(>Chisq)`[2]))
} else {
  cat("\\midrule\n")
  cat("\\multicolumn{3}{l}{\\textit{Note: SUR estimation failed; showing OLS estimates with clustered SEs}} \\\\\n")
  # Can still test sum = 0 informally
  sum_m1 <- sur_results$urm_coef_m1 + sur_results$non_urm_coef_m1
  cat(sprintf("\\multicolumn{3}{l}{\\textit{Sum of effects: %.4f}} \\\\\n",
              sum_m1))
}

cat("\\bottomrule\n")
cat("\\end{tabular}\n")

if (sur_results$success) {
  cat("\\parbox{\\linewidth}{\\footnotesize Note: SUR estimation with simple controls allows for correlation between equation errors. The Wald test examines whether the treatment effect represents a pure substitution (increasing URM speakers while decreasing non-URM speakers by the same amount).}\n")
} else {
  cat("\\parbox{\\linewidth}{\\footnotesize Note: SUR estimation failed due to computational issues. Table shows OLS estimates with clustered standard errors. The sum of effects being close to zero suggests a substitution pattern even without formal SUR testing.}\n")
}
cat("\\end{table}\n")
```

\newpage

# Demographic Subgroup Analysis

## Black Speakers

```{r black-speakers}
# Black speakers
pct_black_m1 <- run_regression(paste("pct_black ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_black_m1 <- run_regression(paste("num_black ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_black_m1 <- run_regression(paste("has_any_black ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_black_m2 <- run_regression(paste("pct_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_black_m2 <- run_regression(paste("num_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_black_m2 <- run_regression(paste("has_any_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_black_m1, analysis = "Demographic Subgroup", outcome = "% Black", model_type = "Simple"),
  list(model = pct_black_m2, analysis = "Demographic Subgroup", outcome = "% Black", model_type = "Extended"),
  list(model = count_black_m1, analysis = "Demographic Subgroup", outcome = "Count Black", model_type = "Simple"),
  list(model = count_black_m2, analysis = "Demographic Subgroup", outcome = "Count Black", model_type = "Extended"),
  list(model = binary_black_m1, analysis = "Demographic Subgroup", outcome = "Any Black", model_type = "Simple"),
  list(model = binary_black_m2, analysis = "Demographic Subgroup", outcome = "Any Black", model_type = "Extended")
))

create_stargazer_table(
  list(pct_black_m1, pct_black_m2, count_black_m1, count_black_m2, binary_black_m1, binary_black_m2),
  c("\\\\% Black", "\\\\% Black", "Count Black", "Count Black", "Any Black", "Any Black"),
  "Effect on Black Speakers",
  "tab:black",
  demographic_group = "Black"
)
```

## Hispanic Speakers

```{r hispanic-speakers}
# Hispanic speakers
pct_hispanic_m1 <- run_regression(paste("pct_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_hispanic_m1 <- run_regression(paste("num_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_hispanic_m1 <- run_regression(paste("has_any_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_hispanic_m2 <- run_regression(paste("pct_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_hispanic_m2 <- run_regression(paste("num_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_hispanic_m2 <- run_regression(paste("has_any_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_hispanic_m1, analysis = "Demographic Subgroup", outcome = "% Hispanic", model_type = "Simple"),
  list(model = pct_hispanic_m2, analysis = "Demographic Subgroup", outcome = "% Hispanic", model_type = "Extended"),
  list(model = count_hispanic_m1, analysis = "Demographic Subgroup", outcome = "Count Hispanic", model_type = "Simple"),
  list(model = count_hispanic_m2, analysis = "Demographic Subgroup", outcome = "Count Hispanic", model_type = "Extended"),
  list(model = binary_hispanic_m1, analysis = "Demographic Subgroup", outcome = "Any Hispanic", model_type = "Simple"),
  list(model = binary_hispanic_m2, analysis = "Demographic Subgroup", outcome = "Any Hispanic", model_type = "Extended")
))

create_stargazer_table(
  list(pct_hispanic_m1, pct_hispanic_m2, count_hispanic_m1, count_hispanic_m2, binary_hispanic_m1, binary_hispanic_m2),
  c("\\\\% Hispanic", "\\\\% Hispanic", "Count Hispanic", "Count Hispanic", "Any Hispanic", "Any Hispanic"),
  "Effect on Hispanic Speakers",
  "tab:hispanic",
  demographic_group = "Hispanic"
)
```

## Female Speakers

```{r female-speakers}
# Female speakers
pct_female_m1 <- run_regression(paste("pct_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_female_m1 <- run_regression(paste("num_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_female_m1 <- run_regression(paste("has_any_female ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_female_m2 <- run_regression(paste("pct_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_female_m2 <- run_regression(paste("num_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_female_m2 <- run_regression(paste("has_any_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_female_m1, analysis = "Demographic Subgroup", outcome = "% Female", model_type = "Simple"),
  list(model = pct_female_m2, analysis = "Demographic Subgroup", outcome = "% Female", model_type = "Extended"),
  list(model = count_female_m1, analysis = "Demographic Subgroup", outcome = "Count Female", model_type = "Simple"),
  list(model = count_female_m2, analysis = "Demographic Subgroup", outcome = "Count Female", model_type = "Extended"),
  list(model = binary_female_m1, analysis = "Demographic Subgroup", outcome = "Any Female", model_type = "Simple"),
  list(model = binary_female_m2, analysis = "Demographic Subgroup", outcome = "Any Female", model_type = "Extended")
))

create_stargazer_table(
  list(pct_female_m1, pct_female_m2, count_female_m1, count_female_m2, binary_female_m1, binary_female_m2),
  c("\\\\% Female", "\\\\% Female", "Count Female", "Count Female", "Any Female", "Any Female"),
  "Effect on Female Speakers",
  "tab:female",
  demographic_group = "Female"
)
```

## URM Female

```{r urm-female}
# URM-Female intersection
pct_urm_female_m1 <- run_regression(paste("pct_urm_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_urm_female_m1 <- run_regression(paste("approx_num_urm_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_urm_female_m1 <- run_regression(paste("has_any_urm_female ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_urm_female_m2 <- run_regression(paste("pct_urm_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_urm_female_m2 <- run_regression(paste("approx_num_urm_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_urm_female_m2 <- run_regression(paste("has_any_urm_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_urm_female_m1, analysis = "Demographic Subgroup", outcome = "% URM Female", model_type = "Simple"),
  list(model = pct_urm_female_m2, analysis = "Demographic Subgroup", outcome = "% URM Female", model_type = "Extended"),
  list(model = count_urm_female_m1, analysis = "Demographic Subgroup", outcome = "Count URM Female", model_type = "Simple"),
  list(model = count_urm_female_m2, analysis = "Demographic Subgroup", outcome = "Count URM Female", model_type = "Extended"),
  list(model = binary_urm_female_m1, analysis = "Demographic Subgroup", outcome = "Any URM Female", model_type = "Simple"),
  list(model = binary_urm_female_m2, analysis = "Demographic Subgroup", outcome = "Any URM Female", model_type = "Extended")
))

create_stargazer_table(
  list(pct_urm_female_m1, pct_urm_female_m2, count_urm_female_m1, count_urm_female_m2, binary_urm_female_m1, binary_urm_female_m2),
  c("\\\\% URM Female", "\\\\% URM Female", "Count URM Female", "Count URM Female", "Any URM Female", "Any URM Female"),
  "Effect on URM Female Speakers",
  "tab:urm_female",
  demographic_group = "URM Female"
)
```

## Black Female

```{r black-female}
# Black-Female intersection
pct_black_female_m1 <- run_regression(paste("pct_black_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_black_female_m1 <- run_regression(paste("approx_num_black_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_black_female_m1 <- run_regression(paste("has_any_black_female ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_black_female_m2 <- run_regression(paste("pct_black_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_black_female_m2 <- run_regression(paste("approx_num_black_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_black_female_m2 <- run_regression(paste("has_any_black_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_black_female_m1, analysis = "Demographic Subgroup", outcome = "% Black Female", model_type = "Simple"),
  list(model = pct_black_female_m2, analysis = "Demographic Subgroup", outcome = "% Black Female", model_type = "Extended"),
  list(model = count_black_female_m1, analysis = "Demographic Subgroup", outcome = "Count Black Female", model_type = "Simple"),
  list(model = count_black_female_m2, analysis = "Demographic Subgroup", outcome = "Count Black Female", model_type = "Extended"),
  list(model = binary_black_female_m1, analysis = "Demographic Subgroup", outcome = "Any Black Female", model_type = "Simple"),
  list(model = binary_black_female_m2, analysis = "Demographic Subgroup", outcome = "Any Black Female", model_type = "Extended")
))

create_stargazer_table(
  list(pct_black_female_m1, pct_black_female_m2, count_black_female_m1, count_black_female_m2, binary_black_female_m1, binary_black_female_m2),
  c("\\\\% Black Female", "\\\\% Black Female", "Count Black Female", "Count Black Female", "Any Black Female", "Any Black Female"),
  "Effect on Black Female Speakers",
  "tab:black_female",
  demographic_group = "Black Female"
)
```

## Black Male

```{r black-male}
# Black-Male intersection
pct_black_male_m1 <- run_regression(paste("pct_black_male ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_black_male_m1 <- run_regression(paste("approx_num_black_male ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_black_male_m1 <- run_regression(paste("has_any_black_male ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_black_male_m2 <- run_regression(paste("pct_black_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_black_male_m2 <- run_regression(paste("approx_num_black_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_black_male_m2 <- run_regression(paste("has_any_black_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_black_male_m1, analysis = "Demographic Subgroup", outcome = "% Black Male", model_type = "Simple"),
  list(model = pct_black_male_m2, analysis = "Demographic Subgroup", outcome = "% Black Male", model_type = "Extended"),
  list(model = count_black_male_m1, analysis = "Demographic Subgroup", outcome = "Count Black Male", model_type = "Simple"),
  list(model = count_black_male_m2, analysis = "Demographic Subgroup", outcome = "Count Black Male", model_type = "Extended"),
  list(model = binary_black_male_m1, analysis = "Demographic Subgroup", outcome = "Any Black Male", model_type = "Simple"),
  list(model = binary_black_male_m2, analysis = "Demographic Subgroup", outcome = "Any Black Male", model_type = "Extended")
))

create_stargazer_table(
  list(pct_black_male_m1, pct_black_male_m2, count_black_male_m1, count_black_male_m2, binary_black_male_m1, binary_black_male_m2),
  c("\\\\% Black Male", "\\\\% Black Male", "Count Black Male", "Count Black Male", "Any Black Male", "Any Black Male"),
  "Effect on Black Male Speakers",
  "tab:black_male",
  demographic_group = "Black Male"
)
```

## Hispanic Female

```{r hispanic-female}
# Hispanic-Female intersection
pct_hispanic_female_m1 <- run_regression(paste("pct_hispanic_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_hispanic_female_m1 <- run_regression(paste("approx_num_hispanic_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_hispanic_female_m1 <- run_regression(paste("has_any_hispanic_female ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_hispanic_female_m2 <- run_regression(paste("pct_hispanic_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_hispanic_female_m2 <- run_regression(paste("approx_num_hispanic_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_hispanic_female_m2 <- run_regression(paste("has_any_hispanic_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_hispanic_female_m1, analysis = "Demographic Subgroup", outcome = "% Hispanic Female", model_type = "Simple"),
  list(model = pct_hispanic_female_m2, analysis = "Demographic Subgroup", outcome = "% Hispanic Female", model_type = "Extended"),
  list(model = count_hispanic_female_m1, analysis = "Demographic Subgroup", outcome = "Count Hispanic Female", model_type = "Simple"),
  list(model = count_hispanic_female_m2, analysis = "Demographic Subgroup", outcome = "Count Hispanic Female", model_type = "Extended"),
  list(model = binary_hispanic_female_m1, analysis = "Demographic Subgroup", outcome = "Any Hispanic Female", model_type = "Simple"),
  list(model = binary_hispanic_female_m2, analysis = "Demographic Subgroup", outcome = "Any Hispanic Female", model_type = "Extended")
))

create_stargazer_table(
  list(pct_hispanic_female_m1, pct_hispanic_female_m2, count_hispanic_female_m1, count_hispanic_female_m2, binary_hispanic_female_m1, binary_hispanic_female_m2),
  c("\\\\% Hispanic Female", "\\\\% Hispanic Female", "Count Hispanic Female", "Count Hispanic Female", "Any Hispanic Female", "Any Hispanic Female"),
  "Effect on Hispanic Female Speakers",
  "tab:hispanic_female",
  demographic_group = "Hispanic Female"
)
```

## Hispanic Male

```{r hispanic-male}
# Hispanic-Male intersection
pct_hispanic_male_m1 <- run_regression(paste("pct_hispanic_male ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_hispanic_male_m1 <- run_regression(paste("approx_num_hispanic_male ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_hispanic_male_m1 <- run_regression(paste("has_any_hispanic_male ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_hispanic_male_m2 <- run_regression(paste("pct_hispanic_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_hispanic_male_m2 <- run_regression(paste("approx_num_hispanic_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_hispanic_male_m2 <- run_regression(paste("has_any_hispanic_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_hispanic_male_m1, analysis = "Demographic Subgroup", outcome = "% Hispanic Male", model_type = "Simple"),
  list(model = pct_hispanic_male_m2, analysis = "Demographic Subgroup", outcome = "% Hispanic Male", model_type = "Extended"),
  list(model = count_hispanic_male_m1, analysis = "Demographic Subgroup", outcome = "Count Hispanic Male", model_type = "Simple"),
  list(model = count_hispanic_male_m2, analysis = "Demographic Subgroup", outcome = "Count Hispanic Male", model_type = "Extended"),
  list(model = binary_hispanic_male_m1, analysis = "Demographic Subgroup", outcome = "Any Hispanic Male", model_type = "Simple"),
  list(model = binary_hispanic_male_m2, analysis = "Demographic Subgroup", outcome = "Any Hispanic Male", model_type = "Extended")
))

create_stargazer_table(
  list(pct_hispanic_male_m1, pct_hispanic_male_m2, count_hispanic_male_m1, count_hispanic_male_m2, binary_hispanic_male_m1, binary_hispanic_male_m2),
  c("\\\\% Hispanic Male", "\\\\% Hispanic Male", "Count Hispanic Male", "Count Hispanic Male", "Any Hispanic Male", "Any Hispanic Male"),
  "Effect on Hispanic Male Speakers",
  "tab:hispanic_male",
  demographic_group = "Hispanic Male"
)
```

\newpage

# Discipline Subgroup Analysis

```{r discipline-subgroup}
# Run main treatment effect models separately for each discipline
disciplines <- list(
  list("Chemistry", data %>% filter(disc_mathematics == 0 & disc_physics == 0 & 
                                    disc_computer_science == 0 & disc_mechanical_engineering == 0)),
  list("Mathematics", data %>% filter(disc_mathematics == 1)),
  list("Physics", data %>% filter(disc_physics == 1)),
  list("Computer Science", data %>% filter(disc_computer_science == 1)),
  list("Mechanical Engineering", data %>% filter(disc_mechanical_engineering == 1))
)

# Store results for each discipline
discipline_results <- list()

for (disc_info in disciplines) {
  disc_name <- disc_info[[1]]
  disc_data <- disc_info[[2]]
  
  cat("\n\\subsubsection{", disc_name, " (N=", nrow(disc_data), ")}\n\n", sep="") # Changed to subsubsection
  
  # Run models for this discipline
  if (nrow(disc_data) >= 30) {
    # Percentage models
    pct_m1 <- run_regression(paste("pct_urm ~ treatment +", paste(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  collapse = " + ")), disc_data)
    pct_m2 <- run_regression(paste("pct_urm ~ treatment +", paste(c(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  extended_controls), collapse = " + ")), disc_data)
    
    # Count models
    count_m1 <- run_regression(paste("num_urm ~ treatment +", paste(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    collapse = " + ")), disc_data)
    count_m2 <- run_regression(paste("num_urm ~ treatment +", paste(c(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    extended_controls), collapse = " + ")), disc_data)
    
    # Binary models
    binary_m1 <- run_regression(paste("has_any_urm ~ treatment +", paste(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     collapse = " + ")), disc_data)
    binary_m2 <- run_regression(paste("has_any_urm ~ treatment +", paste(c(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     extended_controls), collapse = " + ")), disc_data)
    
    # Create table for this discipline - URM
    create_stargazer_table(
      list(pct_m1, pct_m2, count_m1, count_m2, binary_m1, binary_m2),
      c("\\\\% URM", "\\\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
      paste(disc_name, ": Effect on URM Speaker Representation"),
      paste0("tab:discipline_", tolower(gsub(" ", "_", disc_name)), "_urm"),
      demographic_group = "URM"
    )
    
    # Store results
    discipline_results[[disc_name]] <- list(
      pct_m1 = pct_m1, pct_m2 = pct_m2,
      count_m1 = count_m1, count_m2 = count_m2,
      binary_m1 = binary_m1, binary_m2 = binary_m2
    )
    
    # Add to models list for significant results extraction
    all_models_list <- append(all_models_list, list(
      list(model = pct_m1, analysis = disc_name, outcome = "% URM", model_type = "Simple"),
      list(model = pct_m2, analysis = disc_name, outcome = "% URM", model_type = "Extended"),
      list(model = count_m1, analysis = disc_name, outcome = "Count URM", model_type = "Simple"),
      list(model = count_m2, analysis = disc_name, outcome = "Count URM", model_type = "Extended"),
      list(model = binary_m1, analysis = disc_name, outcome = "Any URM", model_type = "Simple"),
      list(model = binary_m2, analysis = disc_name, outcome = "Any URM", model_type = "Extended")
    ))
    
    # Black Analysis for this discipline
    pct_black_m1 <- run_regression(paste("pct_black ~ treatment +", paste(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  collapse = " + ")), disc_data)
    pct_black_m2 <- run_regression(paste("pct_black ~ treatment +", paste(c(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  extended_controls), collapse = " + ")), disc_data)
    
    count_black_m1 <- run_regression(paste("num_black ~ treatment +", paste(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    collapse = " + ")), disc_data)
    count_black_m2 <- run_regression(paste("num_black ~ treatment +", paste(c(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    extended_controls), collapse = " + ")), disc_data)
    
    binary_black_m1 <- run_regression(paste("has_any_black ~ treatment +", paste(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     collapse = " + ")), disc_data)
    binary_black_m2 <- run_regression(paste("has_any_black ~ treatment +", paste(c(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     extended_controls), collapse = " + ")), disc_data)
    
    # Create table for Black speakers
    create_stargazer_table(
      list(pct_black_m1, pct_black_m2, count_black_m1, count_black_m2, binary_black_m1, binary_black_m2),
      c("\\\\% Black", "\\\\% Black", "Count Black", "Count Black", "Any Black", "Any Black"),
      paste(disc_name, ": Effect on Black Speaker Representation"),
      paste0("tab:discipline_", tolower(gsub(" ", "_", disc_name)), "_black"),
      demographic_group = "Black"
    )
    
    # Add Black models to models list
    all_models_list <- append(all_models_list, list(
      list(model = pct_black_m1, analysis = disc_name, outcome = "% Black", model_type = "Simple"),
      list(model = pct_black_m2, analysis = disc_name, outcome = "% Black", model_type = "Extended"),
      list(model = count_black_m1, analysis = disc_name, outcome = "Count Black", model_type = "Simple"),
      list(model = count_black_m2, analysis = disc_name, outcome = "Count Black", model_type = "Extended"),
      list(model = binary_black_m1, analysis = disc_name, outcome = "Any Black", model_type = "Simple"),
      list(model = binary_black_m2, analysis = disc_name, outcome = "Any Black", model_type = "Extended")
    ))
    
    # Hispanic Analysis for this discipline
    pct_hispanic_m1 <- run_regression(paste("pct_hispanic ~ treatment +", paste(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  collapse = " + ")), disc_data)
    pct_hispanic_m2 <- run_regression(paste("pct_hispanic ~ treatment +", paste(c(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  extended_controls), collapse = " + ")), disc_data)
    
    count_hispanic_m1 <- run_regression(paste("num_hispanic ~ treatment +", paste(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    collapse = " + ")), disc_data)
    count_hispanic_m2 <- run_regression(paste("num_hispanic ~ treatment +", paste(c(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    extended_controls), collapse = " + ")), disc_data)
    
    binary_hispanic_m1 <- run_regression(paste("has_any_hispanic ~ treatment +", paste(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     collapse = " + ")), disc_data)
    binary_hispanic_m2 <- run_regression(paste("has_any_hispanic ~ treatment +", paste(c(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     extended_controls), collapse = " + ")), disc_data)
    
    # Create table for Hispanic speakers
    create_stargazer_table(
      list(pct_hispanic_m1, pct_hispanic_m2, count_hispanic_m1, count_hispanic_m2, binary_hispanic_m1, binary_hispanic_m2),
      c("\\\\% Hispanic", "\\\\% Hispanic", "Count Hispanic", "Count Hispanic", "Any Hispanic", "Any Hispanic"),
      paste(disc_name, ": Effect on Hispanic Speaker Representation"),
      paste0("tab:discipline_", tolower(gsub(" ", "_", disc_name)), "_hispanic"),
      demographic_group = "Hispanic"
    )
    
    # Add Hispanic models to models list
    all_models_list <- append(all_models_list, list(
      list(model = pct_hispanic_m1, analysis = disc_name, outcome = "% Hispanic", model_type = "Simple"),
      list(model = pct_hispanic_m2, analysis = disc_name, outcome = "% Hispanic", model_type = "Extended"),
      list(model = count_hispanic_m1, analysis = disc_name, outcome = "Count Hispanic", model_type = "Simple"),
      list(model = count_hispanic_m2, analysis = disc_name, outcome = "Count Hispanic", model_type = "Extended"),
      list(model = binary_hispanic_m1, analysis = disc_name, outcome = "Any Hispanic", model_type = "Simple"),
      list(model = binary_hispanic_m2, analysis = disc_name, outcome = "Any Hispanic", model_type = "Extended")
    ))
  } else {
    cat("Insufficient observations for regression analysis in", disc_name, "\n\n")
  }
}
```

## Testing for Significant Moderation Across Disciplines

```{r discipline-moderation-test}
# Test whether treatment effects vary significantly across disciplines
# This F-test examines the joint significance of treatment × discipline interactions

# Run full model with treatment × discipline interactions
# Using the same controls as in the main analysis but with interaction terms
# Note: We exclude discipline dummies from base_controls to avoid redundancy
base_controls_no_disc <- setdiff(base_controls, c("disc_mathematics", "disc_physics", 
                                                   "disc_computer_science", "disc_mechanical_engineering"))

full_model_black <- lm(paste("has_any_black ~ treatment * (disc_mathematics + disc_physics + 
                             disc_computer_science + disc_mechanical_engineering) +", 
                             paste(c(base_controls_no_disc, extended_controls), collapse = " + ")), 
                       data = data)

# Run restricted model without interactions (but keeping main effects)
restricted_model_black <- lm(paste("has_any_black ~ treatment + disc_mathematics + disc_physics + 
                                   disc_computer_science + disc_mechanical_engineering +",
                                   paste(c(base_controls_no_disc, extended_controls), collapse = " + ")), 
                            data = data)

# F-test for joint significance of interactions
f_test_black <- anova(restricted_model_black, full_model_black)

cat("\\textbf{F-test for Treatment × Discipline Interactions (Black Speakers):}\n")
cat("F-statistic:", round(f_test_black$F[2], 3), "\n")
cat("p-value:", round(f_test_black$`Pr(>F)`[2], 4), "\n")
cat("Degrees of freedom:", f_test_black$Df[2], "\n\n")

# Interpretation
if (f_test_black$`Pr(>F)`[2] < 0.05) {
  cat("The treatment effect on Black speaker representation varies significantly across disciplines (p < 0.05).\n")
  cat("This indicates that the diversity intervention has heterogeneous effects depending on the academic field.\n")
} else {
  cat("We cannot reject the null hypothesis that treatment effects are equal across disciplines.\n")
  cat("The variation in treatment effects across fields may be due to random chance.\n")
}

# Also test for URM speakers
full_model_urm <- lm(paste("pct_urm ~ treatment * (disc_mathematics + disc_physics + 
                           disc_computer_science + disc_mechanical_engineering) +", 
                           paste(c(base_controls_no_disc, extended_controls), collapse = " + ")), 
                     data = data)

restricted_model_urm <- lm(paste("pct_urm ~ treatment + disc_mathematics + disc_physics + 
                                 disc_computer_science + disc_mechanical_engineering +",
                                 paste(c(base_controls_no_disc, extended_controls), collapse = " + ")), 
                          data = data)

f_test_urm <- anova(restricted_model_urm, full_model_urm)

cat("\n\\textbf{F-test for Treatment × Discipline Interactions (URM Speakers):}\n")
cat("F-statistic:", round(f_test_urm$F[2], 3), "\n")
cat("p-value:", round(f_test_urm$`Pr(>F)`[2], 4), "\n")
cat("Degrees of freedom:", f_test_urm$Df[2], "\n\n")

# Store the interaction effects for reporting
interaction_effects_black <- summary(full_model_black)$coefficients[
  grep("treatment:disc", rownames(summary(full_model_black)$coefficients)), ]

cat("\\textbf{Individual Interaction Effects (Black Speakers):}\n")
print(round(interaction_effects_black, 4))
```

\newpage

# Semester-Specific Analysis

## Fall Semester

```{r fall-semester}
# Fall semester analysis
data_fall <- data %>% filter(has_fall_speakers == 1)

pct_fall_urm_m1 <- run_regression(paste("fall_pct_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
count_fall_urm_m1 <- run_regression(paste("fall_num_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
binary_fall_urm_m1 <- run_regression(paste("fall_has_any_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
summary(pct_fall_urm_m1)

pct_fall_urm_m2 <- run_regression(paste("fall_pct_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
count_fall_urm_m2 <- run_regression(paste("fall_num_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
binary_fall_urm_m2 <- run_regression(paste("fall_has_any_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_fall_urm_m1, analysis = "Fall Semester", outcome = "% URM", model_type = "Simple"),
  list(model = pct_fall_urm_m2, analysis = "Fall Semester", outcome = "% URM", model_type = "Extended"),
  list(model = count_fall_urm_m1, analysis = "Fall Semester", outcome = "Count URM", model_type = "Simple"),
  list(model = count_fall_urm_m2, analysis = "Fall Semester", outcome = "Count URM", model_type = "Extended"),
  list(model = binary_fall_urm_m1, analysis = "Fall Semester", outcome = "Any URM", model_type = "Simple"),
  list(model = binary_fall_urm_m2, analysis = "Fall Semester", outcome = "Any URM", model_type = "Extended")
))

create_stargazer_table(
  list(pct_fall_urm_m1, pct_fall_urm_m2, count_fall_urm_m1, count_fall_urm_m2, binary_fall_urm_m1, binary_fall_urm_m2),
  c("\\\\% URM", "\\\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Fall: Effect on URM Speakers",
  "tab:fall_urm",
  demographic_group = "URM"
)

# Black Analysis
pct_fall_black_m1 <- run_regression(paste("fall_pct_black ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
count_fall_black_m1 <- run_regression(paste("fall_num_black ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
binary_fall_black_m1 <- run_regression(paste("fall_has_any_black ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)

pct_fall_black_m2 <- run_regression(paste("fall_pct_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
count_fall_black_m2 <- run_regression(paste("fall_num_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
binary_fall_black_m2 <- run_regression(paste("fall_has_any_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_fall_black_m1, analysis = "Fall Semester", outcome = "% Black", model_type = "Simple"),
  list(model = pct_fall_black_m2, analysis = "Fall Semester", outcome = "% Black", model_type = "Extended"),
  list(model = count_fall_black_m1, analysis = "Fall Semester", outcome = "Count Black", model_type = "Simple"),
  list(model = count_fall_black_m2, analysis = "Fall Semester", outcome = "Count Black", model_type = "Extended"),
  list(model = binary_fall_black_m1, analysis = "Fall Semester", outcome = "Any Black", model_type = "Simple"),
  list(model = binary_fall_black_m2, analysis = "Fall Semester", outcome = "Any Black", model_type = "Extended")
))

create_stargazer_table(
  list(pct_fall_black_m1, pct_fall_black_m2, count_fall_black_m1, count_fall_black_m2, binary_fall_black_m1, binary_fall_black_m2),
  c("\\\\% Black", "\\\\% Black", "Count Black", "Count Black", "Any Black", "Any Black"),
  "Fall: Effect on Black Speakers",
  "tab:fall_black",
  demographic_group = "Black"
)

# Hispanic Analysis
pct_fall_hispanic_m1 <- run_regression(paste("fall_pct_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
count_fall_hispanic_m1 <- run_regression(paste("fall_num_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
binary_fall_hispanic_m1 <- run_regression(paste("fall_has_any_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)

pct_fall_hispanic_m2 <- run_regression(paste("fall_pct_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
count_fall_hispanic_m2 <- run_regression(paste("fall_num_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
binary_fall_hispanic_m2 <- run_regression(paste("fall_has_any_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_fall_hispanic_m1, analysis = "Fall Semester", outcome = "% Hispanic", model_type = "Simple"),
  list(model = pct_fall_hispanic_m2, analysis = "Fall Semester", outcome = "% Hispanic", model_type = "Extended"),
  list(model = count_fall_hispanic_m1, analysis = "Fall Semester", outcome = "Count Hispanic", model_type = "Simple"),
  list(model = count_fall_hispanic_m2, analysis = "Fall Semester", outcome = "Count Hispanic", model_type = "Extended"),
  list(model = binary_fall_hispanic_m1, analysis = "Fall Semester", outcome = "Any Hispanic", model_type = "Simple"),
  list(model = binary_fall_hispanic_m2, analysis = "Fall Semester", outcome = "Any Hispanic", model_type = "Extended")
))

create_stargazer_table(
  list(pct_fall_hispanic_m1, pct_fall_hispanic_m2, count_fall_hispanic_m1, count_fall_hispanic_m2, binary_fall_hispanic_m1, binary_fall_hispanic_m2),
  c("\\\\% Hispanic", "\\\\% Hispanic", "Count Hispanic", "Count Hispanic", "Any Hispanic", "Any Hispanic"),
  "Fall: Effect on Hispanic Speakers",
  "tab:fall_hispanic",
  demographic_group = "Hispanic"
)
```

## Spring Semester

```{r spring-semester}
# Spring semester analysis
data_spring <- data %>% filter(has_spring_speakers == 1)

pct_spring_urm_m1 <- run_regression(paste("spring_pct_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
count_spring_urm_m1 <- run_regression(paste("spring_num_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
binary_spring_urm_m1 <- run_regression(paste("spring_has_any_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)

pct_spring_urm_m2 <- run_regression(paste("spring_pct_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
count_spring_urm_m2 <- run_regression(paste("spring_num_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
binary_spring_urm_m2 <- run_regression(paste("spring_has_any_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_spring_urm_m1, analysis = "Spring Semester", outcome = "% URM", model_type = "Simple"),
  list(model = pct_spring_urm_m2, analysis = "Spring Semester", outcome = "% URM", model_type = "Extended"),
  list(model = count_spring_urm_m1, analysis = "Spring Semester", outcome = "Count URM", model_type = "Simple"),
  list(model = count_spring_urm_m2, analysis = "Spring Semester", outcome = "Count URM", model_type = "Extended"),
  list(model = binary_spring_urm_m1, analysis = "Spring Semester", outcome = "Any URM", model_type = "Simple"),
  list(model = binary_spring_urm_m2, analysis = "Spring Semester", outcome = "Any URM", model_type = "Extended")
))

create_stargazer_table(
  list(pct_spring_urm_m1, pct_spring_urm_m2, count_spring_urm_m1, count_spring_urm_m2, binary_spring_urm_m1, binary_spring_urm_m2),
  c("\\\\% URM", "\\\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Spring: Effect on URM Speakers",
  "tab:spring_urm",
  demographic_group = "URM"
)

# Black Analysis
pct_spring_black_m1 <- run_regression(paste("spring_pct_black ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
count_spring_black_m1 <- run_regression(paste("spring_num_black ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
binary_spring_black_m1 <- run_regression(paste("spring_has_any_black ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)

pct_spring_black_m2 <- run_regression(paste("spring_pct_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
count_spring_black_m2 <- run_regression(paste("spring_num_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
binary_spring_black_m2 <- run_regression(paste("spring_has_any_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_spring_black_m1, analysis = "Spring Semester", outcome = "% Black", model_type = "Simple"),
  list(model = pct_spring_black_m2, analysis = "Spring Semester", outcome = "% Black", model_type = "Extended"),
  list(model = count_spring_black_m1, analysis = "Spring Semester", outcome = "Count Black", model_type = "Simple"),
  list(model = count_spring_black_m2, analysis = "Spring Semester", outcome = "Count Black", model_type = "Extended"),
  list(model = binary_spring_black_m1, analysis = "Spring Semester", outcome = "Any Black", model_type = "Simple"),
  list(model = binary_spring_black_m2, analysis = "Spring Semester", outcome = "Any Black", model_type = "Extended")
))

create_stargazer_table(
  list(pct_spring_black_m1, pct_spring_black_m2, count_spring_black_m1, count_spring_black_m2, binary_spring_black_m1, binary_spring_black_m2),
  c("\\\\% Black", "\\\\% Black", "Count Black", "Count Black", "Any Black", "Any Black"),
  "Spring: Effect on Black Speakers",
  "tab:spring_black",
  demographic_group = "Black"
)

# Hispanic Analysis
pct_spring_hispanic_m1 <- run_regression(paste("spring_pct_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
count_spring_hispanic_m1 <- run_regression(paste("spring_num_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
binary_spring_hispanic_m1 <- run_regression(paste("spring_has_any_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)

pct_spring_hispanic_m2 <- run_regression(paste("spring_pct_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
count_spring_hispanic_m2 <- run_regression(paste("spring_num_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
binary_spring_hispanic_m2 <- run_regression(paste("spring_has_any_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_spring_hispanic_m1, analysis = "Spring Semester", outcome = "% Hispanic", model_type = "Simple"),
  list(model = pct_spring_hispanic_m2, analysis = "Spring Semester", outcome = "% Hispanic", model_type = "Extended"),
  list(model = count_spring_hispanic_m1, analysis = "Spring Semester", outcome = "Count Hispanic", model_type = "Simple"),
  list(model = count_spring_hispanic_m2, analysis = "Spring Semester", outcome = "Count Hispanic", model_type = "Extended"),
  list(model = binary_spring_hispanic_m1, analysis = "Spring Semester", outcome = "Any Hispanic", model_type = "Simple"),
  list(model = binary_spring_hispanic_m2, analysis = "Spring Semester", outcome = "Any Hispanic", model_type = "Extended")
))

create_stargazer_table(
  list(pct_spring_hispanic_m1, pct_spring_hispanic_m2, count_spring_hispanic_m1, count_spring_hispanic_m2, binary_spring_hispanic_m1, binary_spring_hispanic_m2),
  c("\\\\% Hispanic", "\\\\% Hispanic", "Count Hispanic", "Count Hispanic", "Any Hispanic", "Any Hispanic"),
  "Spring: Effect on Hispanic Speakers",
  "tab:spring_hispanic",
  demographic_group = "Hispanic"
)
```

\newpage

# Heterogeneity Analysis

## Moderation by Department Ranking

```{r mod-ranking}
# Create centered moderator
data$moderator <- data$dept_ranking - mean(data$dept_ranking, na.rm = TRUE)
data_mod <- data %>% filter(!is.na(moderator))

# cat(paste0("Department ranking moderation analysis (n = ", nrow(data_mod), ")\n\n"))

# Run moderation models
pct_mod_m1 <- run_regression(paste("pct_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
count_mod_m1 <- run_regression(paste("num_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
binary_mod_m1 <- run_regression(paste("has_any_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)

pct_mod_m2 <- run_regression(paste("pct_urm ~ treatment * moderator +", 
                                  paste(setdiff(c(base_controls, extended_controls), c("dept_ranking", "missing_dept_rank")), 
                                        collapse = " + ")), data_mod)
count_mod_m2 <- run_regression(paste("num_urm ~ treatment * moderator +", 
                                    paste(setdiff(c(base_controls, extended_controls), c("dept_ranking", "missing_dept_rank")), 
                                          collapse = " + ")), data_mod)
binary_mod_m2 <- run_regression(paste("has_any_urm ~ treatment * moderator +", 
                                     paste(setdiff(c(base_controls, extended_controls), c("dept_ranking", "missing_dept_rank")), 
                                           collapse = " + ")), data_mod)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_mod_m1, analysis = "Department Rank", outcome = "% URM", model_type = "Simple",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Dept Ranking (centered)", "Treatment $\\times$ Dept Ranking", "Constant")),
  list(model = pct_mod_m2, analysis = "Department Rank", outcome = "% URM", model_type = "Extended",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Dept Ranking (centered)", "Treatment $\\times$ Dept Ranking", "Constant")),
  list(model = count_mod_m1, analysis = "Department Rank", outcome = "Count URM", model_type = "Simple",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Dept Ranking (centered)", "Treatment $\\times$ Dept Ranking", "Constant")),
  list(model = count_mod_m2, analysis = "Department Rank", outcome = "Count URM", model_type = "Extended",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Dept Ranking (centered)", "Treatment $\\times$ Dept Ranking", "Constant")),
  list(model = binary_mod_m1, analysis = "Department Rank", outcome = "Any URM", model_type = "Simple",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Dept Ranking (centered)", "Treatment $\\times$ Dept Ranking", "Constant")),
  list(model = binary_mod_m2, analysis = "Department Rank", outcome = "Any URM", model_type = "Extended",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Dept Ranking (centered)", "Treatment $\\times$ Dept Ranking", "Constant"))
))

create_moderator_table(
  list(pct_mod_m1, pct_mod_m2, count_mod_m1, count_mod_m2, binary_mod_m1, binary_mod_m2),
  c("\\\\% URM", "\\\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Effect by Department Rank",
  "tab:mod_ranking",
  "Dept Ranking (centered)"
)
```

\newpage

## Moderation by Total Faculty Size

```{r mod-faculty-size}
# Create centered moderator  
data$moderator <- data$total_faculty - mean(data$total_faculty, na.rm = TRUE)
data_mod <- data %>% filter(!is.na(moderator))

# cat(paste0("Department faculty size moderation analysis (n = ", nrow(data_mod), ")\n\n"))

# Run moderation models
pct_mod_m1 <- run_regression(paste("pct_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
count_mod_m1 <- run_regression(paste("num_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
binary_mod_m1 <- run_regression(paste("has_any_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)

pct_mod_m2 <- run_regression(paste("pct_urm ~ treatment * moderator +", 
                                  paste(setdiff(c(base_controls, extended_controls), "total_faculty"), 
                                        collapse = " + ")), data_mod)
count_mod_m2 <- run_regression(paste("num_urm ~ treatment * moderator +", 
                                    paste(setdiff(c(base_controls, extended_controls), "total_faculty"), 
                                          collapse = " + ")), data_mod)
binary_mod_m2 <- run_regression(paste("has_any_urm ~ treatment * moderator +", 
                                     paste(setdiff(c(base_controls, extended_controls), "total_faculty"), 
                                           collapse = " + ")), data_mod)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_mod_m1, analysis = "Faculty Size", outcome = "% URM", model_type = "Simple",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Total Faculty (centered)", "Treatment $\\times$ Faculty Size", "Constant")),
  list(model = pct_mod_m2, analysis = "Faculty Size", outcome = "% URM", model_type = "Extended",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Total Faculty (centered)", "Treatment $\\times$ Faculty Size", "Constant")),
  list(model = count_mod_m1, analysis = "Faculty Size", outcome = "Count URM", model_type = "Simple",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Total Faculty (centered)", "Treatment $\\times$ Faculty Size", "Constant")),
  list(model = count_mod_m2, analysis = "Faculty Size", outcome = "Count URM", model_type = "Extended",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Total Faculty (centered)", "Treatment $\\times$ Faculty Size", "Constant")),
  list(model = binary_mod_m1, analysis = "Faculty Size", outcome = "Any URM", model_type = "Simple",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Total Faculty (centered)", "Treatment $\\times$ Faculty Size", "Constant")),
  list(model = binary_mod_m2, analysis = "Faculty Size", outcome = "Any URM", model_type = "Extended",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Total Faculty (centered)", "Treatment $\\times$ Faculty Size", "Constant"))
))

create_moderator_table(
  list(pct_mod_m1, pct_mod_m2, count_mod_m1, count_mod_m2, binary_mod_m1, binary_mod_m2),
  c("\\\\% URM", "\\\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Effect by Faculty Size",
  "tab:mod_faculty_size",
  "Total Faculty (centered)"
)
```

\newpage

## Moderation by URM Faculty in Peer Departments

```{r mod-peer-urm}
# Create centered moderator
data$moderator <- data$total_urm_peer_faculty - mean(data$total_urm_peer_faculty, na.rm = TRUE)
data_mod <- data %>% filter(!is.na(moderator))

# cat(paste0("Peer departments URM faculty moderation analysis (n = ", nrow(data_mod), ")\n\n"))

# Run moderation models
pct_mod_m1 <- run_regression(paste("pct_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
count_mod_m1 <- run_regression(paste("num_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
binary_mod_m1 <- run_regression(paste("has_any_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)

pct_mod_m2 <- run_regression(paste("pct_urm ~ treatment * moderator +", 
                                  paste(setdiff(c(base_controls, extended_controls), c("total_urm_peer_faculty", "total_peer_departments")), 
                                        collapse = " + ")), data_mod)
count_mod_m2 <- run_regression(paste("num_urm ~ treatment * moderator +", 
                                    paste(setdiff(c(base_controls, extended_controls), c("total_urm_peer_faculty", "total_peer_departments")), 
                                          collapse = " + ")), data_mod)
binary_mod_m2 <- run_regression(paste("has_any_urm ~ treatment * moderator +", 
                                     paste(setdiff(c(base_controls, extended_controls), c("total_urm_peer_faculty", "total_peer_departments")), 
                                           collapse = " + ")), data_mod)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_mod_m1, analysis = "Peer URM Faculty", outcome = "% URM", model_type = "Simple",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Peer URM Faculty (centered)", "Treatment $\\times$ Peer URM Faculty", "Constant")),
  list(model = pct_mod_m2, analysis = "Peer URM Faculty", outcome = "% URM", model_type = "Extended",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Peer URM Faculty (centered)", "Treatment $\\times$ Peer URM Faculty", "Constant")),
  list(model = count_mod_m1, analysis = "Peer URM Faculty", outcome = "Count URM", model_type = "Simple",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Peer URM Faculty (centered)", "Treatment $\\times$ Peer URM Faculty", "Constant")),
  list(model = count_mod_m2, analysis = "Peer URM Faculty", outcome = "Count URM", model_type = "Extended",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Peer URM Faculty (centered)", "Treatment $\\times$ Peer URM Faculty", "Constant")),
  list(model = binary_mod_m1, analysis = "Peer URM Faculty", outcome = "Any URM", model_type = "Simple",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Peer URM Faculty (centered)", "Treatment $\\times$ Peer URM Faculty", "Constant")),
  list(model = binary_mod_m2, analysis = "Peer URM Faculty", outcome = "Any URM", model_type = "Extended",
       var_names = c("treatment", "moderator", "treatment:moderator", "Constant"), 
       var_labels = c("Treatment", "Peer URM Faculty (centered)", "Treatment $\\times$ Peer URM Faculty", "Constant"))
))

create_moderator_table(
  list(pct_mod_m1, pct_mod_m2, count_mod_m1, count_mod_m2, binary_mod_m1, binary_mod_m2),
  c("\\\\% URM", "\\\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Effect by Peer URM Faculty",
  "tab:mod_peer_urm",
  "Peer URM Faculty (centered)"
)
```

\newpage

## Exploratory Analysis: Seniority Moderation

### Analysis 1: Does speaker seniority moderate the treatment effect?

```{r seniority-moderation, warning=FALSE, message=FALSE}
cat("\n\n\\clearpage\n")
cat("\\section{Exploratory Analysis: Seniority Moderation}\n\n")

# First, let's examine the distribution of years since PhD
cat("\\subsection{Distribution of Years Since PhD}\n\n")

# Use the aggregated seniority data at the seminar level
analysis_data_seniority <- data %>%
  filter(!is.na(mean_years_from_phd) & mean_years_from_phd > 0)

# Summary statistics
seniority_summary <- analysis_data_seniority %>%
  summarise(
    n_seminars = n(),
    n_departments = n_distinct(department_std),
    mean_of_means = mean(mean_years_from_phd, na.rm = TRUE),
    median_of_means = median(mean_years_from_phd, na.rm = TRUE),
    sd_of_means = sd(mean_years_from_phd, na.rm = TRUE),
    min_mean = min(mean_years_from_phd, na.rm = TRUE),
    max_mean = max(mean_years_from_phd, na.rm = TRUE),
    q25_mean = quantile(mean_years_from_phd, 0.25, na.rm = TRUE),
    q75_mean = quantile(mean_years_from_phd, 0.75, na.rm = TRUE)
  )

cat(sprintf("\\textbf{Seniority Data Coverage:}\n\n"))
cat(sprintf("- Total seminars with seniority data: %d (%.1f\\%% of total)\n", 
            seniority_summary$n_seminars, 
            100 * seniority_summary$n_seminars / nrow(data)))
cat(sprintf("- Number of departments: %d\n", seniority_summary$n_departments))
cat(sprintf("- Mean of seminar-level mean years since PhD: %.1f (SD = %.1f)\n", 
            seniority_summary$mean_of_means, seniority_summary$sd_of_means))
cat(sprintf("- Median of seminar-level mean years since PhD: %.1f\n", seniority_summary$median_of_means))
cat(sprintf("- Range of seminar means: %.1f to %.1f years\n", 
            seniority_summary$min_mean, seniority_summary$max_mean))
cat(sprintf("- IQR of seminar means: %.1f to %.1f years\n\n", 
            seniority_summary$q25_mean, seniority_summary$q75_mean))

# Continuous moderation analysis
cat("\\subsection{Continuous Moderation Analysis}\n\n")
cat("We test whether the average seniority of speakers in a seminar moderates the treatment effect on Black speaker representation.\n\n")
cat("Note: Seniority is measured as the mean years since PhD for speakers in each seminar.\n\n")

# Function to run seniority moderation analysis
run_seniority_moderation <- function(outcome_var, outcome_label) {
  cat(sprintf("\\subsubsection{Outcome: %s}\n\n", outcome_label))
  
  # Center years since PhD for interpretation
  median_years <- median(analysis_data_seniority$mean_years_from_phd, na.rm = TRUE)
  
  model_data <- analysis_data_seniority %>%
    filter(!is.na(mean_years_from_phd) & !is.na(!!sym(outcome_var))) %>%
    mutate(years_since_phd_centered = mean_years_from_phd - median_years)
  
  # Model 1: Main effects only
  formula1 <- as.formula(paste0(outcome_var, " ~ treatment + years_since_phd_centered"))
  model1 <- lm(formula1, data = model_data)
  model1$cluster_se <- get_clustered_se(model1, model_data$department_std)
  
  # Model 2: With interaction
  formula2 <- as.formula(paste0(outcome_var, " ~ treatment * years_since_phd_centered"))
  model2 <- lm(formula2, data = model_data)
  model2$cluster_se <- get_clustered_se(model2, model_data$department_std)
  
  # Model 3: With controls
  formula3 <- as.formula(paste0(outcome_var, " ~ treatment * years_since_phd_centered + ",
                               "dept_ranking + total_faculty + frac_urm_faculty"))
  model3 <- lm(formula3, data = model_data)
  model3$cluster_se <- get_clustered_se(model3, model_data$department_std)
  
  # Display results
  cat("\\begin{table}[H]\n")
  cat(sprintf("\\caption{Seniority Moderation Analysis: %s}\n", outcome_label))
  cat("\\centering\n")
  cat("\\begin{tabular}{lccc}\n")
  cat("\\toprule\n")
  cat(" & (1) & (2) & (3) \\\\\n")
  cat(" & Main Effects & Interaction & With Controls \\\\\n")
  cat("\\midrule\n")
  
  # Extract coefficients
  models <- list(model1, model2, model3)
  coef_names <- c("Treatment", "Years Since PhD (centered)", "Treatment × Years Since PhD")
  
  for (coef_name in coef_names) {
    if (coef_name == "Treatment") var_name <- "treatment"
    else if (coef_name == "Years Since PhD (centered)") var_name <- "years_since_phd_centered"
    else var_name <- "treatment:years_since_phd_centered"
    
    cat(sprintf("%s & ", coef_name))
    
    for (i in 1:3) {
      if (var_name %in% names(coef(models[[i]]))) {
        coef_val <- coef(models[[i]])[var_name]
        se_val <- models[[i]]$cluster_se[var_name]
        t_stat <- coef_val / se_val
        pval <- 2 * pt(-abs(t_stat), df = df.residual(models[[i]]))
        
        sig_stars <- ifelse(pval < 0.001, "***",
                          ifelse(pval < 0.01, "**",
                                ifelse(pval < 0.05, "*",
                                      ifelse(pval < 0.1, "+", ""))))
        
        cat(sprintf("%.4f%s", coef_val, sig_stars))
        if (i < 3) cat(" & ") else cat(" \\\\\n")
      } else {
        cat(" ")
        if (i < 3) cat(" & ") else cat(" \\\\\n")
      }
    }
    
    # Print standard errors on next line
    cat(sprintf(" & "))
    for (i in 1:3) {
      if (var_name %in% names(coef(models[[i]]))) {
        se_val <- models[[i]]$cluster_se[var_name]
        cat(sprintf("(%.4f)", se_val))
        if (i < 3) cat(" & ") else cat(" \\\\\n")
      } else {
        cat(" ")
        if (i < 3) cat(" & ") else cat(" \\\\\n")
      }
    }
  }
  
  cat("\\midrule\n")
  cat(sprintf("Observations & %d & %d & %d \\\\\n", 
              nrow(model1$model), nrow(model2$model), nrow(model3$model)))
  cat(sprintf("R-squared & %.3f & %.3f & %.3f \\\\\n",
              summary(model1)$r.squared, summary(model2)$r.squared, summary(model3)$r.squared))
  cat("Controls & No & No & Yes \\\\\n")
  cat("\\bottomrule\n")
  cat("\\end{tabular}\n")
  cat("\\parbox{\\linewidth}{\\footnotesize Note: Clustered standard errors at department level in parentheses. Years since PhD is the mean years since PhD for speakers in each seminar, centered at the median. Controls include department ranking, total faculty, and fraction URM faculty. Significance: + p<0.1; * p<0.05; ** p<0.01; *** p<0.001.}\n")
  cat("\\end{table}\n\n")
  
  # Return models for later use
  return(list(main = model1, interaction = model2, controls = model3))
}

# Run for both outcomes
black_seniority_models <- run_seniority_moderation("pct_black", "Percentage Black Speakers")
any_black_seniority_models <- run_seniority_moderation("has_any_black", "Any Black Speakers")

# Median split analysis
cat("\\subsection{Subgroup Analysis: Seminars with Senior vs Junior Speakers}\n\n")

# Create senior/junior split based on mean years since PhD
analysis_data_split <- analysis_data_seniority %>%
  filter(!is.na(mean_years_from_phd)) %>%
  mutate(
    seniority_group = if_else(mean_years_from_phd > median(mean_years_from_phd, na.rm = TRUE),
                             "Senior", "Junior")
  )

# Summary by group
split_summary <- analysis_data_split %>%
  group_by(seniority_group) %>%
  summarise(
    n = n(),
    mean_years = mean(mean_years_from_phd, na.rm = TRUE),
    min_years = min(mean_years_from_phd, na.rm = TRUE),
    max_years = max(mean_years_from_phd, na.rm = TRUE)
  )

cat("\\textbf{Median Split Groups:}\n\n")
for (i in 1:nrow(split_summary)) {
  cat(sprintf("- Seminars with %s speakers (n=%d): Mean = %.1f years, Range = %.1f-%.1f years\n",
              tolower(split_summary$seniority_group[i]),
              split_summary$n[i],
              split_summary$mean_years[i],
              split_summary$min_years[i],
              split_summary$max_years[i]))
}
cat("\n")

# Function for subgroup analysis
run_subgroup_analysis <- function(outcome_var, outcome_label) {
  cat(sprintf("\\subsubsection{Outcome: %s}\n\n", outcome_label))
  
  # Run models for each subgroup
  junior_data <- filter(analysis_data_split, seniority_group == "Junior")
  senior_data <- filter(analysis_data_split, seniority_group == "Senior")
  
  # Simple models
  junior_model <- lm(as.formula(paste0(outcome_var, " ~ treatment")), data = junior_data)
  junior_model$cluster_se <- get_clustered_se(junior_model, junior_data$department_std)
  
  senior_model <- lm(as.formula(paste0(outcome_var, " ~ treatment")), data = senior_data)
  senior_model$cluster_se <- get_clustered_se(senior_model, senior_data$department_std)
  
  # With controls
  control_formula <- paste0(outcome_var, " ~ treatment + dept_ranking + total_faculty + ",
                           "frac_urm_faculty")
  
  junior_model_ctrl <- lm(as.formula(control_formula), data = junior_data)
  junior_model_ctrl$cluster_se <- get_clustered_se(junior_model_ctrl, junior_data$department_std)
  
  senior_model_ctrl <- lm(as.formula(control_formula), data = senior_data)  
  senior_model_ctrl$cluster_se <- get_clustered_se(senior_model_ctrl, senior_data$department_std)
  
  # Create comparison table
  cat("\\begin{table}[H]\n")
  cat(sprintf("\\caption{Subgroup Analysis by Seniority: %s}\n", outcome_label))
  cat("\\centering\n")
  cat("\\begin{tabular}{lcccc}\n")
  cat("\\toprule\n")
  cat(" & \\multicolumn{2}{c}{Seminars with Junior Speakers} & \\multicolumn{2}{c}{Seminars with Senior Speakers} \\\\\n")
  cat(" & (1) & (2) & (3) & (4) \\\\\n")
  cat(" & Simple & With Controls & Simple & With Controls \\\\\n")
  cat("\\midrule\n")
  
  # Treatment coefficient
  junior_coef <- coef(junior_model)["treatment"]
  junior_se <- junior_model$cluster_se["treatment"]
  junior_t <- junior_coef / junior_se
  junior_pval <- 2 * pt(-abs(junior_t), df = df.residual(junior_model))
  
  junior_coef_ctrl <- coef(junior_model_ctrl)["treatment"]
  junior_se_ctrl <- junior_model_ctrl$cluster_se["treatment"]
  junior_t_ctrl <- junior_coef_ctrl / junior_se_ctrl
  junior_pval_ctrl <- 2 * pt(-abs(junior_t_ctrl), df = df.residual(junior_model_ctrl))
  
  senior_coef <- coef(senior_model)["treatment"]
  senior_se <- senior_model$cluster_se["treatment"]
  senior_t <- senior_coef / senior_se
  senior_pval <- 2 * pt(-abs(senior_t), df = df.residual(senior_model))
  
  senior_coef_ctrl <- coef(senior_model_ctrl)["treatment"]
  senior_se_ctrl <- senior_model_ctrl$cluster_se["treatment"]
  senior_t_ctrl <- senior_coef_ctrl / senior_se_ctrl
  senior_pval_ctrl <- 2 * pt(-abs(senior_t_ctrl), df = df.residual(senior_model_ctrl))
  
  # Format significance stars
  format_sig <- function(p) {
    ifelse(p < 0.001, "***", ifelse(p < 0.01, "**", ifelse(p < 0.05, "*", ifelse(p < 0.1, "+", ""))))
  }
  
  cat(sprintf("Treatment & %.4f%s & %.4f%s & %.4f%s & %.4f%s \\\\\n",
              junior_coef, format_sig(junior_pval),
              junior_coef_ctrl, format_sig(junior_pval_ctrl),
              senior_coef, format_sig(senior_pval),
              senior_coef_ctrl, format_sig(senior_pval_ctrl)))
  
  cat(sprintf(" & (%.4f) & (%.4f) & (%.4f) & (%.4f) \\\\\n",
              junior_se, junior_se_ctrl, senior_se, senior_se_ctrl))
  
  cat("\\midrule\n")
  cat(sprintf("Observations & %d & %d & %d & %d \\\\\n",
              nrow(junior_model$model), nrow(junior_model_ctrl$model),
              nrow(senior_model$model), nrow(senior_model_ctrl$model)))
  cat(sprintf("R-squared & %.3f & %.3f & %.3f & %.3f \\\\\n",
              summary(junior_model)$r.squared, summary(junior_model_ctrl)$r.squared,
              summary(senior_model)$r.squared, summary(senior_model_ctrl)$r.squared))
  cat("Controls & No & Yes & No & Yes \\\\\n")
  cat("\\bottomrule\n")
  cat("\\end{tabular}\n")
  cat("\\parbox{\\linewidth}{\\footnotesize Note: Clustered standard errors at department level in parentheses. Junior/Senior split at median of seminar-level mean years since PhD. Controls include department ranking, total faculty, and fraction URM faculty. Significance: + p<0.1; * p<0.05; ** p<0.01; *** p<0.001.}\n")
  cat("\\end{table}\n\n")
  
  # Test for difference between groups
  cat("\\textbf{Test for Difference Between Groups:}\n\n")
  
  # Pooled model with triple interaction
  pooled_data <- analysis_data_split %>%
    mutate(is_senior = as.numeric(seniority_group == "Senior"))
  
  diff_model <- lm(as.formula(paste0(outcome_var, " ~ treatment * is_senior")),
                   data = pooled_data)
  diff_model$cluster_se <- get_clustered_se(diff_model, pooled_data$department_std)
  
  interaction_coef <- coef(diff_model)["treatment:is_senior"]
  interaction_se <- diff_model$cluster_se["treatment:is_senior"]
  interaction_t <- interaction_coef / interaction_se
  interaction_pval <- 2 * pt(-abs(interaction_t), df = df.residual(diff_model))
  
  cat(sprintf("Difference in treatment effect (Senior - Junior): %.4f (SE = %.4f), p = %.4f%s\n\n",
              interaction_coef, interaction_se, interaction_pval,
              format_sig(interaction_pval)))
}

# Run subgroup analyses
run_subgroup_analysis("pct_black", "Percentage Black Speakers")
run_subgroup_analysis("has_any_black", "Any Black Speakers")
```

```{r final-significant-results, results='asis'}
# Comprehensive function to extract ALL significant results including interactions
extract_all_significant_results <- function() {
  results <- data.frame(
    Analysis = character(),
    Outcome = character(),
    Variable = character(),
    Model = character(),
    Coefficient = numeric(),
    SE = numeric(),
    t_stat = numeric(),
    p_value = numeric(),
    Significance = character(),
    Category = character(),
    stringsAsFactors = FALSE
  )
  
  add_if_significant_any <- function(model, analysis, outcome, model_type, 
                                    var_names = c("treatment"), 
                                    var_labels = c("Treatment")) {
    if (!is.null(model)) {
      model_coefs <- coef(model)
      model_ses <- model$cluster_se 
      
      for (i in seq_along(var_names)) {
        var_name_in_formula <- var_names[i] 
        var_label_for_table <- var_labels[i] 
        
        actual_coef_name <- var_name_in_formula
        if (var_name_in_formula == "Constant" && "(Intercept)" %in% names(model_coefs)) {
            actual_coef_name <- "(Intercept)"
        } else if (var_name_in_formula == "treatment:moderator") {
            if ("treatment:moderator" %in% names(model_coefs)) {
                actual_coef_name <- "treatment:moderator"
            } else if ("moderator:treatment" %in% names(model_coefs)) {
                actual_coef_name <- "moderator:treatment"
            }
        } 

        if (actual_coef_name %in% names(model_coefs)) {
          coef_val <- model_coefs[actual_coef_name]
          
          if (actual_coef_name %in% names(model_ses)) {
            se_val <- model_ses[actual_coef_name]
            t_val <- coef_val / se_val
            p_val <- 2 * pt(-abs(t_val), df = length(model$residuals) - length(model_coefs))
            
            if (p_val < 0.1) {
              # MODIFICATION: Only include treatment effects or treatment interactions
              if (var_label_for_table != "Constant" && 
                  (var_label_for_table == "Treatment" || 
                   grepl("Treatment", var_label_for_table))) {
                sig <- ifelse(p_val < 0.001, "***", 
                             ifelse(p_val < 0.01, "**",
                                   ifelse(p_val < 0.05, "*", "+")))
                
                category <- case_when(
                  grepl("Main Effect|Main Question", analysis) ~ "Main Effects",
                  grepl("Demographic|Black|Hispanic|Female", analysis) ~ "Identity Analysis",
                  grepl("Intersectional", analysis) ~ "Identity Analysis", 
                  grepl("Semester", analysis) ~ "Semester Analysis",
                  grepl("Chemistry|Mathematics|Physics|Computer Science|Mechanical Engineering", analysis) ~ "Discipline Analysis",
                  grepl("Moderation|Department Rank|Faculty Size|Peer URM", analysis) ~ "Moderation Analysis",
                  TRUE ~ "Other"
                )
                
                results <<- rbind(results, data.frame(
                  Analysis = analysis,
                  Outcome = outcome,
                  Variable = var_label_for_table, 
                  Model = model_type,
                  Coefficient = coef_val,
                  SE = se_val,
                  t_stat = t_val,
                  p_value = p_val,
                  Significance = sig,
                  Category = category,
                  stringsAsFactors = FALSE
                ))
              } # End of treatment filter
            }
          }
        }
      }
    }
  }
  
  for (model_info in all_models_list) {
    model <- model_info$model
    analysis <- model_info$analysis
    outcome <- model_info$outcome
    model_type <- model_info$model_type
    var_names <- model_info$var_names   
    var_labels <- model_info$var_labels 
    
    if (is.null(var_names)) { 
      var_names <- c("treatment", "Constant") 
      var_labels <- c("Treatment", "Constant")
    }
    
    add_if_significant_any(model, analysis, outcome, model_type, var_names, var_labels)
  }
  
  return(results)
}

all_significant_results <- extract_all_significant_results()

if (nrow(all_significant_results) > 0) {
  all_significant_results <- all_significant_results %>%
    group_by(Analysis, Outcome, Variable) %>%
    arrange(p_value) %>%
    slice(1) %>%
    ungroup()
  
  # Re-create Category column if it doesn't exist
  if (!"Category" %in% names(all_significant_results)) {
    all_significant_results$Category <- NA_character_
    for (i in 1:nrow(all_significant_results)) {
      if (grepl("Main Effect|Main Question", all_significant_results$Analysis[i])) {
        all_significant_results$Category[i] <- "Main Effects"
      } else if (grepl("Demographic|Black|Hispanic|Female|Intersectional", all_significant_results$Analysis[i])) {
        all_significant_results$Category[i] <- "Identity Analysis"
      } else if (grepl("Semester", all_significant_results$Analysis[i])) {
        all_significant_results$Category[i] <- "Semester Analysis"
      } else if (grepl("Chemistry|Mathematics|Physics|Computer Science|Mechanical Engineering", all_significant_results$Analysis[i])) {
        all_significant_results$Category[i] <- "Discipline Analysis"
      } else if (grepl("Moderation|Department Rank|Faculty Size|Peer URM", all_significant_results$Analysis[i])) {
        all_significant_results$Category[i] <- "Moderation Analysis"
      } else {
        all_significant_results$Category[i] <- "Other"
      }
    }
  }
  
  all_significant_results <- all_significant_results %>%
    arrange(Category, Analysis, Outcome, Variable) %>%
    mutate(
      Coefficient = sprintf("%.4f", Coefficient),
      SE = sprintf("%.4f", SE),
      t_stat = sprintf("%.3f", t_stat),
      p_value_formatted = sprintf("%.4f", p_value)
    )
  
  cat("\n\n\\clearpage\n")
  cat("\\section{Summary of All Significant Results}\n\n")
  
  cat("\\begin{table}[H]\n")
  cat("\\caption{All Significant Results (p < 0.1) from All Analyses (Excluding Constant Term)}\n") # Caption updated
  cat("\\label{tab:all_significant_results}\n")
  cat("\\centering\n")
  cat("{\\scriptsize % Start group for scriptsize and tabcolsep\n") 
  cat("\\setlength{\\tabcolsep}{2pt} % Reduce column separation further\n") 
  # MODIFICATION: Remove adjustbox for landscape table to avoid spacing issues
  cat("\\begin{tabular}{p{3.2cm} p{2.3cm} p{2.3cm} l r r r r l}\n") 
  cat("\\toprule\n")
  cat("Analysis & Outcome & Variable & Model & Coef. & SE & t-stat & p-value & Sig. \\\\\n")
  cat("\\midrule\n")
  
  current_category <- ""
  for (i in 1:nrow(all_significant_results)) {
    if (all_significant_results$Category[i] != current_category) {
      if (current_category != "") {
        cat("\\addlinespace[0.5em]\n") 
      }
      current_category <- all_significant_results$Category[i]
      cat(sprintf("\\multicolumn{9}{l}{\\textbf{%s}} \\\\\n", escape_latex(current_category)))
      cat("\\midrule\n")
    }
    
    cat(sprintf("%s & %s & %s & %s & %s & %s & %s & %s & %s \\\\\n",
                escape_latex(all_significant_results$Analysis[i]),
                escape_latex(all_significant_results$Outcome[i]),
                escape_latex(all_significant_results$Variable[i]),
                escape_latex(all_significant_results$Model[i]),
                all_significant_results$Coefficient[i],
                all_significant_results$SE[i],
                all_significant_results$t_stat[i],
                all_significant_results$p_value_formatted[i],
                all_significant_results$Significance[i]))
  }
  
  cat("\\bottomrule\n")
  cat("\\end{tabular}\n")
  cat("} % End group for scriptsize and tabcolsep\n") 
  cat("\\parbox{\\linewidth}{\\footnotesize Note: Significance levels: + p<0.1; * p<0.05; ** p<0.01; *** p<0.001. SE = Clustered standard errors at department level. Constant terms are excluded from this summary.}\n") # Note updated
  cat("\\end{table}\n")
  
} else {
  cat("\n\\textit{No significant results (p < 0.1) for treatment or interaction effects found in any of the analyses.}\n\n") # Message updated
}
```