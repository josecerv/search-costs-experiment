---
title: "Search Costs Field Experiment: Pre-Registration Analysis"
author: "Statistical Analysis Report"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
    fig_caption: true
    keep_tex: false
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{float}
  - \usepackage{pdflscape}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
  - \usepackage{caption}
  - \captionsetup[table]{position=below,skip=10pt}
  - \usepackage{dcolumn}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      fig.pos = 'H', results = 'asis')

# Load required libraries
library(tidyverse)
library(stargazer)
library(lmtest)
library(sandwich)
library(systemfit)
library(knitr)
library(kableExtra)
library(car)  # For linearHypothesis

# Set stargazer options
options(width = 200)

# Load the data
data <- read.csv("outputs/master_analysis_dataset.csv")

# Data validation
cat("Data loaded successfully. N =", nrow(data), "\n")
cat("Treatment:", sum(data$treatment), "Control:", sum(1-data$treatment), "\n\n")

# Create all derived variables at once
data <- data %>%
  mutate(
    # Non-URM counts
    num_non_urm = speakers_with_demographics - num_urm,
    fall_num_non_urm = fall_speakers_with_demographics - fall_num_urm,
    spring_num_non_urm = spring_speakers_with_demographics - spring_num_urm,
    
    # Non-demographic counts
    num_non_black = speakers_with_demographics - num_black,
    num_non_hispanic = speakers_with_demographics - num_hispanic,
    num_non_female = speakers_with_demographics - num_female,
    
    fall_num_non_black = fall_speakers_with_demographics - fall_num_black,
    fall_num_non_hispanic = fall_speakers_with_demographics - fall_num_hispanic,
    fall_num_non_female = fall_speakers_with_demographics - fall_num_female,
    
    spring_num_non_black = spring_speakers_with_demographics - spring_num_black,
    spring_num_non_hispanic = spring_speakers_with_demographics - spring_num_hispanic,
    spring_num_non_female = spring_speakers_with_demographics - spring_num_female,
    
    # Non-URM percentages
    pct_non_urm = 100 - pct_urm,
    fall_pct_non_urm = 100 - fall_pct_urm,
    spring_pct_non_urm = 100 - spring_pct_urm,
    
    # Binary indicators
    has_any_non_urm = as.numeric(num_non_urm > 0),
    fall_has_any_urm = as.numeric(fall_num_urm > 0),
    spring_has_any_urm = as.numeric(spring_num_urm > 0),
    fall_has_any_non_urm = as.numeric(fall_num_non_urm > 0),
    spring_has_any_non_urm = as.numeric(spring_num_non_urm > 0),
    
    # Additional binary indicators for Black, Hispanic, and Female
    fall_has_any_black = as.numeric(fall_num_black > 0),
    spring_has_any_black = as.numeric(spring_num_black > 0),
    fall_has_any_hispanic = as.numeric(fall_num_hispanic > 0),
    spring_has_any_hispanic = as.numeric(spring_num_hispanic > 0),
    fall_has_any_female = as.numeric(fall_num_female > 0),
    spring_has_any_female = as.numeric(spring_num_female > 0),
    
    # For total speakers analysis
    pct_speakers = 100,  # All seminars have speakers by definition
    has_speakers = 1     # All seminars in dataset have speakers
  )

# Function to create clustered standard errors
get_clustered_se <- function(model, cluster_var) {
  vcov_cluster <- vcovCL(model, cluster = cluster_var)
  return(sqrt(diag(vcov_cluster)))
}

# Function to run regression with clustered SEs
run_regression <- function(formula_str, data_subset, cluster_var = "department_std") {
  # Remove rows with missing values in the model variables
  model_vars <- all.vars(as.formula(formula_str))
  data_complete <- data_subset[complete.cases(data_subset[, model_vars, drop = FALSE]), ]
  
  if (nrow(data_complete) < 30) {
    warning("Less than 30 observations after removing missing values")
    return(NULL)
  }
  
  model <- lm(as.formula(formula_str), data = data_complete)
  
  # Get clustered standard errors
  cluster_data <- data_complete[[cluster_var]]
  model$cluster_se <- get_clustered_se(model, cluster_data)
  
  return(model)
}

# Define control variables
# Note: We omit batch_10 and bin_18_28 as reference categories to avoid perfect multicollinearity
base_controls <- c("bin_1_3", "bin_3_5", "bin_5_7", "bin_7_11", "bin_17_26",
                   "disc_mathematics", "disc_physics", "disc_computer_science", 
                   "disc_mechanical_engineering",
                   "batch_1", "batch_2", "batch_3", "batch_4", "batch_5", 
                   "batch_6", "batch_7", "batch_8")

extended_controls <- c("total_faculty", "frac_urm_faculty", "frac_women_faculty",
                       "dept_ranking", "missing_dept_rank", 
                       "total_urm_peer_faculty", "total_peer_departments",
                       "num_recipients")

create_stargazer_table <- function(models, dep_var_labels, title, label, 
                                  keep_vars = c("treatment", "Constant"),
                                  covariate_labels = c("Treatment", "Constant"),
                                  demographic_group = NULL) {
  
  # Filter out NULL models
  valid_models <- models[!sapply(models, is.null)]
  if (length(valid_models) == 0) {
    cat("\n\nInsufficient data for this analysis.\n\n")
    return(invisible(NULL))
  }
  
  # Extract clustered SEs for the kept variables
  se_list <- lapply(valid_models, function(x) {
    se_names <- names(coef(x))
    se_names[se_names == "(Intercept)"] <- "Constant"
    keep_indices <- which(se_names %in% keep_vars)
    if (length(keep_indices) > 0) {
      return(x$cluster_se[keep_indices])
    } else {
      return(rep(NA, length(keep_vars)))
    }
  })
  
  # Create column labels based on number of models
  n_models <- length(valid_models)
  if (n_models == 6) {
    column_labels <- c("\\% " %+% demographic_group, "Count " %+% demographic_group, "Any " %+% demographic_group)
    column_separate <- c(2, 2, 2)
    controls_labels <- c("Simple", "Extended", "Simple", "Extended", "Simple", "Extended")
  } else {
    column_labels <- rep("", n_models)
    column_separate <- rep(1, n_models)
    controls_labels <- rep(c("Simple", "Extended"), length.out = n_models)
  }
  
  stargazer(valid_models,
            type = "latex",
            title = title,
            label = label,
            dep.var.labels.include = FALSE,
            dep.var.caption = "",
            covariate.labels = covariate_labels,
            keep = keep_vars,
            se = se_list,
            omit.stat = c("f", "ser", "rsq", "adj.rsq", "n"),  # Add "adj.rsq" and "n" here
            add.lines = list(
              c("Controls", controls_labels),
              c("N", sapply(valid_models, function(x) format(length(x$residuals), big.mark=","))),
              c("Adjusted $R^2$", sapply(valid_models, function(x) sprintf("%.3f", summary(x)$adj.r.squared)))
            ),
            notes = c("\\parbox{\\linewidth}{\\vspace{2pt}Clustered standard errors at department level in parentheses.\\\\$^{+}p<0.1$; $^{*}p<0.05$; $^{**}p<0.01$; $^{***}p<0.001$\\vspace{2pt}}"),
            notes.align = "l",
            notes.append = FALSE,
            star.char = c("+", "*", "**", "***"),
            star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
            header = FALSE,
            model.numbers = TRUE,
            column.labels = column_labels,
            model.names = FALSE,
            multicolumn = TRUE,
            column.separate = column_separate,
            float = TRUE,
            float.env = "table",
            table.placement = "H",
            font.size = "footnotesize",
            no.space = TRUE)
}



# Helper function for string concatenation
`%+%` <- function(x, y) paste0(x, y)

# Function for moderator analysis tables
create_moderator_table <- function(models, dep_var_labels, title, label, moderator_name) {
  
  # Filter out NULL models
  valid_models <- models[!sapply(models, is.null)]
  if (length(valid_models) == 0) {
    cat("\n\nInsufficient data for this analysis.\n\n")
    return(invisible(NULL))
  }
  
  # Define variables to keep
  keep_vars <- c("treatment", "moderator", "treatment:moderator", "Constant")
  covariate_labels <- c("Treatment", moderator_name, paste("Treatment $\\times$", moderator_name), "Constant")
  
  # Extract clustered SEs
  se_list <- lapply(valid_models, function(x) {
    se_names <- names(coef(x))
    se_names[se_names == "(Intercept)"] <- "Constant"
    keep_indices <- which(se_names %in% keep_vars)
    if (length(keep_indices) > 0) {
      return(x$cluster_se[keep_indices])
    } else {
      return(rep(NA, length(keep_vars)))
    }
  })
  
  # Create column labels and controls labels
  n_models <- length(valid_models)
  if (n_models == 6) {
    column_labels <- c("\\% URM", "Count URM", "Any URM")
    column_separate <- c(2, 2, 2)
    controls_labels <- c("Simple", "Extended", "Simple", "Extended", "Simple", "Extended")
  } else {
    column_labels <- rep("", n_models)
    column_separate <- rep(1, n_models)
    controls_labels <- rep(c("Simple", "Extended"), length.out = n_models)
  }
  
  stargazer(valid_models,
            type = "latex",
            title = title,
            label = label,
            dep.var.labels.include = FALSE,
            dep.var.caption = "",
            covariate.labels = covariate_labels,
            keep = keep_vars,
            se = se_list,
            omit.stat = c("f", "ser", "rsq", "adj.rsq", "n"),  # Add "adj.rsq" and "n" here
            add.lines = list(
              c("Controls", controls_labels),
              c("N", sapply(valid_models, function(x) format(length(x$residuals), big.mark=","))),
              c("Adjusted $R^2$", sapply(valid_models, function(x) sprintf("%.3f", summary(x)$adj.r.squared)))
            ),
            notes = c("\\parbox{\\linewidth}{\\vspace{2pt}Clustered standard errors at department level in parentheses.\\\\$^{+}p<0.1$; $^{*}p<0.05$; $^{**}p<0.01$; $^{***}p<0.001$\\vspace{2pt}}"),
            notes.align = "l",
            notes.append = FALSE,
            star.char = c("+", "*", "**", "***"),
            star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
            header = FALSE,
            model.numbers = TRUE,
            column.labels = column_labels,
            model.names = FALSE,
            multicolumn = TRUE,
            column.separate = column_separate,
            float = TRUE,
            float.env = "table",
            table.placement = "H",
            font.size = "footnotesize",
            no.space = TRUE)
}


# Helper function to create intersectional variables
create_intersectional_vars <- function(data, demo1, demo2, label) {
  pct_col <- paste0("pct_", label)
  num_col <- paste0("approx_num_", label)
  has_col <- paste0("has_any_", label)
  
  # Calculate percentage as product of individual percentages (assuming independence)
  data[[pct_col]] <- (data[[paste0("pct_", demo1)]] / 100) * 
                     (data[[paste0("pct_", demo2)]] / 100) * 100
  
  # Approximate count (assuming independence between demographics)
  data[[num_col]] <- round((data[[paste0("num_", demo1)]] / data$speakers_with_demographics) * 
                          (data[[paste0("num_", demo2)]] / data$speakers_with_demographics) * 
                          data$speakers_with_demographics)
  
  # Handle missing values and zeros
  data[[num_col]][is.na(data[[num_col]])] <- 0
  data[[num_col]][data$speakers_with_demographics == 0] <- 0
  
  # Binary indicator
  data[[has_col]] <- as.numeric(data[[num_col]] > 0)
  
  return(data)
}

# Create all intersectional variables
data <- create_intersectional_vars(data, "urm", "female", "urm_female")
data <- create_intersectional_vars(data, "black", "female", "black_female")
data <- create_intersectional_vars(data, "black", "male", "black_male")
data <- create_intersectional_vars(data, "hispanic", "female", "hispanic_female")
data <- create_intersectional_vars(data, "hispanic", "male", "hispanic_male")

# Initialize list to store all models for significant results extraction
all_models_list <- list()

# Function to escape LaTeX special characters
escape_latex <- function(x) {
  if (is.null(x) || is.na(x)) return(x)
  x <- gsub("&", "\\\\&", x)
  x <- gsub("%", "\\\\%", x)
  # Don't escape $ to preserve math mode expressions like $\\times$
  # x <- gsub("\\$", "\\\\$", x)
  x <- gsub("#", "\\\\#", x)
  x <- gsub("_", "\\\\_", x)
  x <- gsub("\\{", "\\\\{", x)
  x <- gsub("\\}", "\\\\}", x)
  x <- gsub("~", "\\\\textasciitilde{}", x)
  x <- gsub("\\^", "\\\\textasciicircum{}", x)
  # × character already replaced with $\\times$ in the file
  return(x)
}
```

\newpage

# Executive Summary

This report presents the comprehensive statistical analysis for the search costs field experiment, examining whether providing academic seminar organizers with access to a database of underrepresented racial minority (URM) faculty members increases diversity in seminar speakers. The analysis follows the pre-registered analysis plan and examines treatment effects across multiple dependent variables and subgroups.

**Note**: A comprehensive overview of all significant results (p < 0.1) is provided at the end of this document.


\newpage

# Summary Statistics

## Overall Summary Statistics

### Seminar Speaker Demographics

```{r summary-stats-overall-seminars}
# Overall summary statistics for seminar speakers
summary_seminars <- data %>%
  summarise(
    n_seminars = n(),
    n_unique_departments = n_distinct(department_std),
    total_speakers_all = sum(total_speakers, na.rm = TRUE),
    mean_speakers_per_seminar = mean(total_speakers, na.rm = TRUE),
    sd_speakers_per_seminar = sd(total_speakers, na.rm = TRUE),
    min_speakers = min(total_speakers, na.rm = TRUE),
    max_speakers = max(total_speakers, na.rm = TRUE),
    
    # URM stats
    mean_pct_urm = mean(pct_urm, na.rm = TRUE),
    sd_pct_urm = sd(pct_urm, na.rm = TRUE),
    mean_num_urm = mean(num_urm, na.rm = TRUE),
    sd_num_urm = sd(num_urm, na.rm = TRUE),
    prop_seminars_has_urm = mean(has_any_urm, na.rm = TRUE),
    
    # Black stats
    mean_pct_black = mean(pct_black, na.rm = TRUE),
    sd_pct_black = sd(pct_black, na.rm = TRUE),
    mean_num_black = mean(num_black, na.rm = TRUE),
    sd_num_black = sd(num_black, na.rm = TRUE),
    prop_seminars_has_black = mean(has_any_black, na.rm = TRUE),
    
    # Hispanic stats
    mean_pct_hispanic = mean(pct_hispanic, na.rm = TRUE),
    sd_pct_hispanic = sd(pct_hispanic, na.rm = TRUE),
    mean_num_hispanic = mean(num_hispanic, na.rm = TRUE),
    sd_num_hispanic = sd(num_hispanic, na.rm = TRUE),
    prop_seminars_has_hispanic = mean(has_any_hispanic, na.rm = TRUE),
    
    # Female stats
    mean_pct_female = mean(pct_female, na.rm = TRUE),
    sd_pct_female = sd(pct_female, na.rm = TRUE),
    mean_num_female = mean(num_female, na.rm = TRUE),
    sd_num_female = sd(num_female, na.rm = TRUE),
    prop_seminars_has_female = mean(has_any_female, na.rm = TRUE)
  )

# First table: Basic seminar information
cat("\\begin{table}[H]\n")
cat("\\caption{Overall Seminar Statistics}\n")
cat("\\label{tab:summary_seminars_basic}\n")
cat("\\centering\n")
cat("\\begin{tabular}{lr}\n")
cat("\\toprule\n")
cat("Statistic & Value \\\\\n")
cat("\\midrule\n")
cat(sprintf("Number of seminars & %d \\\\\n", summary_seminars$n_seminars))
cat(sprintf("Number of unique departments & %d \\\\\n", summary_seminars$n_unique_departments))
cat(sprintf("Total speakers across all seminars & %d \\\\\n", summary_seminars$total_speakers_all))
cat(sprintf("Mean speakers per seminar & %.2f \\\\\n", summary_seminars$mean_speakers_per_seminar))
cat(sprintf("SD speakers per seminar & %.2f \\\\\n", summary_seminars$sd_speakers_per_seminar))
cat(sprintf("Min speakers in a seminar & %d \\\\\n", summary_seminars$min_speakers))
cat(sprintf("Max speakers in a seminar & %d \\\\\n", summary_seminars$max_speakers))
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\end{table}\n")

# Second table: Speaker demographics in seminars
cat("\n\\begin{table}[H]\n")
cat("\\caption{Seminar Speaker Demographics (Across All Seminars)}\n")
cat("\\label{tab:summary_seminar_demographics}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccc}\n")
cat("\\toprule\n")
cat("Demographic Group & Mean \\% & SD \\% & Mean Count & SD Count & Prop. Seminars w/ Any \\\\\n")
cat("\\midrule\n")
cat(sprintf("URM & %.2f & %.2f & %.2f & %.2f & %.3f \\\\\n",
            summary_seminars$mean_pct_urm, summary_seminars$sd_pct_urm,
            summary_seminars$mean_num_urm, summary_seminars$sd_num_urm,
            summary_seminars$prop_seminars_has_urm))
cat(sprintf("Black & %.2f & %.2f & %.2f & %.2f & %.3f \\\\\n",
            summary_seminars$mean_pct_black, summary_seminars$sd_pct_black,
            summary_seminars$mean_num_black, summary_seminars$sd_num_black,
            summary_seminars$prop_seminars_has_black))
cat(sprintf("Hispanic & %.2f & %.2f & %.2f & %.2f & %.3f \\\\\n",
            summary_seminars$mean_pct_hispanic, summary_seminars$sd_pct_hispanic,
            summary_seminars$mean_num_hispanic, summary_seminars$sd_num_hispanic,
            summary_seminars$prop_seminars_has_hispanic))
cat(sprintf("Female & %.2f & %.2f & %.2f & %.2f & %.3f \\\\\n",
            summary_seminars$mean_pct_female, summary_seminars$sd_pct_female,
            summary_seminars$mean_num_female, summary_seminars$sd_num_female,
            summary_seminars$prop_seminars_has_female))
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\footnotesize{Note: N = ", summary_seminars$n_seminars, " seminars. Percentages calculated among speakers with demographic data available. 'Prop. Seminars w/ Any' indicates the proportion of seminars that have at least one speaker from that demographic group.}\n")
cat("\\end{table}\n")
```

### Department Faculty Demographics

```{r summary-stats-overall-departments}
# Department faculty demographics (aggregated to department level)
dept_summary <- data %>%
  group_by(department_std) %>%
  summarise(
    # Take the first value for each department (since faculty demographics are constant within department)
    total_faculty = first(total_faculty),
    frac_urm_faculty = first(frac_urm_faculty),
    frac_women_faculty = first(frac_women_faculty),
    .groups = 'drop'
  ) %>%
  summarise(
    n_departments = n(),
    mean_total_faculty = mean(total_faculty, na.rm = TRUE),
    sd_total_faculty = sd(total_faculty, na.rm = TRUE),
    mean_pct_urm_faculty = mean(frac_urm_faculty * 100, na.rm = TRUE),
    sd_pct_urm_faculty = sd(frac_urm_faculty * 100, na.rm = TRUE),
    mean_pct_women_faculty = mean(frac_women_faculty * 100, na.rm = TRUE),
    sd_pct_women_faculty = sd(frac_women_faculty * 100, na.rm = TRUE)
  )

# Department faculty table
cat("\n\\begin{table}[H]\n")
cat("\\caption{Department Faculty Demographics}\n")
cat("\\label{tab:summary_dept_faculty}\n")
cat("\\centering\n")
cat("\\begin{tabular}{lcc}\n")
cat("\\toprule\n")
cat("Statistic & Mean & SD \\\\\n")
cat("\\midrule\n")
cat(sprintf("Total faculty per department & %.1f & %.1f \\\\\n",
            dept_summary$mean_total_faculty, dept_summary$sd_total_faculty))
cat(sprintf("\\%% URM faculty & %.2f & %.2f \\\\\n",
            dept_summary$mean_pct_urm_faculty, dept_summary$sd_pct_urm_faculty))
cat(sprintf("\\%% Women faculty & %.2f & %.2f \\\\\n",
            dept_summary$mean_pct_women_faculty, dept_summary$sd_pct_women_faculty))
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\footnotesize{Note: N = ", dept_summary$n_departments, " unique departments. Department faculty demographics based on 2024 coding.}\n")
cat("\\end{table}\n")
```

## Summary Statistics by Discipline

### Seminar Speaker Demographics by Discipline

```{r summary-stats-discipline-seminars}
# Summary statistics by discipline for seminars
summary_by_disc_seminars <- data %>%
  mutate(discipline = case_when(
    disc_mathematics == 1 ~ "Mathematics",
    disc_physics == 1 ~ "Physics",
    disc_computer_science == 1 ~ "Computer Science",
    disc_mechanical_engineering == 1 ~ "Mechanical Engineering",
    TRUE ~ "Chemistry"
  )) %>%
  group_by(discipline) %>%
  summarise(
    n_seminars = n(),
    n_departments = n_distinct(department_std),
    mean_speakers_per_seminar = mean(total_speakers, na.rm = TRUE),
    sd_speakers_per_seminar = sd(total_speakers, na.rm = TRUE),
    
    # URM stats
    mean_pct_urm = mean(pct_urm, na.rm = TRUE),
    sd_pct_urm = sd(pct_urm, na.rm = TRUE),
    mean_num_urm = mean(num_urm, na.rm = TRUE),
    prop_has_urm = mean(has_any_urm, na.rm = TRUE),
    
    # Black stats
    mean_pct_black = mean(pct_black, na.rm = TRUE),
    mean_num_black = mean(num_black, na.rm = TRUE),
    prop_has_black = mean(has_any_black, na.rm = TRUE),
    
    # Hispanic stats
    mean_pct_hispanic = mean(pct_hispanic, na.rm = TRUE),
    mean_num_hispanic = mean(num_hispanic, na.rm = TRUE),
    prop_has_hispanic = mean(has_any_hispanic, na.rm = TRUE),
    
    # Female stats
    mean_pct_female = mean(pct_female, na.rm = TRUE),
    mean_num_female = mean(num_female, na.rm = TRUE),
    prop_has_female = mean(has_any_female, na.rm = TRUE),
    
    .groups = 'drop'
  ) %>%
  arrange(discipline)

# Create formatted table for basic info
cat("\n\\begin{table}[H]\n")
cat("\\caption{Seminar Statistics by Discipline}\n")
cat("\\label{tab:summary_disc_basic}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lcccc}\n")
cat("\\toprule\n")
cat("Discipline & N Seminars & N Depts & Mean Speakers & SD Speakers \\\\\n")
cat("\\midrule\n")
for (i in 1:nrow(summary_by_disc_seminars)) {
  cat(sprintf("%s & %d & %d & %.1f & %.1f \\\\\n",
              summary_by_disc_seminars$discipline[i],
              summary_by_disc_seminars$n_seminars[i],
              summary_by_disc_seminars$n_departments[i],
              summary_by_disc_seminars$mean_speakers_per_seminar[i],
              summary_by_disc_seminars$sd_speakers_per_seminar[i]))
}
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\end{table}\n")

# Create formatted table for URM
cat("\n\\begin{table}[H]\n")
cat("\\caption{Seminar Speaker Demographics by Discipline: URM}\n")
cat("\\label{tab:summary_disc_urm}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccc}\n")
cat("\\toprule\n")
cat("Discipline & N Seminars & Mean \\% & SD \\% & Mean Count & Prop. Has Any \\\\\n")
cat("\\midrule\n")
for (i in 1:nrow(summary_by_disc_seminars)) {
  cat(sprintf("%s & %d & %.2f & %.2f & %.2f & %.3f \\\\\n",
              summary_by_disc_seminars$discipline[i],
              summary_by_disc_seminars$n_seminars[i],
              summary_by_disc_seminars$mean_pct_urm[i],
              summary_by_disc_seminars$sd_pct_urm[i],
              summary_by_disc_seminars$mean_num_urm[i],
              summary_by_disc_seminars$prop_has_urm[i]))
}
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\footnotesize{Note: Statistics are for seminar speakers. 'Prop. Has Any' indicates proportion of seminars with at least one URM speaker.}\n")
cat("\\end{table}\n")

# Create formatted table for other demographics
cat("\n\\begin{table}[H]\n")
cat("\\caption{Seminar Speaker Demographics by Discipline: Other Groups}\n")
cat("\\label{tab:summary_disc_other}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lcccccc}\n")
cat("\\toprule\n")
cat(" & \\multicolumn{2}{c}{Black} & \\multicolumn{2}{c}{Hispanic} & \\multicolumn{2}{c}{Female} \\\\\n")
cat("Discipline & Mean \\% & Prop. Any & Mean \\% & Prop. Any & Mean \\% & Prop. Any \\\\\n")
cat("\\midrule\n")
for (i in 1:nrow(summary_by_disc_seminars)) {
  cat(sprintf("%s & %.2f & %.3f & %.2f & %.3f & %.2f & %.3f \\\\\n",
              summary_by_disc_seminars$discipline[i],
              summary_by_disc_seminars$mean_pct_black[i],
              summary_by_disc_seminars$prop_has_black[i],
              summary_by_disc_seminars$mean_pct_hispanic[i],
              summary_by_disc_seminars$prop_has_hispanic[i],
              summary_by_disc_seminars$mean_pct_female[i],
              summary_by_disc_seminars$prop_has_female[i]))
}
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\footnotesize{Note: Statistics are for seminar speakers. 'Prop. Any' indicates proportion of seminars with at least one speaker from that group.}\n")
cat("\\end{table}\n")
```

### Department Faculty Demographics by Discipline

```{r summary-stats-discipline-departments}
# Department faculty demographics by discipline
dept_by_disc <- data %>%
  mutate(discipline = case_when(
    disc_mathematics == 1 ~ "Mathematics",
    disc_physics == 1 ~ "Physics",
    disc_computer_science == 1 ~ "Computer Science",
    disc_mechanical_engineering == 1 ~ "Mechanical Engineering",
    TRUE ~ "Chemistry"
  )) %>%
  group_by(discipline, department_std) %>%
  summarise(
    total_faculty = first(total_faculty),
    frac_urm_faculty = first(frac_urm_faculty),
    frac_women_faculty = first(frac_women_faculty),
    .groups = 'drop'
  ) %>%
  group_by(discipline) %>%
  summarise(
    n_departments = n(),
    mean_total_faculty = mean(total_faculty, na.rm = TRUE),
    sd_total_faculty = sd(total_faculty, na.rm = TRUE),
    mean_pct_urm_faculty = mean(frac_urm_faculty * 100, na.rm = TRUE),
    sd_pct_urm_faculty = sd(frac_urm_faculty * 100, na.rm = TRUE),
    mean_pct_women_faculty = mean(frac_women_faculty * 100, na.rm = TRUE),
    sd_pct_women_faculty = sd(frac_women_faculty * 100, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  arrange(discipline)

# Create department faculty table
cat("\n\\begin{table}[H]\n")
cat("\\caption{Department Faculty Demographics by Discipline}\n")
cat("\\label{tab:summary_disc_dept_faculty}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lcccccc}\n")
cat("\\toprule\n")
cat(" & & \\multicolumn{2}{c}{Faculty Size} & \\multicolumn{2}{c}{\\% URM Faculty} & \\multicolumn{2}{c}{\\% Women Faculty} \\\\\n")
cat("Discipline & N Depts & Mean & SD & Mean & SD & Mean & SD \\\\\n")
cat("\\midrule\n")
for (i in 1:nrow(dept_by_disc)) {
  cat(sprintf("%s & %d & %.1f & %.1f & %.2f & %.2f & %.2f & %.2f \\\\\n",
              dept_by_disc$discipline[i],
              dept_by_disc$n_departments[i],
              dept_by_disc$mean_total_faculty[i],
              dept_by_disc$sd_total_faculty[i],
              dept_by_disc$mean_pct_urm_faculty[i],
              dept_by_disc$sd_pct_urm_faculty[i],
              dept_by_disc$mean_pct_women_faculty[i],
              dept_by_disc$sd_pct_women_faculty[i]))
}
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\footnotesize{Note: Department faculty demographics based on 2024 coding.}\n")
cat("\\end{table}\n")
```

## Summary Statistics by Semester

```{r summary-stats-semester}
# Fall semester statistics
fall_summary <- data %>%
  filter(has_fall_speakers == 1) %>%
  summarise(
    n = n(),
    mean_pct_urm = mean(fall_pct_urm, na.rm = TRUE),
    sd_pct_urm = sd(fall_pct_urm, na.rm = TRUE),
    mean_num_urm = mean(fall_num_urm, na.rm = TRUE),
    prop_has_urm = mean(fall_has_any_urm, na.rm = TRUE),
    mean_pct_black = mean(fall_pct_black, na.rm = TRUE),
    prop_has_black = mean(fall_has_any_black, na.rm = TRUE),
    mean_pct_hispanic = mean(fall_pct_hispanic, na.rm = TRUE),
    prop_has_hispanic = mean(fall_has_any_hispanic, na.rm = TRUE),
    mean_pct_female = mean(fall_pct_female, na.rm = TRUE),
    mean_num_female = mean(fall_num_female, na.rm = TRUE),
    prop_has_female = mean(fall_has_any_female, na.rm = TRUE),
    mean_total = mean(fall_total_speakers, na.rm = TRUE)
  )

# Spring semester statistics
spring_summary <- data %>%
  filter(has_spring_speakers == 1) %>%
  summarise(
    n = n(),
    mean_pct_urm = mean(spring_pct_urm, na.rm = TRUE),
    sd_pct_urm = sd(spring_pct_urm, na.rm = TRUE),
    mean_num_urm = mean(spring_num_urm, na.rm = TRUE),
    prop_has_urm = mean(spring_has_any_urm, na.rm = TRUE),
    mean_pct_black = mean(spring_pct_black, na.rm = TRUE),
    prop_has_black = mean(spring_has_any_black, na.rm = TRUE),
    mean_pct_hispanic = mean(spring_pct_hispanic, na.rm = TRUE),
    prop_has_hispanic = mean(spring_has_any_hispanic, na.rm = TRUE),
    mean_pct_female = mean(spring_pct_female, na.rm = TRUE),
    mean_num_female = mean(spring_num_female, na.rm = TRUE),
    prop_has_female = mean(spring_has_any_female, na.rm = TRUE),
    mean_total = mean(spring_total_speakers, na.rm = TRUE)
  )

# Create formatted table
cat("\n\\begin{table}[H]\n")
cat("\\caption{Summary Statistics by Semester}\n")
cat("\\label{tab:summary_semester}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccccc}\n")
cat("\\toprule\n")
cat(" & \\multicolumn{3}{c}{URM} & \\multicolumn{2}{c}{Black} & \\multicolumn{2}{c}{Hispanic} \\\\\n")
cat("Semester (N) & Mean \\% & Mean Count & Prop. Any & Mean \\% & Prop. Any & Mean \\% & Prop. Any \\\\\n")
cat("\\midrule\n")
cat(sprintf("Fall (%d) & %.2f & %.2f & %.3f & %.2f & %.3f & %.2f & %.3f \\\\\n",
            fall_summary$n,
            fall_summary$mean_pct_urm,
            fall_summary$mean_num_urm,
            fall_summary$prop_has_urm,
            fall_summary$mean_pct_black,
            fall_summary$prop_has_black,
            fall_summary$mean_pct_hispanic,
            fall_summary$prop_has_hispanic))
cat(sprintf("Spring (%d) & %.2f & %.2f & %.3f & %.2f & %.3f & %.2f & %.3f \\\\\n",
            spring_summary$n,
            spring_summary$mean_pct_urm,
            spring_summary$mean_num_urm,
            spring_summary$prop_has_urm,
            spring_summary$mean_pct_black,
            spring_summary$prop_has_black,
            spring_summary$mean_pct_hispanic,
            spring_summary$prop_has_hispanic))
cat("\\midrule\n")
cat(" & \\multicolumn{3}{c}{Female} & \\multicolumn{2}{c}{Total Speakers} & & \\\\\n")
cat("Semester & Mean \\% & Mean Count & Prop. Any & Mean & SD & & \\\\\n")
cat("\\midrule\n")
cat(sprintf("Fall & %.2f & %.2f & %.3f & %.2f & --- & & \\\\\n",
            fall_summary$mean_pct_female,
            fall_summary$mean_num_female,
            fall_summary$prop_has_female,
            fall_summary$mean_total))
cat(sprintf("Spring & %.2f & %.2f & %.3f & %.2f & --- & & \\\\\n",
            spring_summary$mean_pct_female,
            spring_summary$mean_num_female,
            spring_summary$prop_has_female,
            spring_summary$mean_total))
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\end{table}\n")
```

\newpage

# Main Effects Analysis

## Main Question 1: URM Speaker Representation

```{r mq1-urm}
# MQ1: URM percentage, count, and binary
# Model 1 - Basic controls
pct_urm_m1 <- run_regression(paste("pct_urm ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_urm_m1 <- run_regression(paste("num_urm ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_urm_m1 <- run_regression(paste("has_any_urm ~ treatment +", paste(base_controls, collapse = " + ")), data)

# Model 2 - Extended controls
pct_urm_m2 <- run_regression(paste("pct_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_urm_m2 <- run_regression(paste("num_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_urm_m2 <- run_regression(paste("has_any_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_urm_m1, analysis = "Main Effects", outcome = "% URM", model_type = "Simple"),
  list(model = pct_urm_m2, analysis = "Main Effects", outcome = "% URM", model_type = "Extended"),
  list(model = count_urm_m1, analysis = "Main Effects", outcome = "Count URM", model_type = "Simple"),
  list(model = count_urm_m2, analysis = "Main Effects", outcome = "Count URM", model_type = "Extended"),
  list(model = binary_urm_m1, analysis = "Main Effects", outcome = "Any URM", model_type = "Simple"),
  list(model = binary_urm_m2, analysis = "Main Effects", outcome = "Any URM", model_type = "Extended")
))

create_stargazer_table(
  list(pct_urm_m1, pct_urm_m2, count_urm_m1, count_urm_m2, binary_urm_m1, binary_urm_m2),
  c("\\% URM", "\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Main Question 1: Effect on URM Speaker Representation",
  "tab:mq1_urm",
  demographic_group = "URM"
)
```

\newpage

## Main Questions 2a-2c: Effects on Speaker Counts

```{r mq2-all}
# MQ2a: Total speakers
count_total_m1 <- run_regression(paste("total_speakers ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_total_m2 <- run_regression(paste("total_speakers ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# MQ2b: URM speakers (count)
count_urm_m1 <- run_regression(paste("num_urm ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_urm_m2 <- run_regression(paste("num_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# MQ2c: Non-URM speakers
count_non_urm_m1 <- run_regression(paste("num_non_urm ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_non_urm_m2 <- run_regression(paste("num_non_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = count_total_m1, analysis = "Main Effects", outcome = "Total Speakers", model_type = "Simple"),
  list(model = count_total_m2, analysis = "Main Effects", outcome = "Total Speakers", model_type = "Extended"),
  list(model = count_urm_m1, analysis = "Main Effects", outcome = "Count URM", model_type = "Simple"),
  list(model = count_urm_m2, analysis = "Main Effects", outcome = "Count URM", model_type = "Extended"),
  list(model = count_non_urm_m1, analysis = "Main Effects", outcome = "Count Non-URM", model_type = "Simple"),
  list(model = count_non_urm_m2, analysis = "Main Effects", outcome = "Count Non-URM", model_type = "Extended")
))

# Combined table
create_stargazer_table(
  list(count_total_m1, count_total_m2, count_urm_m1, count_urm_m2, count_non_urm_m1, count_non_urm_m2),
  c("Total", "Total", "URM", "URM", "Non-URM", "Non-URM"),
  "Main Questions 2a-2c: Effects on Speaker Counts",
  "tab:mq2_all",
  demographic_group = "Count"
)
```

## Seemingly Unrelated Regression (SUR) Analysis

```{r sur-analysis}
# SUR to test whether effects on URM and non-URM speakers are equal and opposite
# Per pre-registration: test if treatment increases URM at expense of non-URM

# Function to safely run SUR with error handling
run_sur_analysis <- function(data, base_controls, extended_controls) {
  
  tryCatch({
    # Prepare equations for SUR
    # Model 1 - Basic controls
    eq1_m1 <- as.formula(paste("num_urm ~ treatment +", paste(base_controls, collapse = " + ")))
    eq2_m1 <- as.formula(paste("num_non_urm ~ treatment +", paste(base_controls, collapse = " + ")))
    
    # Model 2 - Extended controls
    eq1_m2 <- as.formula(paste("num_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")))
    eq2_m2 <- as.formula(paste("num_non_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")))
    
    # Run SUR models with control for method
    sur_m1 <- systemfit(list(URM = eq1_m1, NonURM = eq2_m1), 
                       method = "SUR", 
                       data = data,
                       control = systemfit.control(tol = 1e-5))
    
    sur_m2 <- systemfit(list(URM = eq1_m2, NonURM = eq2_m2), 
                       method = "SUR", 
                       data = data,
                       control = systemfit.control(tol = 1e-5))
    
    # Test whether treatment effects are equal and opposite
    # H0: b1_URM + b1_NonURM = 0 (effects sum to zero)
    # H1: b1_URM + b1_NonURM ≠ 0
    
    # For Model 1
    test_m1 <- linearHypothesis(sur_m1, "URM_treatment + NonURM_treatment = 0")
    # For Model 2  
    test_m2 <- linearHypothesis(sur_m2, "URM_treatment + NonURM_treatment = 0")
    
    # Extract coefficients and SEs
    urm_coef_m1 <- coef(sur_m1$eq[[1]])["treatment"]
    urm_se_m1 <- sqrt(diag(vcov(sur_m1$eq[[1]]))["treatment"])
    non_urm_coef_m1 <- coef(sur_m1$eq[[2]])["treatment"]
    non_urm_se_m1 <- sqrt(diag(vcov(sur_m1$eq[[2]]))["treatment"])
    
    urm_coef_m2 <- coef(sur_m2$eq[[1]])["treatment"]
    urm_se_m2 <- sqrt(diag(vcov(sur_m2$eq[[1]]))["treatment"])
    non_urm_coef_m2 <- coef(sur_m2$eq[[2]])["treatment"]
    non_urm_se_m2 <- sqrt(diag(vcov(sur_m2$eq[[2]]))["treatment"])
    
    return(list(
      success = TRUE,
      urm_coef_m1 = urm_coef_m1, urm_se_m1 = urm_se_m1,
      non_urm_coef_m1 = non_urm_coef_m1, non_urm_se_m1 = non_urm_se_m1,
      urm_coef_m2 = urm_coef_m2, urm_se_m2 = urm_se_m2,
      non_urm_coef_m2 = non_urm_coef_m2, non_urm_se_m2 = non_urm_se_m2,
      test_m1 = test_m1, test_m2 = test_m2
    ))
    
  }, error = function(e) {
    # If SUR fails, fall back to individual OLS estimates
    # These are already computed above as count_urm_m1, count_urm_m2, etc.
    
    # Extract coefficients from individual models
    urm_coef_m1 <- coef(count_urm_m1)["treatment"]
    urm_se_m1 <- count_urm_m1$cluster_se["treatment"]
    non_urm_coef_m1 <- coef(count_non_urm_m1)["treatment"]
    non_urm_se_m1 <- count_non_urm_m1$cluster_se["treatment"]
    
    urm_coef_m2 <- coef(count_urm_m2)["treatment"]
    urm_se_m2 <- count_urm_m2$cluster_se["treatment"]
    non_urm_coef_m2 <- coef(count_non_urm_m2)["treatment"]
    non_urm_se_m2 <- count_non_urm_m2$cluster_se["treatment"]
    
    return(list(
      success = FALSE,
      error_msg = e$message,
      urm_coef_m1 = urm_coef_m1, urm_se_m1 = urm_se_m1,
      non_urm_coef_m1 = non_urm_coef_m1, non_urm_se_m1 = non_urm_se_m1,
      urm_coef_m2 = urm_coef_m2, urm_se_m2 = urm_se_m2,
      non_urm_coef_m2 = non_urm_coef_m2, non_urm_se_m2 = non_urm_se_m2,
      test_m1 = NULL, test_m2 = NULL
    ))
  })
}

# Run the analysis
sur_results <- run_sur_analysis(data, base_controls, extended_controls)

# Create summary table
cat("\n\\begin{table}[H]\n")
cat("\\caption{SUR Analysis: Testing Substitution Between URM and Non-URM Speakers}\n")
cat("\\label{tab:sur_analysis}\n")
cat("\\centering\n")
cat("\\begin{tabular}{lcccc}\n")
cat("\\toprule\n")
cat(" & \\multicolumn{2}{c}{Simple Model} & \\multicolumn{2}{c}{Extended Model} \\\\\n")
cat("Outcome & Coefficient & SE & Coefficient & SE \\\\\n")
cat("\\midrule\n")

cat(sprintf("URM Speakers & %.4f & (%.4f) & %.4f & (%.4f) \\\\\n",
            sur_results$urm_coef_m1, sur_results$urm_se_m1, 
            sur_results$urm_coef_m2, sur_results$urm_se_m2))
cat(sprintf("Non-URM Speakers & %.4f & (%.4f) & %.4f & (%.4f) \\\\\n",
            sur_results$non_urm_coef_m1, sur_results$non_urm_se_m1, 
            sur_results$non_urm_coef_m2, sur_results$non_urm_se_m2))
cat("\\midrule\n")
cat(sprintf("Sum of Effects & %.4f & --- & %.4f & --- \\\\\n",
            sur_results$urm_coef_m1 + sur_results$non_urm_coef_m1,
            sur_results$urm_coef_m2 + sur_results$non_urm_coef_m2))

if (sur_results$success && !is.null(sur_results$test_m1)) {
  cat("\\midrule\n")
  cat("\\multicolumn{5}{l}{\\textit{Wald Test: H0: Treatment effect on URM + Treatment effect on Non-URM = 0}} \\\\\n")
  cat(sprintf("Chi-squared & %.3f & & %.3f & \\\\\n", 
              sur_results$test_m1$Chisq[2], 
              sur_results$test_m2$Chisq[2]))
  cat(sprintf("p-value & %.4f & & %.4f & \\\\\n", 
              sur_results$test_m1$`Pr(>Chisq)`[2], 
              sur_results$test_m2$`Pr(>Chisq)`[2]))
} else {
  cat("\\midrule\n")
  cat("\\multicolumn{5}{l}{\\textit{Note: SUR estimation failed; showing OLS estimates with clustered SEs}} \\\\\n")
  # Can still test sum = 0 informally
  sum_m1 <- sur_results$urm_coef_m1 + sur_results$non_urm_coef_m1
  sum_m2 <- sur_results$urm_coef_m2 + sur_results$non_urm_coef_m2
  cat(sprintf("\\multicolumn{5}{l}{\\textit{Sum close to zero: Model 1 = %.4f, Model 2 = %.4f}} \\\\\n",
              sum_m1, sum_m2))
}

cat("\\bottomrule\n")
cat("\\end{tabular}\n")

if (sur_results$success) {
  cat("\\footnotesize{Note: SUR estimation allows for correlation between equation errors. The Wald test examines whether the treatment effect represents a pure substitution (increasing URM speakers while decreasing non-URM speakers by the same amount).}\n")
} else {
  cat("\\footnotesize{Note: SUR estimation failed due to computational issues (likely multicollinearity). Table shows OLS estimates with clustered standard errors. The sum of effects being close to zero suggests a substitution pattern even without formal SUR testing.}\n")
}
cat("\\end{table}\n")
```

\newpage

# Demographic Subgroup Analysis

## Black Speakers

```{r black-speakers}
# Black speakers
pct_black_m1 <- run_regression(paste("pct_black ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_black_m1 <- run_regression(paste("num_black ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_black_m1 <- run_regression(paste("has_any_black ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_black_m2 <- run_regression(paste("pct_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_black_m2 <- run_regression(paste("num_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_black_m2 <- run_regression(paste("has_any_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_black_m1, analysis = "Demographic Subgroup", outcome = "% Black", model_type = "Simple"),
  list(model = pct_black_m2, analysis = "Demographic Subgroup", outcome = "% Black", model_type = "Extended"),
  list(model = count_black_m1, analysis = "Demographic Subgroup", outcome = "Count Black", model_type = "Simple"),
  list(model = count_black_m2, analysis = "Demographic Subgroup", outcome = "Count Black", model_type = "Extended"),
  list(model = binary_black_m1, analysis = "Demographic Subgroup", outcome = "Any Black", model_type = "Simple"),
  list(model = binary_black_m2, analysis = "Demographic Subgroup", outcome = "Any Black", model_type = "Extended")
))

create_stargazer_table(
  list(pct_black_m1, pct_black_m2, count_black_m1, count_black_m2, binary_black_m1, binary_black_m2),
  c("\\% Black", "\\% Black", "Count Black", "Count Black", "Any Black", "Any Black"),
  "Effect on Black Speakers",
  "tab:black",
  demographic_group = "Black"
)
```

## Hispanic Speakers

```{r hispanic-speakers}
# Hispanic speakers
pct_hispanic_m1 <- run_regression(paste("pct_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_hispanic_m1 <- run_regression(paste("num_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_hispanic_m1 <- run_regression(paste("has_any_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_hispanic_m2 <- run_regression(paste("pct_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_hispanic_m2 <- run_regression(paste("num_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_hispanic_m2 <- run_regression(paste("has_any_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_hispanic_m1, analysis = "Demographic Subgroup", outcome = "% Hispanic", model_type = "Simple"),
  list(model = pct_hispanic_m2, analysis = "Demographic Subgroup", outcome = "% Hispanic", model_type = "Extended"),
  list(model = count_hispanic_m1, analysis = "Demographic Subgroup", outcome = "Count Hispanic", model_type = "Simple"),
  list(model = count_hispanic_m2, analysis = "Demographic Subgroup", outcome = "Count Hispanic", model_type = "Extended"),
  list(model = binary_hispanic_m1, analysis = "Demographic Subgroup", outcome = "Any Hispanic", model_type = "Simple"),
  list(model = binary_hispanic_m2, analysis = "Demographic Subgroup", outcome = "Any Hispanic", model_type = "Extended")
))

create_stargazer_table(
  list(pct_hispanic_m1, pct_hispanic_m2, count_hispanic_m1, count_hispanic_m2, binary_hispanic_m1, binary_hispanic_m2),
  c("\\% Hispanic", "\\% Hispanic", "Count Hispanic", "Count Hispanic", "Any Hispanic", "Any Hispanic"),
  "Effect on Hispanic Speakers",
  "tab:hispanic",
  demographic_group = "Hispanic"
)
```

## Female Speakers

```{r female-speakers}
# Female speakers
pct_female_m1 <- run_regression(paste("pct_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_female_m1 <- run_regression(paste("num_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_female_m1 <- run_regression(paste("has_any_female ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_female_m2 <- run_regression(paste("pct_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_female_m2 <- run_regression(paste("num_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_female_m2 <- run_regression(paste("has_any_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_female_m1, analysis = "Demographic Subgroup", outcome = "% Female", model_type = "Simple"),
  list(model = pct_female_m2, analysis = "Demographic Subgroup", outcome = "% Female", model_type = "Extended"),
  list(model = count_female_m1, analysis = "Demographic Subgroup", outcome = "Count Female", model_type = "Simple"),
  list(model = count_female_m2, analysis = "Demographic Subgroup", outcome = "Count Female", model_type = "Extended"),
  list(model = binary_female_m1, analysis = "Demographic Subgroup", outcome = "Any Female", model_type = "Simple"),
  list(model = binary_female_m2, analysis = "Demographic Subgroup", outcome = "Any Female", model_type = "Extended")
))

create_stargazer_table(
  list(pct_female_m1, pct_female_m2, count_female_m1, count_female_m2, binary_female_m1, binary_female_m2),
  c("\\% Female", "\\% Female", "Count Female", "Count Female", "Any Female", "Any Female"),
  "Effect on Female Speakers",
  "tab:female",
  demographic_group = "Female"
)
```

## URM Female

```{r urm-female}
# URM-Female intersection
pct_urm_female_m1 <- run_regression(paste("pct_urm_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_urm_female_m1 <- run_regression(paste("approx_num_urm_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_urm_female_m1 <- run_regression(paste("has_any_urm_female ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_urm_female_m2 <- run_regression(paste("pct_urm_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_urm_female_m2 <- run_regression(paste("approx_num_urm_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_urm_female_m2 <- run_regression(paste("has_any_urm_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_urm_female_m1, analysis = "Demographic Subgroup", outcome = "% URM Female", model_type = "Simple"),
  list(model = pct_urm_female_m2, analysis = "Demographic Subgroup", outcome = "% URM Female", model_type = "Extended"),
  list(model = count_urm_female_m1, analysis = "Demographic Subgroup", outcome = "Count URM Female", model_type = "Simple"),
  list(model = count_urm_female_m2, analysis = "Demographic Subgroup", outcome = "Count URM Female", model_type = "Extended"),
  list(model = binary_urm_female_m1, analysis = "Demographic Subgroup", outcome = "Any URM Female", model_type = "Simple"),
  list(model = binary_urm_female_m2, analysis = "Demographic Subgroup", outcome = "Any URM Female", model_type = "Extended")
))

create_stargazer_table(
  list(pct_urm_female_m1, pct_urm_female_m2, count_urm_female_m1, count_urm_female_m2, binary_urm_female_m1, binary_urm_female_m2),
  c("\\% URM Female", "\\% URM Female", "Count URM Female", "Count URM Female", "Any URM Female", "Any URM Female"),
  "Effect on URM Female Speakers",
  "tab:urm_female",
  demographic_group = "URM Female"
)
```

## Black Female

```{r black-female}
# Black-Female intersection
pct_black_female_m1 <- run_regression(paste("pct_black_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_black_female_m1 <- run_regression(paste("approx_num_black_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_black_female_m1 <- run_regression(paste("has_any_black_female ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_black_female_m2 <- run_regression(paste("pct_black_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_black_female_m2 <- run_regression(paste("approx_num_black_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_black_female_m2 <- run_regression(paste("has_any_black_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_black_female_m1, analysis = "Demographic Subgroup", outcome = "% Black Female", model_type = "Simple"),
  list(model = pct_black_female_m2, analysis = "Demographic Subgroup", outcome = "% Black Female", model_type = "Extended"),
  list(model = count_black_female_m1, analysis = "Demographic Subgroup", outcome = "Count Black Female", model_type = "Simple"),
  list(model = count_black_female_m2, analysis = "Demographic Subgroup", outcome = "Count Black Female", model_type = "Extended"),
  list(model = binary_black_female_m1, analysis = "Demographic Subgroup", outcome = "Any Black Female", model_type = "Simple"),
  list(model = binary_black_female_m2, analysis = "Demographic Subgroup", outcome = "Any Black Female", model_type = "Extended")
))

create_stargazer_table(
  list(pct_black_female_m1, pct_black_female_m2, count_black_female_m1, count_black_female_m2, binary_black_female_m1, binary_black_female_m2),
  c("\\% Black Female", "\\% Black Female", "Count Black Female", "Count Black Female", "Any Black Female", "Any Black Female"),
  "Effect on Black Female Speakers",
  "tab:black_female",
  demographic_group = "Black Female"
)
```

## Black Male

```{r black-male}
# Black-Male intersection
pct_black_male_m1 <- run_regression(paste("pct_black_male ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_black_male_m1 <- run_regression(paste("approx_num_black_male ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_black_male_m1 <- run_regression(paste("has_any_black_male ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_black_male_m2 <- run_regression(paste("pct_black_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_black_male_m2 <- run_regression(paste("approx_num_black_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_black_male_m2 <- run_regression(paste("has_any_black_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_black_male_m1, analysis = "Demographic Subgroup", outcome = "% Black Male", model_type = "Simple"),
  list(model = pct_black_male_m2, analysis = "Demographic Subgroup", outcome = "% Black Male", model_type = "Extended"),
  list(model = count_black_male_m1, analysis = "Demographic Subgroup", outcome = "Count Black Male", model_type = "Simple"),
  list(model = count_black_male_m2, analysis = "Demographic Subgroup", outcome = "Count Black Male", model_type = "Extended"),
  list(model = binary_black_male_m1, analysis = "Demographic Subgroup", outcome = "Any Black Male", model_type = "Simple"),
  list(model = binary_black_male_m2, analysis = "Demographic Subgroup", outcome = "Any Black Male", model_type = "Extended")
))

create_stargazer_table(
  list(pct_black_male_m1, pct_black_male_m2, count_black_male_m1, count_black_male_m2, binary_black_male_m1, binary_black_male_m2),
  c("\\% Black Male", "\\% Black Male", "Count Black Male", "Count Black Male", "Any Black Male", "Any Black Male"),
  "Effect on Black Male Speakers",
  "tab:black_male",
  demographic_group = "Black Male"
)
```

## Hispanic Female

```{r hispanic-female}
# Hispanic-Female intersection
pct_hispanic_female_m1 <- run_regression(paste("pct_hispanic_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_hispanic_female_m1 <- run_regression(paste("approx_num_hispanic_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_hispanic_female_m1 <- run_regression(paste("has_any_hispanic_female ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_hispanic_female_m2 <- run_regression(paste("pct_hispanic_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_hispanic_female_m2 <- run_regression(paste("approx_num_hispanic_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_hispanic_female_m2 <- run_regression(paste("has_any_hispanic_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_hispanic_female_m1, analysis = "Demographic Subgroup", outcome = "% Hispanic Female", model_type = "Simple"),
  list(model = pct_hispanic_female_m2, analysis = "Demographic Subgroup", outcome = "% Hispanic Female", model_type = "Extended"),
  list(model = count_hispanic_female_m1, analysis = "Demographic Subgroup", outcome = "Count Hispanic Female", model_type = "Simple"),
  list(model = count_hispanic_female_m2, analysis = "Demographic Subgroup", outcome = "Count Hispanic Female", model_type = "Extended"),
  list(model = binary_hispanic_female_m1, analysis = "Demographic Subgroup", outcome = "Any Hispanic Female", model_type = "Simple"),
  list(model = binary_hispanic_female_m2, analysis = "Demographic Subgroup", outcome = "Any Hispanic Female", model_type = "Extended")
))

create_stargazer_table(
  list(pct_hispanic_female_m1, pct_hispanic_female_m2, count_hispanic_female_m1, count_hispanic_female_m2, binary_hispanic_female_m1, binary_hispanic_female_m2),
  c("\\% Hispanic Female", "\\% Hispanic Female", "Count Hispanic Female", "Count Hispanic Female", "Any Hispanic Female", "Any Hispanic Female"),
  "Effect on Hispanic Female Speakers",
  "tab:hispanic_female",
  demographic_group = "Hispanic Female"
)
```

## Hispanic Male

```{r hispanic-male}
# Hispanic-Male intersection
pct_hispanic_male_m1 <- run_regression(paste("pct_hispanic_male ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_hispanic_male_m1 <- run_regression(paste("approx_num_hispanic_male ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_hispanic_male_m1 <- run_regression(paste("has_any_hispanic_male ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_hispanic_male_m2 <- run_regression(paste("pct_hispanic_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_hispanic_male_m2 <- run_regression(paste("approx_num_hispanic_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_hispanic_male_m2 <- run_regression(paste("has_any_hispanic_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_hispanic_male_m1, analysis = "Demographic Subgroup", outcome = "% Hispanic Male", model_type = "Simple"),
  list(model = pct_hispanic_male_m2, analysis = "Demographic Subgroup", outcome = "% Hispanic Male", model_type = "Extended"),
  list(model = count_hispanic_male_m1, analysis = "Demographic Subgroup", outcome = "Count Hispanic Male", model_type = "Simple"),
  list(model = count_hispanic_male_m2, analysis = "Demographic Subgroup", outcome = "Count Hispanic Male", model_type = "Extended"),
  list(model = binary_hispanic_male_m1, analysis = "Demographic Subgroup", outcome = "Any Hispanic Male", model_type = "Simple"),
  list(model = binary_hispanic_male_m2, analysis = "Demographic Subgroup", outcome = "Any Hispanic Male", model_type = "Extended")
))

create_stargazer_table(
  list(pct_hispanic_male_m1, pct_hispanic_male_m2, count_hispanic_male_m1, count_hispanic_male_m2, binary_hispanic_male_m1, binary_hispanic_male_m2),
  c("\\% Hispanic Male", "\\% Hispanic Male", "Count Hispanic Male", "Count Hispanic Male", "Any Hispanic Male", "Any Hispanic Male"),
  "Effect on Hispanic Male Speakers",
  "tab:hispanic_male",
  demographic_group = "Hispanic Male"
)
```

\newpage

# Discipline Subgroup Analysis

```{r discipline-subgroup}
# Run main treatment effect models separately for each discipline
disciplines <- list(
  list("Chemistry", data %>% filter(disc_mathematics == 0 & disc_physics == 0 & 
                                    disc_computer_science == 0 & disc_mechanical_engineering == 0)),
  list("Mathematics", data %>% filter(disc_mathematics == 1)),
  list("Physics", data %>% filter(disc_physics == 1)),
  list("Computer Science", data %>% filter(disc_computer_science == 1)),
  list("Mechanical Engineering", data %>% filter(disc_mechanical_engineering == 1))
)

# Store results for each discipline
discipline_results <- list()

for (disc_info in disciplines) {
  disc_name <- disc_info[[1]]
  disc_data <- disc_info[[2]]
  
  cat("\n### ", disc_name, " (N=", nrow(disc_data), ")\n\n", sep="")
  
  # Run models for this discipline
  if (nrow(disc_data) >= 30) {
    # Percentage models
    pct_m1 <- run_regression(paste("pct_urm ~ treatment +", paste(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  collapse = " + ")), disc_data)
    pct_m2 <- run_regression(paste("pct_urm ~ treatment +", paste(c(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  extended_controls), collapse = " + ")), disc_data)
    
    # Count models
    count_m1 <- run_regression(paste("num_urm ~ treatment +", paste(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    collapse = " + ")), disc_data)
    count_m2 <- run_regression(paste("num_urm ~ treatment +", paste(c(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    extended_controls), collapse = " + ")), disc_data)
    
    # Binary models
    binary_m1 <- run_regression(paste("has_any_urm ~ treatment +", paste(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     collapse = " + ")), disc_data)
    binary_m2 <- run_regression(paste("has_any_urm ~ treatment +", paste(c(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     extended_controls), collapse = " + ")), disc_data)
    
    # Create table for this discipline - URM
    create_stargazer_table(
      list(pct_m1, pct_m2, count_m1, count_m2, binary_m1, binary_m2),
      c("\\% URM", "\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
      paste(disc_name, ": Effect on URM Speaker Representation"),
      paste0("tab:discipline_", tolower(gsub(" ", "_", disc_name)), "_urm"),
      demographic_group = "URM"
    )
    
    # Store results
    discipline_results[[disc_name]] <- list(
      pct_m1 = pct_m1, pct_m2 = pct_m2,
      count_m1 = count_m1, count_m2 = count_m2,
      binary_m1 = binary_m1, binary_m2 = binary_m2
    )
    
    # Add to models list for significant results extraction
    all_models_list <- append(all_models_list, list(
      list(model = pct_m1, analysis = paste("Discipline:", disc_name), outcome = "% URM", model_type = "Simple"),
      list(model = pct_m2, analysis = paste("Discipline:", disc_name), outcome = "% URM", model_type = "Extended"),
      list(model = count_m1, analysis = paste("Discipline:", disc_name), outcome = "Count URM", model_type = "Simple"),
      list(model = count_m2, analysis = paste("Discipline:", disc_name), outcome = "Count URM", model_type = "Extended"),
      list(model = binary_m1, analysis = paste("Discipline:", disc_name), outcome = "Any URM", model_type = "Simple"),
      list(model = binary_m2, analysis = paste("Discipline:", disc_name), outcome = "Any URM", model_type = "Extended")
    ))
    
    # Black Analysis for this discipline
    pct_black_m1 <- run_regression(paste("pct_black ~ treatment +", paste(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  collapse = " + ")), disc_data)
    pct_black_m2 <- run_regression(paste("pct_black ~ treatment +", paste(c(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  extended_controls), collapse = " + ")), disc_data)
    
    count_black_m1 <- run_regression(paste("num_black ~ treatment +", paste(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    collapse = " + ")), disc_data)
    count_black_m2 <- run_regression(paste("num_black ~ treatment +", paste(c(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    extended_controls), collapse = " + ")), disc_data)
    
    binary_black_m1 <- run_regression(paste("has_any_black ~ treatment +", paste(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     collapse = " + ")), disc_data)
    binary_black_m2 <- run_regression(paste("has_any_black ~ treatment +", paste(c(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     extended_controls), collapse = " + ")), disc_data)
    
    # Create table for Black speakers
    create_stargazer_table(
      list(pct_black_m1, pct_black_m2, count_black_m1, count_black_m2, binary_black_m1, binary_black_m2),
      c("\\% Black", "\\% Black", "Count Black", "Count Black", "Any Black", "Any Black"),
      paste(disc_name, ": Effect on Black Speaker Representation"),
      paste0("tab:discipline_", tolower(gsub(" ", "_", disc_name)), "_black"),
      demographic_group = "Black"
    )
    
    # Add Black models to models list
    all_models_list <- append(all_models_list, list(
      list(model = pct_black_m1, analysis = paste("Discipline:", disc_name), outcome = "% Black", model_type = "Simple"),
      list(model = pct_black_m2, analysis = paste("Discipline:", disc_name), outcome = "% Black", model_type = "Extended"),
      list(model = count_black_m1, analysis = paste("Discipline:", disc_name), outcome = "Count Black", model_type = "Simple"),
      list(model = count_black_m2, analysis = paste("Discipline:", disc_name), outcome = "Count Black", model_type = "Extended"),
      list(model = binary_black_m1, analysis = paste("Discipline:", disc_name), outcome = "Any Black", model_type = "Simple"),
      list(model = binary_black_m2, analysis = paste("Discipline:", disc_name), outcome = "Any Black", model_type = "Extended")
    ))
    
    # Hispanic Analysis for this discipline
    pct_hispanic_m1 <- run_regression(paste("pct_hispanic ~ treatment +", paste(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  collapse = " + ")), disc_data)
    pct_hispanic_m2 <- run_regression(paste("pct_hispanic ~ treatment +", paste(c(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  extended_controls), collapse = " + ")), disc_data)
    
    count_hispanic_m1 <- run_regression(paste("num_hispanic ~ treatment +", paste(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    collapse = " + ")), disc_data)
    count_hispanic_m2 <- run_regression(paste("num_hispanic ~ treatment +", paste(c(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    extended_controls), collapse = " + ")), disc_data)
    
    binary_hispanic_m1 <- run_regression(paste("has_any_hispanic ~ treatment +", paste(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     collapse = " + ")), disc_data)
    binary_hispanic_m2 <- run_regression(paste("has_any_hispanic ~ treatment +", paste(c(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     extended_controls), collapse = " + ")), disc_data)
    
    # Create table for Hispanic speakers
    create_stargazer_table(
      list(pct_hispanic_m1, pct_hispanic_m2, count_hispanic_m1, count_hispanic_m2, binary_hispanic_m1, binary_hispanic_m2),
      c("\\% Hispanic", "\\% Hispanic", "Count Hispanic", "Count Hispanic", "Any Hispanic", "Any Hispanic"),
      paste(disc_name, ": Effect on Hispanic Speaker Representation"),
      paste0("tab:discipline_", tolower(gsub(" ", "_", disc_name)), "_hispanic"),
      demographic_group = "Hispanic"
    )
    
    # Add Hispanic models to models list
    all_models_list <- append(all_models_list, list(
      list(model = pct_hispanic_m1, analysis = paste("Discipline:", disc_name), outcome = "% Hispanic", model_type = "Simple"),
      list(model = pct_hispanic_m2, analysis = paste("Discipline:", disc_name), outcome = "% Hispanic", model_type = "Extended"),
      list(model = count_hispanic_m1, analysis = paste("Discipline:", disc_name), outcome = "Count Hispanic", model_type = "Simple"),
      list(model = count_hispanic_m2, analysis = paste("Discipline:", disc_name), outcome = "Count Hispanic", model_type = "Extended"),
      list(model = binary_hispanic_m1, analysis = paste("Discipline:", disc_name), outcome = "Any Hispanic", model_type = "Simple"),
      list(model = binary_hispanic_m2, analysis = paste("Discipline:", disc_name), outcome = "Any Hispanic", model_type = "Extended")
    ))
  } else {
    cat("Insufficient observations for regression analysis in", disc_name, "\n\n")
  }
}
```

\newpage

# Semester-Specific Analysis

## Fall Semester

```{r fall-semester}
# Fall semester analysis
data_fall <- data %>% filter(has_fall_speakers == 1)

pct_fall_urm_m1 <- run_regression(paste("fall_pct_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
count_fall_urm_m1 <- run_regression(paste("fall_num_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
binary_fall_urm_m1 <- run_regression(paste("fall_has_any_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)

pct_fall_urm_m2 <- run_regression(paste("fall_pct_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
count_fall_urm_m2 <- run_regression(paste("fall_num_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
binary_fall_urm_m2 <- run_regression(paste("fall_has_any_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_fall_urm_m1, analysis = "Fall Semester", outcome = "% URM", model_type = "Simple"),
  list(model = pct_fall_urm_m2, analysis = "Fall Semester", outcome = "% URM", model_type = "Extended"),
  list(model = count_fall_urm_m1, analysis = "Fall Semester", outcome = "Count URM", model_type = "Simple"),
  list(model = count_fall_urm_m2, analysis = "Fall Semester", outcome = "Count URM", model_type = "Extended"),
  list(model = binary_fall_urm_m1, analysis = "Fall Semester", outcome = "Any URM", model_type = "Simple"),
  list(model = binary_fall_urm_m2, analysis = "Fall Semester", outcome = "Any URM", model_type = "Extended")
))

create_stargazer_table(
  list(pct_fall_urm_m1, pct_fall_urm_m2, count_fall_urm_m1, count_fall_urm_m2, binary_fall_urm_m1, binary_fall_urm_m2),
  c("\\% URM", "\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Fall Semester: Effect on URM Speakers",
  "tab:fall_urm",
  demographic_group = "URM"
)

# Black Analysis
pct_fall_black_m1 <- run_regression(paste("fall_pct_black ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
count_fall_black_m1 <- run_regression(paste("fall_num_black ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
binary_fall_black_m1 <- run_regression(paste("fall_has_any_black ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)

pct_fall_black_m2 <- run_regression(paste("fall_pct_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
count_fall_black_m2 <- run_regression(paste("fall_num_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
binary_fall_black_m2 <- run_regression(paste("fall_has_any_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_fall_black_m1, analysis = "Fall Semester", outcome = "% Black", model_type = "Simple"),
  list(model = pct_fall_black_m2, analysis = "Fall Semester", outcome = "% Black", model_type = "Extended"),
  list(model = count_fall_black_m1, analysis = "Fall Semester", outcome = "Count Black", model_type = "Simple"),
  list(model = count_fall_black_m2, analysis = "Fall Semester", outcome = "Count Black", model_type = "Extended"),
  list(model = binary_fall_black_m1, analysis = "Fall Semester", outcome = "Any Black", model_type = "Simple"),
  list(model = binary_fall_black_m2, analysis = "Fall Semester", outcome = "Any Black", model_type = "Extended")
))

create_stargazer_table(
  list(pct_fall_black_m1, pct_fall_black_m2, count_fall_black_m1, count_fall_black_m2, binary_fall_black_m1, binary_fall_black_m2),
  c("\\% Black", "\\% Black", "Count Black", "Count Black", "Any Black", "Any Black"),
  "Fall Semester: Effect on Black Speakers",
  "tab:fall_black",
  demographic_group = "Black"
)

# Hispanic Analysis
pct_fall_hispanic_m1 <- run_regression(paste("fall_pct_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
count_fall_hispanic_m1 <- run_regression(paste("fall_num_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
binary_fall_hispanic_m1 <- run_regression(paste("fall_has_any_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)

pct_fall_hispanic_m2 <- run_regression(paste("fall_pct_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
count_fall_hispanic_m2 <- run_regression(paste("fall_num_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
binary_fall_hispanic_m2 <- run_regression(paste("fall_has_any_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_fall_hispanic_m1, analysis = "Fall Semester", outcome = "% Hispanic", model_type = "Simple"),
  list(model = pct_fall_hispanic_m2, analysis = "Fall Semester", outcome = "% Hispanic", model_type = "Extended"),
  list(model = count_fall_hispanic_m1, analysis = "Fall Semester", outcome = "Count Hispanic", model_type = "Simple"),
  list(model = count_fall_hispanic_m2, analysis = "Fall Semester", outcome = "Count Hispanic", model_type = "Extended"),
  list(model = binary_fall_hispanic_m1, analysis = "Fall Semester", outcome = "Any Hispanic", model_type = "Simple"),
  list(model = binary_fall_hispanic_m2, analysis = "Fall Semester", outcome = "Any Hispanic", model_type = "Extended")
))

create_stargazer_table(
  list(pct_fall_hispanic_m1, pct_fall_hispanic_m2, count_fall_hispanic_m1, count_fall_hispanic_m2, binary_fall_hispanic_m1, binary_fall_hispanic_m2),
  c("\\% Hispanic", "\\% Hispanic", "Count Hispanic", "Count Hispanic", "Any Hispanic", "Any Hispanic"),
  "Fall Semester: Effect on Hispanic Speakers",
  "tab:fall_hispanic",
  demographic_group = "Hispanic"
)
```

## Spring Semester

```{r spring-semester}
# Spring semester analysis
data_spring <- data %>% filter(has_spring_speakers == 1)

pct_spring_urm_m1 <- run_regression(paste("spring_pct_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
count_spring_urm_m1 <- run_regression(paste("spring_num_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
binary_spring_urm_m1 <- run_regression(paste("spring_has_any_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)

pct_spring_urm_m2 <- run_regression(paste("spring_pct_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
count_spring_urm_m2 <- run_regression(paste("spring_num_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
binary_spring_urm_m2 <- run_regression(paste("spring_has_any_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_spring_urm_m1, analysis = "Spring Semester", outcome = "% URM", model_type = "Simple"),
  list(model = pct_spring_urm_m2, analysis = "Spring Semester", outcome = "% URM", model_type = "Extended"),
  list(model = count_spring_urm_m1, analysis = "Spring Semester", outcome = "Count URM", model_type = "Simple"),
  list(model = count_spring_urm_m2, analysis = "Spring Semester", outcome = "Count URM", model_type = "Extended"),
  list(model = binary_spring_urm_m1, analysis = "Spring Semester", outcome = "Any URM", model_type = "Simple"),
  list(model = binary_spring_urm_m2, analysis = "Spring Semester", outcome = "Any URM", model_type = "Extended")
))

create_stargazer_table(
  list(pct_spring_urm_m1, pct_spring_urm_m2, count_spring_urm_m1, count_spring_urm_m2, binary_spring_urm_m1, binary_spring_urm_m2),
  c("\\% URM", "\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Spring Semester: Effect on URM Speakers",
  "tab:spring_urm",
  demographic_group = "URM"
)

# Black Analysis
pct_spring_black_m1 <- run_regression(paste("spring_pct_black ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
count_spring_black_m1 <- run_regression(paste("spring_num_black ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
binary_spring_black_m1 <- run_regression(paste("spring_has_any_black ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)

pct_spring_black_m2 <- run_regression(paste("spring_pct_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
count_spring_black_m2 <- run_regression(paste("spring_num_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
binary_spring_black_m2 <- run_regression(paste("spring_has_any_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_spring_black_m1, analysis = "Spring Semester", outcome = "% Black", model_type = "Simple"),
  list(model = pct_spring_black_m2, analysis = "Spring Semester", outcome = "% Black", model_type = "Extended"),
  list(model = count_spring_black_m1, analysis = "Spring Semester", outcome = "Count Black", model_type = "Simple"),
  list(model = count_spring_black_m2, analysis = "Spring Semester", outcome = "Count Black", model_type = "Extended"),
  list(model = binary_spring_black_m1, analysis = "Spring Semester", outcome = "Any Black", model_type = "Simple"),
  list(model = binary_spring_black_m2, analysis = "Spring Semester", outcome = "Any Black", model_type = "Extended")
))

create_stargazer_table(
  list(pct_spring_black_m1, pct_spring_black_m2, count_spring_black_m1, count_spring_black_m2, binary_spring_black_m1, binary_spring_black_m2),
  c("\\% Black", "\\% Black", "Count Black", "Count Black", "Any Black", "Any Black"),
  "Spring Semester: Effect on Black Speakers",
  "tab:spring_black",
  demographic_group = "Black"
)

# Hispanic Analysis
pct_spring_hispanic_m1 <- run_regression(paste("spring_pct_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
count_spring_hispanic_m1 <- run_regression(paste("spring_num_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
binary_spring_hispanic_m1 <- run_regression(paste("spring_has_any_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)

pct_spring_hispanic_m2 <- run_regression(paste("spring_pct_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
count_spring_hispanic_m2 <- run_regression(paste("spring_num_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
binary_spring_hispanic_m2 <- run_regression(paste("spring_has_any_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_spring_hispanic_m1, analysis = "Spring Semester", outcome = "% Hispanic", model_type = "Simple"),
  list(model = pct_spring_hispanic_m2, analysis = "Spring Semester", outcome = "% Hispanic", model_type = "Extended"),
  list(model = count_spring_hispanic_m1, analysis = "Spring Semester", outcome = "Count Hispanic", model_type = "Simple"),
  list(model = count_spring_hispanic_m2, analysis = "Spring Semester", outcome = "Count Hispanic", model_type = "Extended"),
  list(model = binary_spring_hispanic_m1, analysis = "Spring Semester", outcome = "Any Hispanic", model_type = "Simple"),
  list(model = binary_spring_hispanic_m2, analysis = "Spring Semester", outcome = "Any Hispanic", model_type = "Extended")
))

create_stargazer_table(
  list(pct_spring_hispanic_m1, pct_spring_hispanic_m2, count_spring_hispanic_m1, count_spring_hispanic_m2, binary_spring_hispanic_m1, binary_spring_hispanic_m2),
  c("\\% Hispanic", "\\% Hispanic", "Count Hispanic", "Count Hispanic", "Any Hispanic", "Any Hispanic"),
  "Spring Semester: Effect on Hispanic Speakers",
  "tab:spring_hispanic",
  demographic_group = "Hispanic"
)
```

\newpage

# Heterogeneity Analysis

## Moderation by Discipline

```{r heterogeneity-discipline}
# Test whether treatment effects vary by discipline
# We compare treatment effects across disciplines using discipline-specific models from earlier

cat("### Testing Whether Treatment Effects Vary by Discipline\n\n")

# Extract treatment coefficients from discipline-specific models stored earlier
# First, create a comprehensive table showing treatment effects by discipline

# Function to extract treatment effect info from a model
extract_treatment_effect <- function(model) {
  if (is.null(model)) return(list(coef = NA, se = NA, p = NA))
  
  coef_val <- coef(model)["treatment"]
  se_val <- model$cluster_se["treatment"]
  t_val <- coef_val / se_val
  p_val <- 2 * pt(-abs(t_val), df = length(model$residuals) - length(coef(model)))
  
  return(list(coef = coef_val, se = se_val, p = p_val))
}

# Create comprehensive comparison table for URM outcomes
cat("\\begin{table}[H]\n")
cat("\\caption{Treatment Effects by Discipline: URM Outcomes}\n")
cat("\\label{tab:discipline_comparison_urm}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccc}\n")
cat("\\toprule\n")
cat(" & \\multicolumn{2}{c}{Simple Model} & \\multicolumn{2}{c}{Extended Model} \\\\\n")
cat("Discipline & Coefficient & (SE) & Coefficient & (SE) \\\\\n")
cat("\\midrule\n")
cat("\\multicolumn{5}{l}{\\textit{Panel A: \\% URM}} \\\\\n")

# Extract results for each discipline from the stored models
disciplines <- c("Chemistry", "Mathematics", "Physics", "Computer Science", "Mechanical Engineering")

# Store coefficients for heterogeneity test
urm_pct_effects_m1 <- c()
urm_pct_effects_m2 <- c()
urm_count_effects_m1 <- c()
urm_count_effects_m2 <- c()
urm_binary_effects_m1 <- c()
urm_binary_effects_m2 <- c()

for (disc_name in disciplines) {
  if (disc_name %in% names(discipline_results)) {
    # % URM
    pct_m1_info <- extract_treatment_effect(discipline_results[[disc_name]]$pct_m1)
    pct_m2_info <- extract_treatment_effect(discipline_results[[disc_name]]$pct_m2)
    
    urm_pct_effects_m1 <- c(urm_pct_effects_m1, pct_m1_info$coef)
    urm_pct_effects_m2 <- c(urm_pct_effects_m2, pct_m2_info$coef)
    
    sig_m1 <- ifelse(is.na(pct_m1_info$p), "", 
                     ifelse(pct_m1_info$p < 0.001, "***",
                            ifelse(pct_m1_info$p < 0.01, "**",
                                   ifelse(pct_m1_info$p < 0.05, "*",
                                          ifelse(pct_m1_info$p < 0.1, "+", "")))))
    sig_m2 <- ifelse(is.na(pct_m2_info$p), "", 
                     ifelse(pct_m2_info$p < 0.001, "***",
                            ifelse(pct_m2_info$p < 0.01, "**",
                                   ifelse(pct_m2_info$p < 0.05, "*",
                                          ifelse(pct_m2_info$p < 0.1, "+", "")))))
    
    cat(sprintf("%s & %.4f%s & (%.4f) & %.4f%s & (%.4f) \\\\\n",
                disc_name, 
                ifelse(is.na(pct_m1_info$coef), 0, pct_m1_info$coef), sig_m1,
                ifelse(is.na(pct_m1_info$se), 0, pct_m1_info$se),
                ifelse(is.na(pct_m2_info$coef), 0, pct_m2_info$coef), sig_m2,
                ifelse(is.na(pct_m2_info$se), 0, pct_m2_info$se)))
  }
}

cat("\\midrule\n")
cat("\\multicolumn{5}{l}{\\textit{Panel B: Count URM}} \\\\\n")

for (disc_name in disciplines) {
  if (disc_name %in% names(discipline_results)) {
    # Count URM
    count_m1_info <- extract_treatment_effect(discipline_results[[disc_name]]$count_m1)
    count_m2_info <- extract_treatment_effect(discipline_results[[disc_name]]$count_m2)
    
    urm_count_effects_m1 <- c(urm_count_effects_m1, count_m1_info$coef)
    urm_count_effects_m2 <- c(urm_count_effects_m2, count_m2_info$coef)
    
    sig_m1 <- ifelse(is.na(count_m1_info$p), "", 
                     ifelse(count_m1_info$p < 0.001, "***",
                            ifelse(count_m1_info$p < 0.01, "**",
                                   ifelse(count_m1_info$p < 0.05, "*",
                                          ifelse(count_m1_info$p < 0.1, "+", "")))))
    sig_m2 <- ifelse(is.na(count_m2_info$p), "", 
                     ifelse(count_m2_info$p < 0.001, "***",
                            ifelse(count_m2_info$p < 0.01, "**",
                                   ifelse(count_m2_info$p < 0.05, "*",
                                          ifelse(count_m2_info$p < 0.1, "+", "")))))
    
    cat(sprintf("%s & %.4f%s & (%.4f) & %.4f%s & (%.4f) \\\\\n",
                disc_name, 
                ifelse(is.na(count_m1_info$coef), 0, count_m1_info$coef), sig_m1,
                ifelse(is.na(count_m1_info$se), 0, count_m1_info$se),
                ifelse(is.na(count_m2_info$coef), 0, count_m2_info$coef), sig_m2,
                ifelse(is.na(count_m2_info$se), 0, count_m2_info$se)))
  }
}

cat("\\midrule\n")
cat("\\multicolumn{5}{l}{\\textit{Panel C: Any URM}} \\\\\n")

for (disc_name in disciplines) {
  if (disc_name %in% names(discipline_results)) {
    # Binary URM
    binary_m1_info <- extract_treatment_effect(discipline_results[[disc_name]]$binary_m1)
    binary_m2_info <- extract_treatment_effect(discipline_results[[disc_name]]$binary_m2)
    
    urm_binary_effects_m1 <- c(urm_binary_effects_m1, binary_m1_info$coef)
    urm_binary_effects_m2 <- c(urm_binary_effects_m2, binary_m2_info$coef)
    
    sig_m1 <- ifelse(is.na(binary_m1_info$p), "", 
                     ifelse(binary_m1_info$p < 0.001, "***",
                            ifelse(binary_m1_info$p < 0.01, "**",
                                   ifelse(binary_m1_info$p < 0.05, "*",
                                          ifelse(binary_m1_info$p < 0.1, "+", "")))))
    sig_m2 <- ifelse(is.na(binary_m2_info$p), "", 
                     ifelse(binary_m2_info$p < 0.001, "***",
                            ifelse(binary_m2_info$p < 0.01, "**",
                                   ifelse(binary_m2_info$p < 0.05, "*",
                                          ifelse(binary_m2_info$p < 0.1, "+", "")))))
    
    cat(sprintf("%s & %.4f%s & (%.4f) & %.4f%s & (%.4f) \\\\\n",
                disc_name, 
                ifelse(is.na(binary_m1_info$coef), 0, binary_m1_info$coef), sig_m1,
                ifelse(is.na(binary_m1_info$se), 0, binary_m1_info$se),
                ifelse(is.na(binary_m2_info$coef), 0, binary_m2_info$coef), sig_m2,
                ifelse(is.na(binary_m2_info$se), 0, binary_m2_info$se)))
  }
}

cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\footnotesize{Note: + p<0.1; * p<0.05; ** p<0.01; *** p<0.001. Standard errors clustered at department level in parentheses.}\n")
cat("\\end{table}\n")

# Now test for heterogeneity across disciplines using interaction model
# Run models with all discipline interactions
pct_interact_m1 <- run_regression(paste("pct_urm ~ treatment * (disc_mathematics + disc_physics + disc_computer_science + disc_mechanical_engineering) +", 
                                       paste(setdiff(base_controls, c("disc_mathematics", "disc_physics", 
                                                                     "disc_computer_science", "disc_mechanical_engineering")), 
                                             collapse = " + ")), data)
pct_interact_m2 <- run_regression(paste("pct_urm ~ treatment * (disc_mathematics + disc_physics + disc_computer_science + disc_mechanical_engineering) +", 
                                       paste(c(setdiff(base_controls, c("disc_mathematics", "disc_physics", 
                                                                       "disc_computer_science", "disc_mechanical_engineering")), 
                                              extended_controls), collapse = " + ")), data)

count_interact_m1 <- run_regression(paste("num_urm ~ treatment * (disc_mathematics + disc_physics + disc_computer_science + disc_mechanical_engineering) +", 
                                         paste(setdiff(base_controls, c("disc_mathematics", "disc_physics", 
                                                                       "disc_computer_science", "disc_mechanical_engineering")), 
                                               collapse = " + ")), data)
count_interact_m2 <- run_regression(paste("num_urm ~ treatment * (disc_mathematics + disc_physics + disc_computer_science + disc_mechanical_engineering) +", 
                                         paste(c(setdiff(base_controls, c("disc_mathematics", "disc_physics", 
                                                                         "disc_computer_science", "disc_mechanical_engineering")), 
                                                extended_controls), collapse = " + ")), data)

binary_interact_m1 <- run_regression(paste("has_any_urm ~ treatment * (disc_mathematics + disc_physics + disc_computer_science + disc_mechanical_engineering) +", 
                                          paste(setdiff(base_controls, c("disc_mathematics", "disc_physics", 
                                                                        "disc_computer_science", "disc_mechanical_engineering")), 
                                                collapse = " + ")), data)
binary_interact_m2 <- run_regression(paste("has_any_urm ~ treatment * (disc_mathematics + disc_physics + disc_computer_science + disc_mechanical_engineering) +", 
                                          paste(c(setdiff(base_controls, c("disc_mathematics", "disc_physics", 
                                                                          "disc_computer_science", "disc_mechanical_engineering")), 
                                                 extended_controls), collapse = " + ")), data)

# Test joint significance of interaction terms
interaction_terms <- c("treatment:disc_mathematics", "treatment:disc_physics", 
                      "treatment:disc_computer_science", "treatment:disc_mechanical_engineering")

test_heterogeneity <- function(model, interaction_terms) {
  if (!is.null(model)) {
    hypothesis <- paste(interaction_terms, collapse = " = 0, ")
    hypothesis <- paste0(hypothesis, " = 0")
    
    tryCatch({
      test <- linearHypothesis(model, hypothesis, vcov = vcovCL(model, cluster = data$department_std))
      return(list(F_stat = test$F[2], p_value = test$`Pr(>F)`[2]))
    }, error = function(e) {
      return(list(F_stat = NA, p_value = NA))
    })
  } else {
    return(list(F_stat = NA, p_value = NA))
  }
}

# Create heterogeneity test table
cat("\n\\begin{table}[H]\n")
cat("\\caption{Test for Heterogeneous Treatment Effects Across Disciplines}\n")
cat("\\label{tab:discipline_heterogeneity_test}\n")
cat("\\centering\n")
cat("\\begin{tabular}{lccc}\n")
cat("\\toprule\n")
cat("Outcome & Model & F-statistic & p-value \\\\\n")
cat("\\midrule\n")

# Test each outcome
test_results <- list(
  list("\\% URM", "Simple", test_heterogeneity(pct_interact_m1, interaction_terms)),
  list("\\% URM", "Extended", test_heterogeneity(pct_interact_m2, interaction_terms)),
  list("Count URM", "Simple", test_heterogeneity(count_interact_m1, interaction_terms)),
  list("Count URM", "Extended", test_heterogeneity(count_interact_m2, interaction_terms)),
  list("Any URM", "Simple", test_heterogeneity(binary_interact_m1, interaction_terms)),
  list("Any URM", "Extended", test_heterogeneity(binary_interact_m2, interaction_terms))
)

for (result in test_results) {
  if (!is.na(result[[3]]$F_stat)) {
    cat(sprintf("%s & %s & %.3f & %.4f \\\\\n", 
                result[[1]], result[[2]], 
                result[[3]]$F_stat, result[[3]]$p_value))
  } else {
    cat(sprintf("%s & %s & --- & --- \\\\\n", 
                result[[1]], result[[2]]))
  }
}

cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\footnotesize{Note: F-statistics test the null hypothesis that treatment effects are equal across all disciplines (H0: all discipline-treatment interactions = 0).}\n")
cat("\\end{table}\n")

# Now repeat for Black and Hispanic outcomes
# Black outcomes
cat("\n\\begin{table}[H]\n")
cat("\\caption{Treatment Effects by Discipline: Black Speaker Outcomes}\n")
cat("\\label{tab:discipline_comparison_black}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccc}\n")
cat("\\toprule\n")
cat(" & \\multicolumn{2}{c}{Simple Model} & \\multicolumn{2}{c}{Extended Model} \\\\\n")
cat("Discipline & Coefficient & (SE) & Coefficient & (SE) \\\\\n")
cat("\\midrule\n")
cat("\\multicolumn{5}{l}{\\textit{Panel A: \\% Black}} \\\\\n")

# For Black outcomes, we need to run the models since they weren't stored
for (disc_info in disciplines) {
  disc_name <- disc_info
  if (disc_name == "Chemistry") {
    disc_data <- data %>% filter(disc_mathematics == 0 & disc_physics == 0 & 
                                disc_computer_science == 0 & disc_mechanical_engineering == 0)
  } else if (disc_name == "Mathematics") {
    disc_data <- data %>% filter(disc_mathematics == 1)
  } else if (disc_name == "Physics") {
    disc_data <- data %>% filter(disc_physics == 1)
  } else if (disc_name == "Computer Science") {
    disc_data <- data %>% filter(disc_computer_science == 1)
  } else if (disc_name == "Mechanical Engineering") {
    disc_data <- data %>% filter(disc_mechanical_engineering == 1)
  }
  
  if (nrow(disc_data) >= 30) {
    # Run models for Black outcomes
    pct_black_m1 <- run_regression(paste("pct_black ~ treatment +", 
                                        paste(setdiff(base_controls, 
                                                     c("disc_mathematics", "disc_physics", 
                                                       "disc_computer_science", "disc_mechanical_engineering")), 
                                              collapse = " + ")), disc_data)
    pct_black_m2 <- run_regression(paste("pct_black ~ treatment +", 
                                        paste(c(setdiff(base_controls, 
                                                       c("disc_mathematics", "disc_physics", 
                                                         "disc_computer_science", "disc_mechanical_engineering")), 
                                               extended_controls), collapse = " + ")), disc_data)
    
    pct_m1_info <- extract_treatment_effect(pct_black_m1)
    pct_m2_info <- extract_treatment_effect(pct_black_m2)
    
    sig_m1 <- ifelse(is.na(pct_m1_info$p), "", 
                     ifelse(pct_m1_info$p < 0.001, "***",
                            ifelse(pct_m1_info$p < 0.01, "**",
                                   ifelse(pct_m1_info$p < 0.05, "*",
                                          ifelse(pct_m1_info$p < 0.1, "+", "")))))
    sig_m2 <- ifelse(is.na(pct_m2_info$p), "", 
                     ifelse(pct_m2_info$p < 0.001, "***",
                            ifelse(pct_m2_info$p < 0.01, "**",
                                   ifelse(pct_m2_info$p < 0.05, "*",
                                          ifelse(pct_m2_info$p < 0.1, "+", "")))))
    
    cat(sprintf("%s & %.4f%s & (%.4f) & %.4f%s & (%.4f) \\\\\n",
                disc_name, 
                ifelse(is.na(pct_m1_info$coef), 0, pct_m1_info$coef), sig_m1,
                ifelse(is.na(pct_m1_info$se), 0, pct_m1_info$se),
                ifelse(is.na(pct_m2_info$coef), 0, pct_m2_info$coef), sig_m2,
                ifelse(is.na(pct_m2_info$se), 0, pct_m2_info$se)))
  } else {
    cat(sprintf("%s & --- & --- & --- & --- \\\\\n", disc_name))
  }
}

cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\footnotesize{Note: + p<0.1; * p<0.05; ** p<0.01; *** p<0.001. Standard errors clustered at department level in parentheses. Count and Binary outcomes omitted for brevity.}\n")
cat("\\end{table}\n")

# Hispanic outcomes
cat("\n\\begin{table}[H]\n")
cat("\\caption{Treatment Effects by Discipline: Hispanic Speaker Outcomes}\n")
cat("\\label{tab:discipline_comparison_hispanic}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccc}\n")
cat("\\toprule\n")
cat(" & \\multicolumn{2}{c}{Simple Model} & \\multicolumn{2}{c}{Extended Model} \\\\\n")
cat("Discipline & Coefficient & (SE) & Coefficient & (SE) \\\\\n")
cat("\\midrule\n")
cat("\\multicolumn{5}{l}{\\textit{Panel A: \\% Hispanic}} \\\\\n")

# For Hispanic outcomes
for (disc_info in disciplines) {
  disc_name <- disc_info
  if (disc_name == "Chemistry") {
    disc_data <- data %>% filter(disc_mathematics == 0 & disc_physics == 0 & 
                                disc_computer_science == 0 & disc_mechanical_engineering == 0)
  } else if (disc_name == "Mathematics") {
    disc_data <- data %>% filter(disc_mathematics == 1)
  } else if (disc_name == "Physics") {
    disc_data <- data %>% filter(disc_physics == 1)
  } else if (disc_name == "Computer Science") {
    disc_data <- data %>% filter(disc_computer_science == 1)
  } else if (disc_name == "Mechanical Engineering") {
    disc_data <- data %>% filter(disc_mechanical_engineering == 1)
  }
  
  if (nrow(disc_data) >= 30) {
    # Run models for Hispanic outcomes
    pct_hispanic_m1 <- run_regression(paste("pct_hispanic ~ treatment +", 
                                           paste(setdiff(base_controls, 
                                                        c("disc_mathematics", "disc_physics", 
                                                          "disc_computer_science", "disc_mechanical_engineering")), 
                                                 collapse = " + ")), disc_data)
    pct_hispanic_m2 <- run_regression(paste("pct_hispanic ~ treatment +", 
                                           paste(c(setdiff(base_controls, 
                                                          c("disc_mathematics", "disc_physics", 
                                                            "disc_computer_science", "disc_mechanical_engineering")), 
                                                  extended_controls), collapse = " + ")), disc_data)
    
    pct_m1_info <- extract_treatment_effect(pct_hispanic_m1)
    pct_m2_info <- extract_treatment_effect(pct_hispanic_m2)
    
    sig_m1 <- ifelse(is.na(pct_m1_info$p), "", 
                     ifelse(pct_m1_info$p < 0.001, "***",
                            ifelse(pct_m1_info$p < 0.01, "**",
                                   ifelse(pct_m1_info$p < 0.05, "*",
                                          ifelse(pct_m1_info$p < 0.1, "+", "")))))
    sig_m2 <- ifelse(is.na(pct_m2_info$p), "", 
                     ifelse(pct_m2_info$p < 0.001, "***",
                            ifelse(pct_m2_info$p < 0.01, "**",
                                   ifelse(pct_m2_info$p < 0.05, "*",
                                          ifelse(pct_m2_info$p < 0.1, "+", "")))))
    
    cat(sprintf("%s & %.4f%s & (%.4f) & %.4f%s & (%.4f) \\\\\n",
                disc_name, 
                ifelse(is.na(pct_m1_info$coef), 0, pct_m1_info$coef), sig_m1,
                ifelse(is.na(pct_m1_info$se), 0, pct_m1_info$se),
                ifelse(is.na(pct_m2_info$coef), 0, pct_m2_info$coef), sig_m2,
                ifelse(is.na(pct_m2_info$se), 0, pct_m2_info$se)))
  } else {
    cat(sprintf("%s & --- & --- & --- & --- \\\\\n", disc_name))
  }
}

cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\footnotesize{Note: + p<0.1; * p<0.05; ** p<0.01; *** p<0.001. Standard errors clustered at department level in parentheses. Count and Binary outcomes omitted for brevity.}\n")
cat("\\end{table}\n")
```

\newpage

## Moderation by Department URM Representation

```{r mod-dept-urm}
# Create centered moderator
data$moderator <- data$frac_urm_faculty - mean(data$frac_urm_faculty, na.rm = TRUE)
data_mod <- data %>% filter(!is.na(moderator))

cat(paste0("Department URM representation moderation analysis (n = ", nrow(data_mod), ")\n\n"))

# Run moderation models
pct_mod_m1 <- run_regression(paste("pct_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
count_mod_m1 <- run_regression(paste("num_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
binary_mod_m1 <- run_regression(paste("has_any_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)

pct_mod_m2 <- run_regression(paste("pct_urm ~ treatment * moderator +", 
                                  paste(setdiff(c(base_controls, extended_controls), "frac_urm_faculty"), 
                                        collapse = " + ")), data_mod)
count_mod_m2 <- run_regression(paste("num_urm ~ treatment * moderator +", 
                                    paste(setdiff(c(base_controls, extended_controls), "frac_urm_faculty"), 
                                          collapse = " + ")), data_mod)
binary_mod_m2 <- run_regression(paste("has_any_urm ~ treatment * moderator +", 
                                     paste(setdiff(c(base_controls, extended_controls), "frac_urm_faculty"), 
                                           collapse = " + ")), data_mod)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_mod_m1, analysis = "URM Faculty Moderation", outcome = "% URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept URM Fraction")),
  list(model = pct_mod_m2, analysis = "URM Faculty Moderation", outcome = "% URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept URM Fraction")),
  list(model = count_mod_m1, analysis = "URM Faculty Moderation", outcome = "Count URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept URM Fraction")),
  list(model = count_mod_m2, analysis = "URM Faculty Moderation", outcome = "Count URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept URM Fraction")),
  list(model = binary_mod_m1, analysis = "URM Faculty Moderation", outcome = "Any URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept URM Fraction")),
  list(model = binary_mod_m2, analysis = "URM Faculty Moderation", outcome = "Any URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept URM Fraction"))
))

create_moderator_table(
  list(pct_mod_m1, pct_mod_m2, count_mod_m1, count_mod_m2, binary_mod_m1, binary_mod_m2),
  c("\\% URM", "\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Moderation by Department URM Faculty Fraction",
  "tab:mod_dept_urm",
  "Dept URM Fraction (centered)"
)
```

\newpage

## Moderation by Department Female Representation

```{r mod-dept-female}
# Create centered moderator
data$moderator <- data$frac_women_faculty - mean(data$frac_women_faculty, na.rm = TRUE)
data_mod <- data %>% filter(!is.na(moderator))

cat(paste0("Department female representation moderation analysis (n = ", nrow(data_mod), ")\n\n"))

# Run moderation models
pct_mod_m1 <- run_regression(paste("pct_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
count_mod_m1 <- run_regression(paste("num_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
binary_mod_m1 <- run_regression(paste("has_any_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)

pct_mod_m2 <- run_regression(paste("pct_urm ~ treatment * moderator +", 
                                  paste(setdiff(c(base_controls, extended_controls), "frac_women_faculty"), 
                                        collapse = " + ")), data_mod)
count_mod_m2 <- run_regression(paste("num_urm ~ treatment * moderator +", 
                                    paste(setdiff(c(base_controls, extended_controls), "frac_women_faculty"), 
                                          collapse = " + ")), data_mod)
binary_mod_m2 <- run_regression(paste("has_any_urm ~ treatment * moderator +", 
                                     paste(setdiff(c(base_controls, extended_controls), "frac_women_faculty"), 
                                           collapse = " + ")), data_mod)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_mod_m1, analysis = "Female Faculty Moderation", outcome = "% URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept Female Fraction")),
  list(model = pct_mod_m2, analysis = "Female Faculty Moderation", outcome = "% URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept Female Fraction")),
  list(model = count_mod_m1, analysis = "Female Faculty Moderation", outcome = "Count URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept Female Fraction")),
  list(model = count_mod_m2, analysis = "Female Faculty Moderation", outcome = "Count URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept Female Fraction")),
  list(model = binary_mod_m1, analysis = "Female Faculty Moderation", outcome = "Any URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept Female Fraction")),
  list(model = binary_mod_m2, analysis = "Female Faculty Moderation", outcome = "Any URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept Female Fraction"))
))

create_moderator_table(
  list(pct_mod_m1, pct_mod_m2, count_mod_m1, count_mod_m2, binary_mod_m1, binary_mod_m2),
  c("\\% URM", "\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Moderation by Department Female Faculty Fraction",
  "tab:mod_dept_female",
  "Dept Female Fraction (centered)"
)
```

\newpage

## Moderation by Department Ranking

```{r mod-ranking}
# Create centered moderator
data$moderator <- data$dept_ranking - mean(data$dept_ranking, na.rm = TRUE)
data_mod <- data %>% filter(!is.na(moderator))

cat(paste0("Department ranking moderation analysis (n = ", nrow(data_mod), ")\n\n"))

# Run moderation models
pct_mod_m1 <- run_regression(paste("pct_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
count_mod_m1 <- run_regression(paste("num_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
binary_mod_m1 <- run_regression(paste("has_any_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)

pct_mod_m2 <- run_regression(paste("pct_urm ~ treatment * moderator +", 
                                  paste(setdiff(c(base_controls, extended_controls), c("dept_ranking", "missing_dept_rank")), 
                                        collapse = " + ")), data_mod)
count_mod_m2 <- run_regression(paste("num_urm ~ treatment * moderator +", 
                                    paste(setdiff(c(base_controls, extended_controls), c("dept_ranking", "missing_dept_rank")), 
                                          collapse = " + ")), data_mod)
binary_mod_m2 <- run_regression(paste("has_any_urm ~ treatment * moderator +", 
                                     paste(setdiff(c(base_controls, extended_controls), c("dept_ranking", "missing_dept_rank")), 
                                           collapse = " + ")), data_mod)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_mod_m1, analysis = "Ranking Moderation", outcome = "% URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept Ranking")),
  list(model = pct_mod_m2, analysis = "Ranking Moderation", outcome = "% URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept Ranking")),
  list(model = count_mod_m1, analysis = "Ranking Moderation", outcome = "Count URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept Ranking")),
  list(model = count_mod_m2, analysis = "Ranking Moderation", outcome = "Count URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept Ranking")),
  list(model = binary_mod_m1, analysis = "Ranking Moderation", outcome = "Any URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept Ranking")),
  list(model = binary_mod_m2, analysis = "Ranking Moderation", outcome = "Any URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Dept Ranking"))
))

create_moderator_table(
  list(pct_mod_m1, pct_mod_m2, count_mod_m1, count_mod_m2, binary_mod_m1, binary_mod_m2),
  c("\\% URM", "\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Moderation by Department Ranking",
  "tab:mod_ranking",
  "Dept Ranking (centered)"
)
```

\newpage

## Moderation by Total Faculty Size

```{r mod-faculty-size}
# Create centered moderator  
data$moderator <- data$total_faculty - mean(data$total_faculty, na.rm = TRUE)
data_mod <- data %>% filter(!is.na(moderator))

cat(paste0("Department faculty size moderation analysis (n = ", nrow(data_mod), ")\n\n"))

# Run moderation models
pct_mod_m1 <- run_regression(paste("pct_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
count_mod_m1 <- run_regression(paste("num_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
binary_mod_m1 <- run_regression(paste("has_any_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)

pct_mod_m2 <- run_regression(paste("pct_urm ~ treatment * moderator +", 
                                  paste(setdiff(c(base_controls, extended_controls), "total_faculty"), 
                                        collapse = " + ")), data_mod)
count_mod_m2 <- run_regression(paste("num_urm ~ treatment * moderator +", 
                                    paste(setdiff(c(base_controls, extended_controls), "total_faculty"), 
                                          collapse = " + ")), data_mod)
binary_mod_m2 <- run_regression(paste("has_any_urm ~ treatment * moderator +", 
                                     paste(setdiff(c(base_controls, extended_controls), "total_faculty"), 
                                           collapse = " + ")), data_mod)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_mod_m1, analysis = "Faculty Size Moderation", outcome = "% URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Faculty Size")),
  list(model = pct_mod_m2, analysis = "Faculty Size Moderation", outcome = "% URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Faculty Size")),
  list(model = count_mod_m1, analysis = "Faculty Size Moderation", outcome = "Count URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Faculty Size")),
  list(model = count_mod_m2, analysis = "Faculty Size Moderation", outcome = "Count URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Faculty Size")),
  list(model = binary_mod_m1, analysis = "Faculty Size Moderation", outcome = "Any URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Faculty Size")),
  list(model = binary_mod_m2, analysis = "Faculty Size Moderation", outcome = "Any URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Faculty Size"))
))

create_moderator_table(
  list(pct_mod_m1, pct_mod_m2, count_mod_m1, count_mod_m2, binary_mod_m1, binary_mod_m2),
  c("\\% URM", "\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Moderation by Department Faculty Size",
  "tab:mod_faculty_size",
  "Total Faculty (centered)"
)
```

\newpage

## Moderation by URM Faculty in Peer Departments

```{r mod-peer-urm}
# Create centered moderator
data$moderator <- data$total_urm_peer_faculty - mean(data$total_urm_peer_faculty, na.rm = TRUE)
data_mod <- data %>% filter(!is.na(moderator))

cat(paste0("Peer departments URM faculty moderation analysis (n = ", nrow(data_mod), ")\n\n"))

# Run moderation models
pct_mod_m1 <- run_regression(paste("pct_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
count_mod_m1 <- run_regression(paste("num_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)
binary_mod_m1 <- run_regression(paste("has_any_urm ~ treatment * moderator +", paste(base_controls, collapse = " + ")), data_mod)

pct_mod_m2 <- run_regression(paste("pct_urm ~ treatment * moderator +", 
                                  paste(setdiff(c(base_controls, extended_controls), c("total_urm_peer_faculty", "total_peer_departments")), 
                                        collapse = " + ")), data_mod)
count_mod_m2 <- run_regression(paste("num_urm ~ treatment * moderator +", 
                                    paste(setdiff(c(base_controls, extended_controls), c("total_urm_peer_faculty", "total_peer_departments")), 
                                          collapse = " + ")), data_mod)
binary_mod_m2 <- run_regression(paste("has_any_urm ~ treatment * moderator +", 
                                     paste(setdiff(c(base_controls, extended_controls), c("total_urm_peer_faculty", "total_peer_departments")), 
                                           collapse = " + ")), data_mod)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_mod_m1, analysis = "Peer URM Moderation", outcome = "% URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Peer URM Faculty")),
  list(model = pct_mod_m2, analysis = "Peer URM Moderation", outcome = "% URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Peer URM Faculty")),
  list(model = count_mod_m1, analysis = "Peer URM Moderation", outcome = "Count URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Peer URM Faculty")),
  list(model = count_mod_m2, analysis = "Peer URM Moderation", outcome = "Count URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Peer URM Faculty")),
  list(model = binary_mod_m1, analysis = "Peer URM Moderation", outcome = "Any URM", model_type = "Simple",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Peer URM Faculty")),
  list(model = binary_mod_m2, analysis = "Peer URM Moderation", outcome = "Any URM", model_type = "Extended",
       var_names = c("treatment", "treatment:moderator"), 
       var_labels = c("Treatment", "Treatment $\\times$ Peer URM Faculty"))
))

create_moderator_table(
  list(pct_mod_m1, pct_mod_m2, count_mod_m1, count_mod_m2, binary_mod_m1, binary_mod_m2),
  c("\\% URM", "\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Moderation by URM Faculty in Peer Departments",
  "tab:mod_peer_urm",
  "Peer URM Faculty (centered)"
)
```

```{r final-significant-results, results='asis'}
# Comprehensive function to extract ALL significant results including interactions
extract_all_significant_results <- function() {
  results <- data.frame(
    Analysis = character(),
    Outcome = character(),
    Variable = character(),
    Model = character(),
    Coefficient = numeric(),
    SE = numeric(),
    t_stat = numeric(),
    p_value = numeric(),
    Significance = character(),
    Category = character(),
    stringsAsFactors = FALSE
  )
  
  # Function to add result if significant (for any coefficient)
  add_if_significant_any <- function(model, analysis, outcome, model_type, 
                                    var_names = c("treatment"), 
                                    var_labels = c("Treatment")) {
    if (!is.null(model)) {
      for (i in seq_along(var_names)) {
        var_name <- var_names[i]
        var_label <- var_labels[i]
        
        if (var_name %in% names(coef(model))) {
          coef_val <- coef(model)[var_name]
          se_idx <- which(names(model$cluster_se) == var_name)
          if (length(se_idx) > 0) {
            se_val <- model$cluster_se[se_idx]
            t_val <- coef_val / se_val
            p_val <- 2 * pt(-abs(t_val), df = length(model$residuals) - length(coef(model)))
            
            if (p_val < 0.1) {
              sig <- ifelse(p_val < 0.001, "***", 
                           ifelse(p_val < 0.01, "**",
                                 ifelse(p_val < 0.05, "*", "+")))
              
              # Determine category
              category <- case_when(
                grepl("Main Effect|Main Question", analysis) ~ "Main Effects",
                grepl("Demographic|Black|Hispanic|Female", analysis) ~ "Demographic Analysis",
                grepl("Intersectional", analysis) ~ "Demographic Analysis",
                grepl("Semester", analysis) ~ "Semester Analysis",
                grepl("Discipline:", analysis) ~ "Discipline Analysis",
                grepl("Moderation", analysis) ~ "Moderation Analysis",
                TRUE ~ "Other"
              )
              
              results <<- rbind(results, data.frame(
                Analysis = analysis,
                Outcome = outcome,
                Variable = var_label,
                Model = model_type,
                Coefficient = coef_val,
                SE = se_val,
                t_stat = t_val,
                p_value = p_val,
                Significance = sig,
                Category = category,
                stringsAsFactors = FALSE
              ))
            }
          }
        }
      }
    }
  }
  
  # Process all models from all_models_list
  for (model_info in all_models_list) {
    model <- model_info$model
    analysis <- model_info$analysis
    outcome <- model_info$outcome
    model_type <- model_info$model_type
    var_names <- model_info$var_names
    var_labels <- model_info$var_labels
    
    if (is.null(var_names)) {
      var_names <- c("treatment")
      var_labels <- c("Treatment")
    }
    
    add_if_significant_any(model, analysis, outcome, model_type, var_names, var_labels)
  }
  
  return(results)
}

# Now generate the actual comprehensive significant results table
all_significant_results <- extract_all_significant_results()

if (nrow(all_significant_results) > 0) {
  # Keep only the result with lowest p-value for each Analysis/Outcome/Variable combination
  all_significant_results <- all_significant_results %>%
    group_by(Analysis, Outcome, Variable) %>%
    arrange(p_value) %>%
    slice(1) %>%
    ungroup()
  
  # Sort by category and then by analysis name
  all_significant_results <- all_significant_results %>%
    arrange(Category, Analysis, Outcome, Variable) %>%
    mutate(
      Coefficient = sprintf("%.4f", Coefficient),
      SE = sprintf("%.4f", SE),
      t_stat = sprintf("%.3f", t_stat),
      p_value_formatted = sprintf("%.4f", p_value)
    )
  
  # Create the comprehensive table
  cat("\n\n\\clearpage\n")
  cat("\\section{Summary of All Significant Results}\n\n")
  
  cat("\\begin{landscape}\n")
  cat("\\begin{table}[H]\n")
  cat("\\caption{All Significant Results (p < 0.1) from All Analyses}\n")
  cat("\\label{tab:all_significant_results}\n")
  cat("\\centering\n")
  cat("\\footnotesize\n")
  cat("\\begin{tabular}{lllllrrrl}\n")
  cat("\\toprule\n")
  cat("Analysis & Outcome & Variable & Model & Coef. & SE & t-stat & p-value & Sig. \\\\\n")
  cat("\\midrule\n")
  
  # Print results with category headers
  current_category <- ""
  for (i in 1:nrow(all_significant_results)) {
    # Add category header if new category
    if (all_significant_results$Category[i] != current_category) {
      if (current_category != "") {
        cat("\\addlinespace[0.5em]\n")
      }
      current_category <- all_significant_results$Category[i]
      cat("\\multicolumn{9}{l}{\\textbf{", escape_latex(current_category), "}} \\\\\n")
      cat("\\midrule\n")
    }
    
    cat(sprintf("%s & %s & %s & %s & %s & %s & %s & %s & %s \\\\\n",
                escape_latex(all_significant_results$Analysis[i]),
                escape_latex(all_significant_results$Outcome[i]),
                escape_latex(all_significant_results$Variable[i]),
                escape_latex(all_significant_results$Model[i]),
                all_significant_results$Coefficient[i],
                all_significant_results$SE[i],
                all_significant_results$t_stat[i],
                all_significant_results$p_value_formatted[i],
                all_significant_results$Significance[i]))
  }
  
  cat("\\bottomrule\n")
  cat("\\end{tabular}\n")
  cat("\\footnotesize{Note: Results sorted by analysis type and name. When both Model 1 (Simple) and Model 2 (Extended) are significant, only the result with the lower p-value is shown. Significance levels: + p<0.1; * p<0.05; ** p<0.01; *** p<0.001. SE = Clustered standard errors at department level.}\n")
  cat("\\end{table}\n")
  cat("\\end{landscape}\n")
  
  # Also create a summary by analysis type
  cat("\n\\begin{table}[H]\n")
  cat("\\caption{Summary of Significant Results by Analysis Type}\n")
  cat("\\label{tab:significant_summary}\n")
  cat("\\centering\n")
  cat("\\begin{tabular}{lcc}\n")
  cat("\\toprule\n")
  cat("Analysis Type & Total Significant & Significant at 5\\% \\\\\n")
  cat("\\midrule\n")
  
  summary_by_analysis <- all_significant_results %>%
    group_by(Analysis) %>%
    summarise(
      total = n(),
      sig_05 = sum(p_value < 0.05),
      .groups = 'drop'
    )
  
  for (i in 1:nrow(summary_by_analysis)) {
    cat(sprintf("%s & %d & %d \\\\\n",
                escape_latex(summary_by_analysis$Analysis[i]),
                summary_by_analysis$total[i],
                summary_by_analysis$sig_05[i]))
  }
  
  cat("\\midrule\n")
  cat(sprintf("Total & %d & %d \\\\\n", 
              sum(summary_by_analysis$total),
              sum(summary_by_analysis$sig_05)))
  cat("\\bottomrule\n")
  cat("\\end{tabular}\n")
  cat("\\end{table}\n")
  
} else {
  cat("\n\\textit{No significant results (p < 0.1) found in any of the analyses.}\n\n")
}
```