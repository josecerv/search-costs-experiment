---
title: "Search Costs Field Experiment"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
    fig_caption: true
    keep_tex: true
    keep_md: true
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{float}
  - \usepackage{pdflscape}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
  - \usepackage{caption}
  - \captionsetup[table]{position=below,skip=10pt}
  - \usepackage{dcolumn}
  - \usepackage{adjustbox}
  - \usepackage{tabularx}
  - \newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      fig.pos = 'H', results = 'asis')

# Load required libraries
library(tidyverse)
library(stargazer)
library(lmtest)
library(sandwich)
library(systemfit)
library(knitr)
library(kableExtra)
library(car)  # For linearHypothesis

# Note: We'll use manual table generation instead of modelsummary
# to have full control over column spacing

# Set stargazer options
options(width = 200)

data <- read.csv("outputs/master_analysis_dataset_final.csv")


# Data validation
# cat("Data loaded successfully. N =", nrow(data), "\n")
# cat("Treatment:", sum(data$treatment), "Control:", sum(1-data$treatment), "\n\n")

# Create bin_11_17 dummy variable (since we're using bin_17_26 as reference)
# This represents the (11,17] bin category
data$bin_11_17 <- as.numeric(data$bin_category == "(11,17]")

# Create all derived variables at once
data <- data %>%
  mutate(
    # Non-URM counts
    num_non_urm = speakers_with_demographics - num_urm,
    fall_num_non_urm = fall_speakers_with_demographics - fall_num_urm,
    spring_num_non_urm = spring_speakers_with_demographics - spring_num_urm,
    
    # Non-demographic counts
    num_non_black = speakers_with_demographics - num_black,
    num_non_hispanic = speakers_with_demographics - num_hispanic,
    num_non_female = speakers_with_demographics - num_female,
    
    fall_num_non_black = fall_speakers_with_demographics - fall_num_black,
    fall_num_non_hispanic = fall_speakers_with_demographics - fall_num_hispanic,
    fall_num_non_female = fall_speakers_with_demographics - fall_num_female,
    
    spring_num_non_black = spring_speakers_with_demographics - spring_num_black,
    spring_num_non_hispanic = spring_speakers_with_demographics - spring_num_hispanic,
    spring_num_non_female = spring_speakers_with_demographics - spring_num_female,
    
    # Non-URM percentages
    pct_non_urm = ifelse(speakers_with_demographics > 0, 100 - pct_urm, 0),
    fall_pct_non_urm = ifelse(fall_speakers_with_demographics > 0, 100 - fall_pct_urm, 0),
    spring_pct_non_urm = ifelse(spring_speakers_with_demographics > 0, 100 - spring_pct_urm, 0),
    
    # Binary indicators
    has_any_non_urm = as.numeric(num_non_urm > 0),
    fall_has_any_urm = as.numeric(fall_num_urm > 0),
    spring_has_any_urm = as.numeric(spring_num_urm > 0),
    fall_has_any_non_urm = as.numeric(fall_num_non_urm > 0),
    spring_has_any_non_urm = as.numeric(spring_num_non_urm > 0),
    
    # Additional binary indicators for Black, Hispanic, and Female
    fall_has_any_black = as.numeric(fall_num_black > 0),
    spring_has_any_black = as.numeric(spring_num_black > 0),
    fall_has_any_hispanic = as.numeric(fall_num_hispanic > 0),
    spring_has_any_hispanic = as.numeric(spring_num_hispanic > 0),
    fall_has_any_female = as.numeric(fall_num_female > 0),
    spring_has_any_female = as.numeric(spring_num_female > 0),
    
    # For total speakers analysis
    pct_speakers = 100,  # All seminars have speakers by definition
    has_speakers = 1     # All seminars in dataset have speakers
  )

# Function to create clustered standard errors
get_clustered_se <- function(model, cluster_var) {
  vcov_cluster <- vcovCL(model, cluster = cluster_var)
  return(sqrt(diag(vcov_cluster)))
}

# Function to run regression with clustered SEs
run_regression <- function(formula_str, data_subset, cluster_var = "department_std") {
  # Remove rows with missing values in the model variables
  model_vars <- all.vars(as.formula(formula_str))
  # Ensure all model_vars are actually columns in data_subset
  model_vars <- model_vars[model_vars %in% names(data_subset)]
  
  data_complete <- data_subset[complete.cases(data_subset[, model_vars, drop = FALSE]), ]
  
  if (nrow(data_complete) < 30) {
    # warning("Less than 30 observations after removing missing values for formula: ", formula_str)
    return(NULL)
  }
  
  model <- lm(as.formula(formula_str), data = data_complete)
  
  # Get clustered standard errors
  cluster_data <- data_complete[[cluster_var]]
  model$cluster_se <- get_clustered_se(model, cluster_data)
  
  return(model)
}

# Define control variables
# Note: We omit batch_10 and bin_17_26 as reference categories to avoid perfect multicollinearity
# The bin categories in the data are: [0,1], (1,3], (3,5], (5,7], (7,11], (11,17], (17,26]
# We need to create bin_11_17 dummy since we're using bin_17_26 as reference
base_controls <- c("bin_0_1", "bin_1_3", "bin_3_5", "bin_5_7", "bin_7_11", "bin_11_17",
                   "disc_mathematics", "disc_physics", "disc_computer_science", 
                   "disc_mechanical_engineering",
                   "batch_1", "batch_2", "batch_3", "batch_4", "batch_5", 
                   "batch_6", "batch_7", "batch_8", "batch_9")

extended_controls <- c("total_faculty", "frac_urm_faculty", "frac_women_faculty",
                       "dept_ranking", "missing_dept_rank", 
                       "total_urm_peer_faculty", "total_peer_departments",
                       "num_recipients")

create_regression_table <- function(models, title, label, demographic_group = NULL, 
                                   is_moderator = FALSE, moderator_name = NULL) {
  
  # Filter out NULL models
  valid_models <- models[!sapply(models, is.null)]
  if (length(valid_models) == 0) {
    return(invisible(NULL))
  }
  
  n_models <- length(valid_models)
  
  # Name the models for modelsummary
  names(valid_models) <- paste0("(", 1:n_models, ")")
  
  # Determine which coefficients to show
  if (is_moderator) {
    # For moderation tables, we need to find the moderator and interaction names
    mod_name <- NULL
    int_name <- NULL
    for (m in valid_models) {
      coef_names <- names(coef(m))
      potential_mod <- setdiff(coef_names, c("treatment", "(Intercept)"))
      potential_mod <- potential_mod[!grepl(":", potential_mod)]
      if (length(potential_mod) > 0) {
        mod_name <- potential_mod[1]
        int_candidates <- coef_names[grepl(":", coef_names)]
        if (length(int_candidates) > 0) {
          int_name <- int_candidates[1]
          break
        }
      }
    }
    
    # Create coefficient map for moderation
    coef_map <- c("treatment" = "Treatment",
                  "(Intercept)" = "Constant")
    if (!is.null(mod_name)) {
      coef_map[mod_name] <- moderator_name
    }
    if (!is.null(int_name)) {
      coef_map[int_name] <- paste0("Treatment $\\times$ ", moderator_name)
    }
  } else {
    # For regular tables, just show treatment and intercept
    coef_map <- c("treatment" = "Treatment",
                  "(Intercept)" = "Constant")
  }
  
  # Always use manual approach for consistent spacing
  if (TRUE) {
    # Manual table generation (same as before but for all model counts)
    
    # Extract coefficients and standard errors
    extract_coef_se <- function(models, var_name) {
      coefs <- sapply(models, function(m) {
        if (var_name %in% names(coef(m))) {
          sprintf("%.3f", coef(m)[var_name])
        } else "—"
      })
      
      ses <- sapply(models, function(m) {
        if (var_name %in% names(m$cluster_se)) {
          sprintf("(%.3f)", m$cluster_se[var_name])
        } else ""
      })
      
      p_vals <- sapply(models, function(m) {
        if (var_name %in% names(coef(m)) && var_name %in% names(m$cluster_se)) {
          t_stat <- coef(m)[var_name] / m$cluster_se[var_name]
          2 * pt(-abs(t_stat), df = length(m$residuals) - length(coef(m)))
        } else NA
      })
      
      stars <- sapply(p_vals, function(p) {
        if (is.na(p)) return("")
        if (p < 0.001) return("***")
        if (p < 0.01) return("**")
        if (p < 0.05) return("*")
        if (p < 0.1) return("+")
        return("")
      })
      
      coef_stars <- ifelse(coefs == "—", "—", paste0(coefs, "$^{", stars, "}$"))
      
      list(coef_stars = coef_stars, ses = ses)
    }
    
    # Build the table manually
    cat("\\begin{table}[H]\n")
    cat(paste0("\\caption{", title, "}\n"))
    cat(paste0("\\label{", label, "}\n"))
    cat("\\centering\n")
    cat("\\scriptsize\n")
    
    # Try tabularx for better spacing control
    if (n_models == 6) {
      # Use tabularx with fixed total width
      cat("\\begin{tabularx}{\\textwidth}{l*{6}{>{\\centering\\arraybackslash}X}}\n")
    } else {
      cat(paste0("\\begin{tabular}{l", paste(rep("c", n_models), collapse = ""), "}\n"))
    }
    
    cat("\\toprule\n")
    
    # Headers for different table types - try without multicolumn to diagnose
    if (n_models == 6) {
      if (is_moderator && !is.null(demographic_group)) {
        # Use demographic_group for moderation tables too
        cat(paste0(" & \\% ", demographic_group, " & \\% ", demographic_group, 
                   " & Count ", demographic_group, " & Count ", demographic_group,
                   " & Any ", demographic_group, " & Any ", demographic_group, " \\\\\n"))
      } else if (!is.null(demographic_group)) {
        cat(paste0(" & \\% ", demographic_group, " & \\% ", demographic_group, 
                   " & Count ", demographic_group, " & Count ", demographic_group,
                   " & Any ", demographic_group, " & Any ", demographic_group, " \\\\\n"))
      } else {
        cat(" & Model 1 & Model 2 & Model 3 & Model 4 & Model 5 & Model 6 \\\\\n")
      }
    }
    
    # Model numbers
    cat(" & ", paste(paste0("(", 1:n_models, ")"), collapse = " & "), " \\\\\n")
    cat("\\midrule\n")
    
    # Add coefficient rows based on coef_map
    for (var_name in names(coef_map)) {
      var_data <- extract_coef_se(valid_models, var_name)
      cat(coef_map[var_name], " & ", paste(var_data$coef_stars, collapse = " & "), " \\\\\n")
      if (any(var_data$ses != "")) {
        cat(" & ", paste(var_data$ses, collapse = " & "), " \\\\\n")
      }
    }
    
    # Statistics
    cat("\\midrule\n")
    
    # Controls row
    if (n_models %% 2 == 0) {
      controls_text <- paste(rep(c("Simple", "Extended"), n_models/2), collapse = " & ")
    } else {
      controls_text <- paste(rep("Yes", n_models), collapse = " & ")
    }
    cat("Controls & ", controls_text, " \\\\\n")
    
    # N and R²
    n_obs <- sapply(valid_models, function(m) format(length(m$residuals), big.mark=","))
    adj_r2 <- sapply(valid_models, function(m) sprintf("%.3f", summary(m)$adj.r.squared))
    
    cat("N & ", paste(n_obs, collapse = " & "), " \\\\\n")
    cat("Adjusted $R^2$ & ", paste(adj_r2, collapse = " & "), " \\\\\n")
    
    cat("\\bottomrule\n")
    cat(paste0("\\multicolumn{", n_models + 1, "}{l}{\\parbox{\\linewidth}{\\footnotesize \\vspace{2pt}Clustered standard errors at department level in parentheses.}}\\\\\n"))
    cat(paste0("\\multicolumn{", n_models + 1, "}{l}{\\parbox{\\linewidth}{\\footnotesize $^{+}p<0.1$; $^{*}p<0.05$; $^{**}p<0.01$; $^{***}p<0.001$\\vspace{2pt}}}\\\\\n"))
    
    # Close the appropriate table environment
    if (n_models == 6) {
      cat("\\end{tabularx}\n")
    } else {
      cat("\\end{tabular}\n")
    }
    cat("\\end{table}\n")
    
    return(invisible(NULL))
  }
}

# Wrapper functions for compatibility
create_stargazer_table <- function(models, dep_var_labels, title, label, 
                                  keep_vars = c("treatment", "Constant"),
                                  covariate_labels = c("Treatment", "Constant"),
                                  demographic_group = NULL) {
  create_regression_table(models, title, label, demographic_group, 
                         is_moderator = FALSE, moderator_name = NULL)
}

create_moderator_table <- function(models, dep_var_labels, title, label, moderator_name) {
  create_regression_table(models, title, label, NULL, 
                         is_moderator = TRUE, moderator_name = moderator_name)
}


# Helper function to create intersectional variables
create_intersectional_vars <- function(data, demo1, demo2, label) {
  pct_col <- paste0("pct_", label)
  num_col <- paste0("approx_num_", label)
  has_col <- paste0("has_any_", label)
  
  data[[pct_col]] <- (data[[paste0("pct_", demo1)]] / 100) * 
                     (data[[paste0("pct_", demo2)]] / 100) * 100
  
  data[[num_col]] <- ifelse(data$speakers_with_demographics > 0,
                           round((data[[paste0("num_", demo1)]] / data$speakers_with_demographics) * 
                                 (data[[paste0("num_", demo2)]] / data$speakers_with_demographics) * 
                                 data$speakers_with_demographics),
                           0) 
  
  data[[num_col]][is.na(data[[num_col]])] <- 0
  data[[pct_col]][is.na(data[[pct_col]])] <- 0 
  
  data[[has_col]] <- as.numeric(data[[num_col]] > 0)
  
  return(data)
}

# Create all intersectional variables
data <- create_intersectional_vars(data, "urm", "female", "urm_female")
data <- create_intersectional_vars(data, "black", "female", "black_female")
data <- create_intersectional_vars(data, "black", "male", "black_male") 
data <- create_intersectional_vars(data, "hispanic", "female", "hispanic_female")
data <- create_intersectional_vars(data, "hispanic", "male", "hispanic_male") 


# Initialize list to store all models for significant results extraction
all_models_list <- list()

# Source moderation functions
source("moderation_analysis_fixed.R")

# Function to escape LaTeX special characters
escape_latex <- function(x) {
  if (is.null(x) || is.na(x)) return(x)
  x <- gsub("&", "\\\\&", x)
  x <- gsub("%", "\\\\%", x)
  x <- gsub("#", "\\\\#", x)
  x <- gsub("_", "\\\\_", x)
  x <- gsub("\\{", "\\\\{", x)
  x <- gsub("\\}", "\\\\}", x)
  x <- gsub("~", "\\\\textasciitilde{}", x)
  x <- gsub("\\^", "\\\\textasciicircum{}", x)
  return(x)
}
write.csv(data, 'master-data.csv', row.names=F)
```



\newpage

# Summary Statistics

## Overall Summary Statistics

### Seminar Speaker Demographics

```{r summary-stats-overall-seminars}
# Overall summary statistics for seminar speakers
summary_seminars <- data %>%
  summarise(
    n_seminars = n(),
    n_unique_departments = n_distinct(department_std),
    total_speakers_all = sum(total_speakers, na.rm = TRUE),
    mean_speakers_per_seminar = mean(total_speakers, na.rm = TRUE),
    sd_speakers_per_seminar = sd(total_speakers, na.rm = TRUE),
    min_speakers = min(total_speakers, na.rm = TRUE),
    max_speakers = max(total_speakers, na.rm = TRUE),
    
    # URM stats
    mean_pct_urm = mean(pct_urm, na.rm = TRUE),
    sd_pct_urm = sd(pct_urm, na.rm = TRUE),
    mean_num_urm = mean(num_urm, na.rm = TRUE),
    sd_num_urm = sd(num_urm, na.rm = TRUE),
    pct_seminars_has_urm = mean(has_any_urm, na.rm = TRUE) * 100,
    
    # Black stats
    mean_pct_black = mean(pct_black, na.rm = TRUE),
    sd_pct_black = sd(pct_black, na.rm = TRUE),
    mean_num_black = mean(num_black, na.rm = TRUE),
    sd_num_black = sd(num_black, na.rm = TRUE),
    pct_seminars_has_black = mean(has_any_black, na.rm = TRUE) * 100,
    
    # Hispanic stats
    mean_pct_hispanic = mean(pct_hispanic, na.rm = TRUE),
    sd_pct_hispanic = sd(pct_hispanic, na.rm = TRUE),
    mean_num_hispanic = mean(num_hispanic, na.rm = TRUE),
    sd_num_hispanic = sd(num_hispanic, na.rm = TRUE),
    pct_seminars_has_hispanic = mean(has_any_hispanic, na.rm = TRUE) * 100,
    
    # Female stats
    mean_pct_female = mean(pct_female, na.rm = TRUE),
    sd_pct_female = sd(pct_female, na.rm = TRUE),
    mean_num_female = mean(num_female, na.rm = TRUE),
    sd_num_female = sd(num_female, na.rm = TRUE),
    pct_seminars_has_female = mean(has_any_female, na.rm = TRUE) * 100
  )

# First table: Basic seminar information
cat("\\begin{table}[H]\n")
cat("\\caption{Overall Seminar Statistics}\n")
cat("\\label{tab:summary_seminars_basic}\n")
cat("\\centering\n")
cat("\\begin{tabular}{lr}\n")
cat("\\toprule\n")
cat("Statistic & Value \\\\\n")
cat("\\midrule\n")
cat(sprintf("Number of seminars & %d \\\\\n", summary_seminars$n_seminars))
cat(sprintf("Number of unique departments & %d \\\\\n", summary_seminars$n_unique_departments))
cat(sprintf("Total speakers across all seminars & %d \\\\\n", summary_seminars$total_speakers_all))
cat(sprintf("Mean speakers per seminar & %.2f \\\\\n", summary_seminars$mean_speakers_per_seminar))
cat(sprintf("SD speakers per seminar & %.2f \\\\\n", summary_seminars$sd_speakers_per_seminar))
cat(sprintf("Min speakers in a seminar & %d \\\\\n", summary_seminars$min_speakers))
cat(sprintf("Max speakers in a seminar & %d \\\\\n", summary_seminars$max_speakers))
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\end{table}\n")

# Second table: Speaker demographics in seminars
cat("\n\\begin{table}[H]\n")
cat("\\caption{Seminar Speaker Demographics (Across All Seminars)}\n")
cat("\\label{tab:summary_seminar_demographics}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccc}\n")
cat("\\toprule\n")
cat("Demographic Group & Mean \\% & SD \\% & Mean Count & SD Count & Pct. Any \\\\\n")
cat("\\midrule\n")
cat(sprintf("URM & %.2f & %.2f & %.2f & %.2f & %.1f \\\\\n",
            summary_seminars$mean_pct_urm, summary_seminars$sd_pct_urm,
            summary_seminars$mean_num_urm, summary_seminars$sd_num_urm,
            summary_seminars$pct_seminars_has_urm))
cat(sprintf("Black & %.2f & %.2f & %.2f & %.2f & %.1f \\\\\n",
            summary_seminars$mean_pct_black, summary_seminars$sd_pct_black,
            summary_seminars$mean_num_black, summary_seminars$sd_num_black,
            summary_seminars$pct_seminars_has_black))
cat(sprintf("Hispanic & %.2f & %.2f & %.2f & %.2f & %.1f \\\\\n",
            summary_seminars$mean_pct_hispanic, summary_seminars$sd_pct_hispanic,
            summary_seminars$mean_num_hispanic, summary_seminars$sd_num_hispanic,
            summary_seminars$pct_seminars_has_hispanic))
cat(sprintf("Female & %.2f & %.2f & %.2f & %.2f & %.1f \\\\\n",
            summary_seminars$mean_pct_female, summary_seminars$sd_pct_female,
            summary_seminars$mean_num_female, summary_seminars$sd_num_female,
            summary_seminars$pct_seminars_has_female))
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\parbox{\\linewidth}{\\footnotesize Note: N = ", summary_seminars$n_seminars, " seminars. Percentages calculated among speakers with demographic data available. 'Pct. Any' indicates the percentage of seminars that have at least one speaker from that demographic group.}\n")
cat("\\end{table}\n")
```

### Department Faculty Demographics

```{r summary-stats-overall-departments}
# Department faculty demographics (aggregated to department level)
dept_summary <- data %>%
  group_by(department_std) %>%
  summarise(
    # Take the first value for each department (since faculty demographics are constant within department)
    total_faculty = first(total_faculty),
    frac_urm_faculty = first(frac_urm_faculty),
    frac_women_faculty = first(frac_women_faculty),
    .groups = 'drop'
  ) %>%
  summarise(
    n_departments = n(),
    mean_total_faculty = mean(total_faculty, na.rm = TRUE),
    sd_total_faculty = sd(total_faculty, na.rm = TRUE),
    mean_pct_urm_faculty = mean(frac_urm_faculty * 100, na.rm = TRUE),
    sd_pct_urm_faculty = sd(frac_urm_faculty * 100, na.rm = TRUE),
    mean_pct_women_faculty = mean(frac_women_faculty * 100, na.rm = TRUE),
    sd_pct_women_faculty = sd(frac_women_faculty * 100, na.rm = TRUE)
  )

# Department faculty table
cat("\n\\begin{table}[H]\n")
cat("\\caption{Department Faculty Demographics}\n")
cat("\\label{tab:summary_dept_faculty}\n")
cat("\\centering\n")
cat("\\begin{tabular}{lcc}\n")
cat("\\toprule\n")
cat("Statistic & Mean & SD \\\\\n")
cat("\\midrule\n")
cat(sprintf("Total faculty per department & %.1f & %.1f \\\\\n",
            dept_summary$mean_total_faculty, dept_summary$sd_total_faculty))
cat(sprintf("\\%% URM faculty & %.2f & %.2f \\\\\n",
            dept_summary$mean_pct_urm_faculty, dept_summary$sd_pct_urm_faculty))
cat(sprintf("\\%% Women faculty & %.2f & %.2f \\\\\n",
            dept_summary$mean_pct_women_faculty, dept_summary$sd_pct_women_faculty))
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\parbox{\\linewidth}{\\footnotesize Note: N = ", dept_summary$n_departments, " unique departments. Department faculty demographics based on 2024 coding.}\n")
cat("\\end{table}\n")
```

## Summary Statistics by Discipline

### Seminar Speaker Demographics by Discipline

```{r summary-stats-discipline-seminars}
# Summary statistics by discipline for seminars
summary_by_disc_seminars <- data %>%
  mutate(discipline = case_when(
    disc_mathematics == 1 ~ "Mathematics",
    disc_physics == 1 ~ "Physics",
    disc_computer_science == 1 ~ "Computer Science",
    disc_mechanical_engineering == 1 ~ "Mechanical Engineering",
    TRUE ~ "Chemistry" # Default if none of the others are 1
  )) %>%
  group_by(discipline) %>%
  summarise(
    n_seminars = n(),
    n_departments = n_distinct(department_std),
    mean_speakers_per_seminar = mean(total_speakers, na.rm = TRUE),
    sd_speakers_per_seminar = sd(total_speakers, na.rm = TRUE),
    
    # URM stats
    mean_pct_urm = mean(pct_urm, na.rm = TRUE),
    sd_pct_urm = sd(pct_urm, na.rm = TRUE),
    mean_num_urm = mean(num_urm, na.rm = TRUE),
    pct_has_urm = mean(has_any_urm, na.rm = TRUE) * 100,
    
    # Black stats
    mean_pct_black = mean(pct_black, na.rm = TRUE),
    mean_num_black = mean(num_black, na.rm = TRUE),
    pct_has_black = mean(has_any_black, na.rm = TRUE) * 100,
    
    # Hispanic stats
    mean_pct_hispanic = mean(pct_hispanic, na.rm = TRUE),
    mean_num_hispanic = mean(num_hispanic, na.rm = TRUE),
    pct_has_hispanic = mean(has_any_hispanic, na.rm = TRUE) * 100,
    
    # Female stats
    mean_pct_female = mean(pct_female, na.rm = TRUE),
    mean_num_female = mean(num_female, na.rm = TRUE),
    pct_has_female = mean(has_any_female, na.rm = TRUE) * 100,
    
    .groups = 'drop'
  ) %>%
  arrange(discipline)

# Create formatted table for basic info
cat("\n\\begin{table}[H]\n")
cat("\\caption{Seminar Statistics by Discipline}\n")
cat("\\label{tab:summary_disc_basic}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lcccc}\n")
cat("\\toprule\n")
cat("Discipline & N Seminars & N Depts & Mean Speakers & SD Speakers \\\\\n")
cat("\\midrule\n")
for (i in 1:nrow(summary_by_disc_seminars)) {
  cat(sprintf("%s & %d & %d & %.1f & %.1f \\\\\n",
              summary_by_disc_seminars$discipline[i],
              summary_by_disc_seminars$n_seminars[i],
              summary_by_disc_seminars$n_departments[i],
              summary_by_disc_seminars$mean_speakers_per_seminar[i],
              summary_by_disc_seminars$sd_speakers_per_seminar[i]))
}
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\end{table}\n")

# Create formatted table for URM
cat("\n\\begin{table}[H]\n")
cat("\\caption{Seminar Speaker Demographics by Discipline: URM}\n")
cat("\\label{tab:summary_disc_urm}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccc}\n")
cat("\\toprule\n")
cat("Discipline & N Seminars & Mean \\% & SD \\% & Mean Count & Pct. Has Any \\\\\n")
cat("\\midrule\n")
for (i in 1:nrow(summary_by_disc_seminars)) {
  cat(sprintf("%s & %d & %.2f & %.2f & %.2f & %.1f \\\\\n",
              summary_by_disc_seminars$discipline[i],
              summary_by_disc_seminars$n_seminars[i],
              summary_by_disc_seminars$mean_pct_urm[i],
              summary_by_disc_seminars$sd_pct_urm[i],
              summary_by_disc_seminars$mean_num_urm[i],
              summary_by_disc_seminars$pct_has_urm[i]))
}
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\parbox{\\linewidth}{\\footnotesize Note: Statistics are for seminar speakers. 'Pct. Has Any' indicates percentage of seminars with at least one URM speaker.}\n")
cat("\\end{table}\n")

# Create formatted table for other demographics
cat("\n\\begin{table}[H]\n")
cat("\\caption{Seminar Speaker Demographics by Discipline: Other Groups}\n")
cat("\\label{tab:summary_disc_other}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lcccccc}\n")
cat("\\toprule\n")
cat(" & \\multicolumn{2}{c}{Black} & \\multicolumn{2}{c}{Hispanic} & \\multicolumn{2}{c}{Female} \\\\\n")
cat("Discipline & Mean \\% & Pct. Any & Mean \\% & Pct. Any & Mean \\% & Pct. Any \\\\\n")
cat("\\midrule\n")
for (i in 1:nrow(summary_by_disc_seminars)) {
  cat(sprintf("%s & %.2f & %.1f & %.2f & %.1f & %.2f & %.1f \\\\\n",
              summary_by_disc_seminars$discipline[i],
              summary_by_disc_seminars$mean_pct_black[i],
              summary_by_disc_seminars$pct_has_black[i],
              summary_by_disc_seminars$mean_pct_hispanic[i],
              summary_by_disc_seminars$pct_has_hispanic[i],
              summary_by_disc_seminars$mean_pct_female[i],
              summary_by_disc_seminars$pct_has_female[i]))
}
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\parbox{\\linewidth}{\\footnotesize Note: Statistics are for seminar speakers. 'Pct. Any' indicates percentage of seminars with at least one speaker from that group.}\n")
cat("\\end{table}\n")

```

### Department Faculty Demographics by Discipline

```{r summary-stats-discipline-departments, results='asis'}
# Department faculty demographics by discipline
dept_by_disc <- data %>%
  mutate(discipline = case_when(
    disc_mathematics == 1 ~ "Mathematics",
    disc_physics == 1 ~ "Physics",
    disc_computer_science == 1 ~ "Computer Science",
    disc_mechanical_engineering == 1 ~ "Mechanical Engineering",
    TRUE ~ "Chemistry"
  )) %>%
  group_by(discipline, department_std) %>%
  summarise(
    total_faculty = first(total_faculty),
    frac_urm_faculty = first(frac_urm_faculty),
    frac_women_faculty = first(frac_women_faculty),
    .groups = 'drop'
  ) %>%
  group_by(discipline) %>%
  summarise(
    n_departments = n(),
    mean_total_faculty = mean(total_faculty, na.rm = TRUE),
    sd_total_faculty = sd(total_faculty, na.rm = TRUE),
    mean_pct_urm_faculty = mean(frac_urm_faculty * 100, na.rm = TRUE),
    sd_pct_urm_faculty = sd(frac_urm_faculty * 100, na.rm = TRUE),
    mean_pct_women_faculty = mean(frac_women_faculty * 100, na.rm = TRUE),
    sd_pct_women_faculty = sd(frac_women_faculty * 100, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  arrange(discipline)

# Create department faculty table
cat("\n\\begin{table}[H]\n")
cat("\\caption{Department Faculty Demographics by Discipline}\n")
cat("\\label{tab:summary_disc_dept_faculty}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccccc}\n")
cat("\\toprule\n")
cat(" & & \\multicolumn{2}{c}{Faculty Size} & \\multicolumn{2}{c}{\\% URM Faculty} & \\multicolumn{2}{c}{\\% Women Faculty} \\\\\n")
cat("Discipline & N Depts & Mean & SD & Mean & SD & Mean & SD \\\\\n")
cat("\\midrule\n")
for (i in 1:nrow(dept_by_disc)) {
  cat(sprintf("%s & %d & %.1f & %.1f & %.2f & %.2f & %.2f & %.2f \\\\\n",
              dept_by_disc$discipline[i],
              dept_by_disc$n_departments[i],
              dept_by_disc$mean_total_faculty[i],
              dept_by_disc$sd_total_faculty[i],
              dept_by_disc$mean_pct_urm_faculty[i],
              dept_by_disc$sd_pct_urm_faculty[i],
              dept_by_disc$mean_pct_women_faculty[i],
              dept_by_disc$sd_pct_women_faculty[i]))
}
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\parbox{\\linewidth}{\\footnotesize Note: Department faculty demographics based on 2024 coding.}\n")
cat("\\end{table}\n")
```

## Summary Statistics by Semester

```{r summary-stats-semester}
# Fall semester statistics
fall_summary <- data %>%
  filter(has_fall_speakers == 1) %>%
  summarise(
    n = n(),
    mean_pct_urm = mean(fall_pct_urm, na.rm = TRUE),
    sd_pct_urm = sd(fall_pct_urm, na.rm = TRUE),
    mean_num_urm = mean(fall_num_urm, na.rm = TRUE),
    pct_has_urm = mean(fall_has_any_urm, na.rm = TRUE) * 100,
    mean_pct_black = mean(fall_pct_black, na.rm = TRUE),
    pct_has_black = mean(fall_has_any_black, na.rm = TRUE) * 100,
    mean_pct_hispanic = mean(fall_pct_hispanic, na.rm = TRUE),
    pct_has_hispanic = mean(fall_has_any_hispanic, na.rm = TRUE) * 100,
    mean_pct_female = mean(fall_pct_female, na.rm = TRUE),
    mean_num_female = mean(fall_num_female, na.rm = TRUE),
    pct_has_female = mean(fall_has_any_female, na.rm = TRUE) * 100,
    mean_total = mean(fall_total_speakers, na.rm = TRUE),
    sd_total = sd(fall_total_speakers, na.rm = TRUE) # Added SD for total speakers
  )

# Spring semester statistics
spring_summary <- data %>%
  filter(has_spring_speakers == 1) %>%
  summarise(
    n = n(),
    mean_pct_urm = mean(spring_pct_urm, na.rm = TRUE),
    sd_pct_urm = sd(spring_pct_urm, na.rm = TRUE),
    mean_num_urm = mean(spring_num_urm, na.rm = TRUE),
    pct_has_urm = mean(spring_has_any_urm, na.rm = TRUE) * 100,
    mean_pct_black = mean(spring_pct_black, na.rm = TRUE),
    pct_has_black = mean(spring_has_any_black, na.rm = TRUE) * 100,
    mean_pct_hispanic = mean(spring_pct_hispanic, na.rm = TRUE),
    pct_has_hispanic = mean(spring_has_any_hispanic, na.rm = TRUE) * 100,
    mean_pct_female = mean(spring_pct_female, na.rm = TRUE),
    mean_num_female = mean(spring_num_female, na.rm = TRUE),
    pct_has_female = mean(spring_has_any_female, na.rm = TRUE) * 100,
    mean_total = mean(spring_total_speakers, na.rm = TRUE),
    sd_total = sd(spring_total_speakers, na.rm = TRUE) # Added SD for total speakers
  )

# Create formatted table
cat("\n\\begin{table}[H]\n")
cat("\\caption{Summary Statistics by Semester}\n")
cat("\\label{tab:summary_semester}\n")
cat("\\centering\n")
cat("\\footnotesize\n")
cat("\\begin{tabular}{lccccccc}\n")
cat("\\toprule\n")
cat(" & \\multicolumn{3}{c}{URM} & \\multicolumn{2}{c}{Black} & \\multicolumn{2}{c}{Hispanic} \\\\\n")
cat("Semester (N) & Mean \\% & Mean Count & Pct. Any & Mean \\% & Pct. Any & Mean \\% & Pct. Any \\\\\n")
cat("\\midrule\n")
cat(sprintf("Fall (%d) & %.2f & %.2f & %.1f & %.2f & %.1f & %.2f & %.1f \\\\\n",
            fall_summary$n,
            fall_summary$mean_pct_urm,
            fall_summary$mean_num_urm,
            fall_summary$pct_has_urm,
            fall_summary$mean_pct_black,
            fall_summary$pct_has_black,
            fall_summary$mean_pct_hispanic,
            fall_summary$pct_has_hispanic))
cat(sprintf("Spring (%d) & %.2f & %.2f & %.1f & %.2f & %.1f & %.2f & %.1f \\\\\n",
            spring_summary$n,
            spring_summary$mean_pct_urm,
            spring_summary$mean_num_urm,
            spring_summary$pct_has_urm,
            spring_summary$mean_pct_black,
            spring_summary$pct_has_black,
            spring_summary$mean_pct_hispanic,
            spring_summary$pct_has_hispanic))
cat("\\midrule\n")
cat(" & \\multicolumn{3}{c}{Female} & \\multicolumn{2}{c}{Total Speakers} & & \\\\\n")
cat("Semester & Mean \\% & Mean Count & Pct. Any & Mean & SD & & \\\\\n")
cat("\\midrule\n")
cat(sprintf("Fall & %.2f & %.2f & %.1f & %.2f & %.2f & & \\\\\n", # Added SD
            fall_summary$mean_pct_female,
            fall_summary$mean_num_female,
            fall_summary$pct_has_female,
            fall_summary$mean_total,
            fall_summary$sd_total)) # Added SD
cat(sprintf("Spring & %.2f & %.2f & %.1f & %.2f & %.2f & & \\\\\n", # Added SD
            spring_summary$mean_pct_female,
            spring_summary$mean_num_female,
            spring_summary$pct_has_female,
            spring_summary$mean_total,
            spring_summary$sd_total)) # Added SD
cat("\\bottomrule\n")
cat("\\end{tabular}\n")
cat("\\end{table}\n")

```

\newpage

# Main Effects Analysis

## Main Question 1: URM Speaker Representation

```{r mq1-urm}
# MQ1: URM percentage, count, and binary
# Model 1 - Basic controls
pct_urm_m1 <- run_regression(paste("pct_urm ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_urm_m1 <- run_regression(paste("num_urm ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_urm_m1 <- run_regression(paste("has_any_urm ~ treatment +", paste(base_controls, collapse = " + ")), data)

# Model 2 - Extended controls
pct_urm_m2 <- run_regression(paste("pct_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_urm_m2 <- run_regression(paste("num_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_urm_m2 <- run_regression(paste("has_any_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_urm_m1, analysis = "Main Effects", outcome = "% URM", model_type = "Simple"),
  list(model = pct_urm_m2, analysis = "Main Effects", outcome = "% URM", model_type = "Extended"),
  list(model = count_urm_m1, analysis = "Main Effects", outcome = "Count URM", model_type = "Simple"),
  list(model = count_urm_m2, analysis = "Main Effects", outcome = "Count URM", model_type = "Extended"),
  list(model = binary_urm_m1, analysis = "Main Effects", outcome = "Any URM", model_type = "Simple"),
  list(model = binary_urm_m2, analysis = "Main Effects", outcome = "Any URM", model_type = "Extended")
))

create_stargazer_table(
  list(pct_urm_m1, pct_urm_m2, count_urm_m1, count_urm_m2, binary_urm_m1, binary_urm_m2),
  c("\\\\% URM", "\\\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Main Question 1: Effect on URM Speaker Representation",
  "tab:mq1_urm",
  demographic_group = "URM"
)
```

\newpage

## Main Questions 2a-2c: Effects on Speaker Counts

```{r mq2-all}
# MQ2a: Total speakers
count_total_m1 <- run_regression(paste("total_speakers ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_total_m2 <- run_regression(paste("total_speakers ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# MQ2b: URM speakers (count)
# count_urm_m1 and count_urm_m2 are already defined in mq1-urm, re-using them.

# MQ2c: Non-URM speakers
count_non_urm_m1 <- run_regression(paste("num_non_urm ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_non_urm_m2 <- run_regression(paste("num_non_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = count_total_m1, analysis = "Main Effects", outcome = "Total Speakers", model_type = "Simple"),
  list(model = count_total_m2, analysis = "Main Effects", outcome = "Total Speakers", model_type = "Extended"),
  # URM count models already added in mq1-urm
  list(model = count_non_urm_m1, analysis = "Main Effects", outcome = "Count Non-URM", model_type = "Simple"),
  list(model = count_non_urm_m2, analysis = "Main Effects", outcome = "Count Non-URM", model_type = "Extended")
))

# Combined table
create_stargazer_table(
  list(count_total_m1, count_total_m2, count_urm_m1, count_urm_m2, count_non_urm_m1, count_non_urm_m2),
  c("Total", "Total", "URM", "URM", "Non-URM", "Non-URM"),
  "Main Questions 2a-2c: Effects on Speaker Counts",
  "tab:mq2_all",
  demographic_group = "Count" # This will set the column headers for % Count, Count Count, Any Count
)
```

## Seemingly Unrelated Regression (SUR) Analysis

```{r sur-analysis}
# SUR to test whether effects on URM and non-URM speakers are equal and opposite
# Per pre-registration: test if treatment increases URM at expense of non-URM

# Function to safely run SUR with error handling (Model 1 only)
run_sur_analysis <- function(data, base_controls) {
  
  tryCatch({
    # Prepare equations for SUR
    # Model 1 - Basic controls only
    eq1_m1 <- as.formula(paste("num_urm ~ treatment +", paste(base_controls, collapse = " + ")))
    eq2_m1 <- as.formula(paste("num_non_urm ~ treatment +", paste(base_controls, collapse = " + ")))
    
    # Run SUR model with control for method
    sur_m1 <- systemfit(list(URM = eq1_m1, NonURM = eq2_m1), 
                       method = "SUR", 
                       data = data,
                       control = systemfit.control(tol = 1e-5))
    
    # Test whether treatment effects are equal and opposite
    # H0: b1_URM + b1_NonURM = 0 (effects sum to zero)
    # H1: b1_URM + b1_NonURM ≠ 0
    
    test_m1 <- linearHypothesis(sur_m1, "URM_treatment + NonURM_treatment = 0")
    
    # Extract coefficients and SEs
    urm_coef_m1 <- coef(sur_m1$eq[[1]])["treatment"]
    urm_se_m1 <- sqrt(diag(vcov(sur_m1$eq[[1]]))["treatment"])
    non_urm_coef_m1 <- coef(sur_m1$eq[[2]])["treatment"]
    non_urm_se_m1 <- sqrt(diag(vcov(sur_m1$eq[[2]]))["treatment"])
    
    return(list(
      success = TRUE,
      urm_coef_m1 = urm_coef_m1, urm_se_m1 = urm_se_m1,
      non_urm_coef_m1 = non_urm_coef_m1, non_urm_se_m1 = non_urm_se_m1,
      test_m1 = test_m1
    ))
    
  }, error = function(e) {
    # If SUR fails, fall back to individual OLS estimates
    # These are already computed above as count_urm_m1, count_non_urm_m1
    
    # Extract coefficients from individual models
    urm_coef_m1 <- if(!is.null(count_urm_m1)) coef(count_urm_m1)["treatment"] else NA
    urm_se_m1 <- if(!is.null(count_urm_m1)) count_urm_m1$cluster_se["treatment"] else NA
    non_urm_coef_m1 <- if(!is.null(count_non_urm_m1)) coef(count_non_urm_m1)["treatment"] else NA
    non_urm_se_m1 <- if(!is.null(count_non_urm_m1)) count_non_urm_m1$cluster_se["treatment"] else NA
    
    return(list(
      success = FALSE,
      error_msg = e$message,
      urm_coef_m1 = urm_coef_m1, urm_se_m1 = urm_se_m1,
      non_urm_coef_m1 = non_urm_coef_m1, non_urm_se_m1 = non_urm_se_m1,
      test_m1 = NULL
    ))
  })
}

# Run the analysis
sur_results <- run_sur_analysis(data, base_controls)

# Create summary table
cat("\n\\begin{table}[H]\n")
cat("\\caption{SUR Analysis: Testing Substitution Between URM and Non-URM Speakers}\n")
cat("\\label{tab:sur_analysis}\n")
cat("\\centering\n")
cat("\\begin{tabular}{lcc}\n")
cat("\\toprule\n")
cat("Outcome & Coefficient & SE \\\\\n")
cat("\\midrule\n")

cat(sprintf("URM Speakers & %.4f & (%.4f) \\\\\n",
            sur_results$urm_coef_m1, sur_results$urm_se_m1))
cat(sprintf("Non-URM Speakers & %.4f & (%.4f) \\\\\n",
            sur_results$non_urm_coef_m1, sur_results$non_urm_se_m1))
cat("\\midrule\n")
cat(sprintf("Sum of Effects & %.4f & --- \\\\\n",
            sur_results$urm_coef_m1 + sur_results$non_urm_coef_m1))

if (sur_results$success && !is.null(sur_results$test_m1)) {
  cat("\\midrule\n")
  cat("\\multicolumn{3}{l}{\\textit{Wald Test: H0: Treatment effect on URM + Treatment effect on Non-URM = 0}} \\\\\n")
  cat(sprintf("Chi-squared & %.3f & \\\\\n", 
              sur_results$test_m1$Chisq[2]))
  cat(sprintf("p-value & %.4f & \\\\\n", 
              sur_results$test_m1$`Pr(>Chisq)`[2]))
} else {
  cat("\\midrule\n")
  cat("\\multicolumn{3}{l}{\\textit{Note: SUR estimation failed; showing OLS estimates with clustered SEs}} \\\\\n")
  # Can still test sum = 0 informally
  sum_m1 <- sur_results$urm_coef_m1 + sur_results$non_urm_coef_m1
  cat(sprintf("\\multicolumn{3}{l}{\\textit{Sum of effects: %.4f}} \\\\\n",
              sum_m1))
}

cat("\\bottomrule\n")
cat("\\end{tabular}\n")

if (sur_results$success) {
  cat("\\parbox{\\linewidth}{\\footnotesize Note: SUR estimation with simple controls allows for correlation between equation errors. The Wald test examines whether the treatment effect represents a pure substitution (increasing URM speakers while decreasing non-URM speakers by the same amount).}\n")
} else {
  cat("\\parbox{\\linewidth}{\\footnotesize Note: SUR estimation failed due to computational issues. Table shows OLS estimates with clustered standard errors. The sum of effects being close to zero suggests a substitution pattern even without formal SUR testing.}\n")
}
cat("\\end{table}\n")
```

\newpage

# Demographic Subgroup Analysis

## Black Speakers

```{r black-speakers}
# Black speakers
pct_black_m1 <- run_regression(paste("pct_black ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_black_m1 <- run_regression(paste("num_black ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_black_m1 <- run_regression(paste("has_any_black ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_black_m2 <- run_regression(paste("pct_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_black_m2 <- run_regression(paste("num_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_black_m2 <- run_regression(paste("has_any_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_black_m1, analysis = "Demographic Subgroup", outcome = "% Black", model_type = "Simple"),
  list(model = pct_black_m2, analysis = "Demographic Subgroup", outcome = "% Black", model_type = "Extended"),
  list(model = count_black_m1, analysis = "Demographic Subgroup", outcome = "Count Black", model_type = "Simple"),
  list(model = count_black_m2, analysis = "Demographic Subgroup", outcome = "Count Black", model_type = "Extended"),
  list(model = binary_black_m1, analysis = "Demographic Subgroup", outcome = "Any Black", model_type = "Simple"),
  list(model = binary_black_m2, analysis = "Demographic Subgroup", outcome = "Any Black", model_type = "Extended")
))

create_stargazer_table(
  list(pct_black_m1, pct_black_m2, count_black_m1, count_black_m2, binary_black_m1, binary_black_m2),
  c("\\\\% Black", "\\\\% Black", "Count Black", "Count Black", "Any Black", "Any Black"),
  "Effect on Black Speakers",
  "tab:black",
  demographic_group = "Black"
)
```

## Hispanic Speakers

```{r hispanic-speakers}
# Hispanic speakers
pct_hispanic_m1 <- run_regression(paste("pct_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_hispanic_m1 <- run_regression(paste("num_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_hispanic_m1 <- run_regression(paste("has_any_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_hispanic_m2 <- run_regression(paste("pct_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_hispanic_m2 <- run_regression(paste("num_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_hispanic_m2 <- run_regression(paste("has_any_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_hispanic_m1, analysis = "Demographic Subgroup", outcome = "% Hispanic", model_type = "Simple"),
  list(model = pct_hispanic_m2, analysis = "Demographic Subgroup", outcome = "% Hispanic", model_type = "Extended"),
  list(model = count_hispanic_m1, analysis = "Demographic Subgroup", outcome = "Count Hispanic", model_type = "Simple"),
  list(model = count_hispanic_m2, analysis = "Demographic Subgroup", outcome = "Count Hispanic", model_type = "Extended"),
  list(model = binary_hispanic_m1, analysis = "Demographic Subgroup", outcome = "Any Hispanic", model_type = "Simple"),
  list(model = binary_hispanic_m2, analysis = "Demographic Subgroup", outcome = "Any Hispanic", model_type = "Extended")
))

create_stargazer_table(
  list(pct_hispanic_m1, pct_hispanic_m2, count_hispanic_m1, count_hispanic_m2, binary_hispanic_m1, binary_hispanic_m2),
  c("\\\\% Hispanic", "\\\\% Hispanic", "Count Hispanic", "Count Hispanic", "Any Hispanic", "Any Hispanic"),
  "Effect on Hispanic Speakers",
  "tab:hispanic",
  demographic_group = "Hispanic"
)
```

## Female Speakers

```{r female-speakers}
# Female speakers
pct_female_m1 <- run_regression(paste("pct_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_female_m1 <- run_regression(paste("num_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_female_m1 <- run_regression(paste("has_any_female ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_female_m2 <- run_regression(paste("pct_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_female_m2 <- run_regression(paste("num_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_female_m2 <- run_regression(paste("has_any_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_female_m1, analysis = "Demographic Subgroup", outcome = "% Female", model_type = "Simple"),
  list(model = pct_female_m2, analysis = "Demographic Subgroup", outcome = "% Female", model_type = "Extended"),
  list(model = count_female_m1, analysis = "Demographic Subgroup", outcome = "Count Female", model_type = "Simple"),
  list(model = count_female_m2, analysis = "Demographic Subgroup", outcome = "Count Female", model_type = "Extended"),
  list(model = binary_female_m1, analysis = "Demographic Subgroup", outcome = "Any Female", model_type = "Simple"),
  list(model = binary_female_m2, analysis = "Demographic Subgroup", outcome = "Any Female", model_type = "Extended")
))

create_stargazer_table(
  list(pct_female_m1, pct_female_m2, count_female_m1, count_female_m2, binary_female_m1, binary_female_m2),
  c("\\\\% Female", "\\\\% Female", "Count Female", "Count Female", "Any Female", "Any Female"),
  "Effect on Female Speakers",
  "tab:female",
  demographic_group = "Female"
)
```

## URM Female

```{r urm-female}
# URM-Female intersection
pct_urm_female_m1 <- run_regression(paste("pct_urm_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_urm_female_m1 <- run_regression(paste("approx_num_urm_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_urm_female_m1 <- run_regression(paste("has_any_urm_female ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_urm_female_m2 <- run_regression(paste("pct_urm_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_urm_female_m2 <- run_regression(paste("approx_num_urm_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_urm_female_m2 <- run_regression(paste("has_any_urm_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_urm_female_m1, analysis = "Demographic Subgroup", outcome = "% URM Female", model_type = "Simple"),
  list(model = pct_urm_female_m2, analysis = "Demographic Subgroup", outcome = "% URM Female", model_type = "Extended"),
  list(model = count_urm_female_m1, analysis = "Demographic Subgroup", outcome = "Count URM Female", model_type = "Simple"),
  list(model = count_urm_female_m2, analysis = "Demographic Subgroup", outcome = "Count URM Female", model_type = "Extended"),
  list(model = binary_urm_female_m1, analysis = "Demographic Subgroup", outcome = "Any URM Female", model_type = "Simple"),
  list(model = binary_urm_female_m2, analysis = "Demographic Subgroup", outcome = "Any URM Female", model_type = "Extended")
))

create_stargazer_table(
  list(pct_urm_female_m1, pct_urm_female_m2, count_urm_female_m1, count_urm_female_m2, binary_urm_female_m1, binary_urm_female_m2),
  c("\\\\% URM Female", "\\\\% URM Female", "Count URM Female", "Count URM Female", "Any URM Female", "Any URM Female"),
  "Effect on URM Female Speakers",
  "tab:urm_female",
  demographic_group = "URM Female"
)
```

## Black Female

```{r black-female}
# Black-Female intersection
pct_black_female_m1 <- run_regression(paste("pct_black_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_black_female_m1 <- run_regression(paste("approx_num_black_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_black_female_m1 <- run_regression(paste("has_any_black_female ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_black_female_m2 <- run_regression(paste("pct_black_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_black_female_m2 <- run_regression(paste("approx_num_black_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_black_female_m2 <- run_regression(paste("has_any_black_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_black_female_m1, analysis = "Demographic Subgroup", outcome = "% Black Female", model_type = "Simple"),
  list(model = pct_black_female_m2, analysis = "Demographic Subgroup", outcome = "% Black Female", model_type = "Extended"),
  list(model = count_black_female_m1, analysis = "Demographic Subgroup", outcome = "Count Black Female", model_type = "Simple"),
  list(model = count_black_female_m2, analysis = "Demographic Subgroup", outcome = "Count Black Female", model_type = "Extended"),
  list(model = binary_black_female_m1, analysis = "Demographic Subgroup", outcome = "Any Black Female", model_type = "Simple"),
  list(model = binary_black_female_m2, analysis = "Demographic Subgroup", outcome = "Any Black Female", model_type = "Extended")
))

create_stargazer_table(
  list(pct_black_female_m1, pct_black_female_m2, count_black_female_m1, count_black_female_m2, binary_black_female_m1, binary_black_female_m2),
  c("\\\\% Black Female", "\\\\% Black Female", "Count Black Female", "Count Black Female", "Any Black Female", "Any Black Female"),
  "Effect on Black Female Speakers",
  "tab:black_female",
  demographic_group = "Black Female"
)
```

## Black Male

```{r black-male}
# Black-Male intersection
pct_black_male_m1 <- run_regression(paste("pct_black_male ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_black_male_m1 <- run_regression(paste("approx_num_black_male ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_black_male_m1 <- run_regression(paste("has_any_black_male ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_black_male_m2 <- run_regression(paste("pct_black_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_black_male_m2 <- run_regression(paste("approx_num_black_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_black_male_m2 <- run_regression(paste("has_any_black_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_black_male_m1, analysis = "Demographic Subgroup", outcome = "% Black Male", model_type = "Simple"),
  list(model = pct_black_male_m2, analysis = "Demographic Subgroup", outcome = "% Black Male", model_type = "Extended"),
  list(model = count_black_male_m1, analysis = "Demographic Subgroup", outcome = "Count Black Male", model_type = "Simple"),
  list(model = count_black_male_m2, analysis = "Demographic Subgroup", outcome = "Count Black Male", model_type = "Extended"),
  list(model = binary_black_male_m1, analysis = "Demographic Subgroup", outcome = "Any Black Male", model_type = "Simple"),
  list(model = binary_black_male_m2, analysis = "Demographic Subgroup", outcome = "Any Black Male", model_type = "Extended")
))

create_stargazer_table(
  list(pct_black_male_m1, pct_black_male_m2, count_black_male_m1, count_black_male_m2, binary_black_male_m1, binary_black_male_m2),
  c("\\\\% Black Male", "\\\\% Black Male", "Count Black Male", "Count Black Male", "Any Black Male", "Any Black Male"),
  "Effect on Black Male Speakers",
  "tab:black_male",
  demographic_group = "Black Male"
)
```

## Hispanic Female

```{r hispanic-female}
# Hispanic-Female intersection
pct_hispanic_female_m1 <- run_regression(paste("pct_hispanic_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_hispanic_female_m1 <- run_regression(paste("approx_num_hispanic_female ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_hispanic_female_m1 <- run_regression(paste("has_any_hispanic_female ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_hispanic_female_m2 <- run_regression(paste("pct_hispanic_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_hispanic_female_m2 <- run_regression(paste("approx_num_hispanic_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_hispanic_female_m2 <- run_regression(paste("has_any_hispanic_female ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_hispanic_female_m1, analysis = "Demographic Subgroup", outcome = "% Hispanic Female", model_type = "Simple"),
  list(model = pct_hispanic_female_m2, analysis = "Demographic Subgroup", outcome = "% Hispanic Female", model_type = "Extended"),
  list(model = count_hispanic_female_m1, analysis = "Demographic Subgroup", outcome = "Count Hispanic Female", model_type = "Simple"),
  list(model = count_hispanic_female_m2, analysis = "Demographic Subgroup", outcome = "Count Hispanic Female", model_type = "Extended"),
  list(model = binary_hispanic_female_m1, analysis = "Demographic Subgroup", outcome = "Any Hispanic Female", model_type = "Simple"),
  list(model = binary_hispanic_female_m2, analysis = "Demographic Subgroup", outcome = "Any Hispanic Female", model_type = "Extended")
))

create_stargazer_table(
  list(pct_hispanic_female_m1, pct_hispanic_female_m2, count_hispanic_female_m1, count_hispanic_female_m2, binary_hispanic_female_m1, binary_hispanic_female_m2),
  c("\\\\% Hispanic Female", "\\\\% Hispanic Female", "Count Hispanic Female", "Count Hispanic Female", "Any Hispanic Female", "Any Hispanic Female"),
  "Effect on Hispanic Female Speakers",
  "tab:hispanic_female",
  demographic_group = "Hispanic Female"
)
```

## Hispanic Male

```{r hispanic-male}
# Hispanic-Male intersection
pct_hispanic_male_m1 <- run_regression(paste("pct_hispanic_male ~ treatment +", paste(base_controls, collapse = " + ")), data)
count_hispanic_male_m1 <- run_regression(paste("approx_num_hispanic_male ~ treatment +", paste(base_controls, collapse = " + ")), data)
binary_hispanic_male_m1 <- run_regression(paste("has_any_hispanic_male ~ treatment +", paste(base_controls, collapse = " + ")), data)

pct_hispanic_male_m2 <- run_regression(paste("pct_hispanic_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
count_hispanic_male_m2 <- run_regression(paste("approx_num_hispanic_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)
binary_hispanic_male_m2 <- run_regression(paste("has_any_hispanic_male ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_hispanic_male_m1, analysis = "Demographic Subgroup", outcome = "% Hispanic Male", model_type = "Simple"),
  list(model = pct_hispanic_male_m2, analysis = "Demographic Subgroup", outcome = "% Hispanic Male", model_type = "Extended"),
  list(model = count_hispanic_male_m1, analysis = "Demographic Subgroup", outcome = "Count Hispanic Male", model_type = "Simple"),
  list(model = count_hispanic_male_m2, analysis = "Demographic Subgroup", outcome = "Count Hispanic Male", model_type = "Extended"),
  list(model = binary_hispanic_male_m1, analysis = "Demographic Subgroup", outcome = "Any Hispanic Male", model_type = "Simple"),
  list(model = binary_hispanic_male_m2, analysis = "Demographic Subgroup", outcome = "Any Hispanic Male", model_type = "Extended")
))

create_stargazer_table(
  list(pct_hispanic_male_m1, pct_hispanic_male_m2, count_hispanic_male_m1, count_hispanic_male_m2, binary_hispanic_male_m1, binary_hispanic_male_m2),
  c("\\\\% Hispanic Male", "\\\\% Hispanic Male", "Count Hispanic Male", "Count Hispanic Male", "Any Hispanic Male", "Any Hispanic Male"),
  "Effect on Hispanic Male Speakers",
  "tab:hispanic_male",
  demographic_group = "Hispanic Male"
)
```

\newpage

# Discipline Subgroup Analysis

```{r discipline-subgroup}
# Run main treatment effect models separately for each discipline
disciplines <- list(
  list("Chemistry", data %>% filter(disc_mathematics == 0 & disc_physics == 0 & 
                                    disc_computer_science == 0 & disc_mechanical_engineering == 0)),
  list("Mathematics", data %>% filter(disc_mathematics == 1)),
  list("Physics", data %>% filter(disc_physics == 1)),
  list("Computer Science", data %>% filter(disc_computer_science == 1)),
  list("Mechanical Engineering", data %>% filter(disc_mechanical_engineering == 1))
)

# Store results for each discipline
discipline_results <- list()

for (disc_info in disciplines) {
  disc_name <- disc_info[[1]]
  disc_data <- disc_info[[2]]
  
  cat("\n\\subsubsection{", disc_name, " (N=", nrow(disc_data), ")}\n\n", sep="") # Changed to subsubsection
  
  # Run models for this discipline
  if (nrow(disc_data) >= 30) {
    # Percentage models
    pct_m1 <- run_regression(paste("pct_urm ~ treatment +", paste(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  collapse = " + ")), disc_data)
    pct_m2 <- run_regression(paste("pct_urm ~ treatment +", paste(c(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  extended_controls), collapse = " + ")), disc_data)
    
    # Count models
    count_m1 <- run_regression(paste("num_urm ~ treatment +", paste(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    collapse = " + ")), disc_data)
    count_m2 <- run_regression(paste("num_urm ~ treatment +", paste(c(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    extended_controls), collapse = " + ")), disc_data)
    
    # Binary models
    binary_m1 <- run_regression(paste("has_any_urm ~ treatment +", paste(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     collapse = " + ")), disc_data)
    binary_m2 <- run_regression(paste("has_any_urm ~ treatment +", paste(c(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     extended_controls), collapse = " + ")), disc_data)
    
    # Create table for this discipline - URM
    create_stargazer_table(
      list(pct_m1, pct_m2, count_m1, count_m2, binary_m1, binary_m2),
      c("\\\\% URM", "\\\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
      paste(disc_name, ": Effect on URM Speaker Representation"),
      paste0("tab:discipline_", tolower(gsub(" ", "_", disc_name)), "_urm"),
      demographic_group = "URM"
    )
    
    # Store results
    discipline_results[[disc_name]] <- list(
      pct_m1 = pct_m1, pct_m2 = pct_m2,
      count_m1 = count_m1, count_m2 = count_m2,
      binary_m1 = binary_m1, binary_m2 = binary_m2
    )
    
    # Add to models list for significant results extraction
    all_models_list <- append(all_models_list, list(
      list(model = pct_m1, analysis = disc_name, outcome = "% URM", model_type = "Simple"),
      list(model = pct_m2, analysis = disc_name, outcome = "% URM", model_type = "Extended"),
      list(model = count_m1, analysis = disc_name, outcome = "Count URM", model_type = "Simple"),
      list(model = count_m2, analysis = disc_name, outcome = "Count URM", model_type = "Extended"),
      list(model = binary_m1, analysis = disc_name, outcome = "Any URM", model_type = "Simple"),
      list(model = binary_m2, analysis = disc_name, outcome = "Any URM", model_type = "Extended")
    ))
    
    # Black Analysis for this discipline
    pct_black_m1 <- run_regression(paste("pct_black ~ treatment +", paste(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  collapse = " + ")), disc_data)
    pct_black_m2 <- run_regression(paste("pct_black ~ treatment +", paste(c(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  extended_controls), collapse = " + ")), disc_data)
    
    count_black_m1 <- run_regression(paste("num_black ~ treatment +", paste(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    collapse = " + ")), disc_data)
    count_black_m2 <- run_regression(paste("num_black ~ treatment +", paste(c(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    extended_controls), collapse = " + ")), disc_data)
    
    binary_black_m1 <- run_regression(paste("has_any_black ~ treatment +", paste(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     collapse = " + ")), disc_data)
    binary_black_m2 <- run_regression(paste("has_any_black ~ treatment +", paste(c(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     extended_controls), collapse = " + ")), disc_data)
    
    # Create table for Black speakers
    create_stargazer_table(
      list(pct_black_m1, pct_black_m2, count_black_m1, count_black_m2, binary_black_m1, binary_black_m2),
      c("\\\\% Black", "\\\\% Black", "Count Black", "Count Black", "Any Black", "Any Black"),
      paste(disc_name, ": Effect on Black Speaker Representation"),
      paste0("tab:discipline_", tolower(gsub(" ", "_", disc_name)), "_black"),
      demographic_group = "Black"
    )
    
    # Add Black models to models list
    all_models_list <- append(all_models_list, list(
      list(model = pct_black_m1, analysis = disc_name, outcome = "% Black", model_type = "Simple"),
      list(model = pct_black_m2, analysis = disc_name, outcome = "% Black", model_type = "Extended"),
      list(model = count_black_m1, analysis = disc_name, outcome = "Count Black", model_type = "Simple"),
      list(model = count_black_m2, analysis = disc_name, outcome = "Count Black", model_type = "Extended"),
      list(model = binary_black_m1, analysis = disc_name, outcome = "Any Black", model_type = "Simple"),
      list(model = binary_black_m2, analysis = disc_name, outcome = "Any Black", model_type = "Extended")
    ))
    
    # Hispanic Analysis for this discipline
    pct_hispanic_m1 <- run_regression(paste("pct_hispanic ~ treatment +", paste(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  collapse = " + ")), disc_data)
    pct_hispanic_m2 <- run_regression(paste("pct_hispanic ~ treatment +", paste(c(setdiff(base_controls, 
                                  c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                  extended_controls), collapse = " + ")), disc_data)
    
    count_hispanic_m1 <- run_regression(paste("num_hispanic ~ treatment +", paste(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    collapse = " + ")), disc_data)
    count_hispanic_m2 <- run_regression(paste("num_hispanic ~ treatment +", paste(c(setdiff(base_controls, 
                                    c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                    extended_controls), collapse = " + ")), disc_data)
    
    binary_hispanic_m1 <- run_regression(paste("has_any_hispanic ~ treatment +", paste(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     collapse = " + ")), disc_data)
    binary_hispanic_m2 <- run_regression(paste("has_any_hispanic ~ treatment +", paste(c(setdiff(base_controls, 
                                     c("disc_mathematics", "disc_physics", "disc_computer_science", "disc_mechanical_engineering")), 
                                     extended_controls), collapse = " + ")), disc_data)
    
    # Create table for Hispanic speakers
    create_stargazer_table(
      list(pct_hispanic_m1, pct_hispanic_m2, count_hispanic_m1, count_hispanic_m2, binary_hispanic_m1, binary_hispanic_m2),
      c("\\\\% Hispanic", "\\\\% Hispanic", "Count Hispanic", "Count Hispanic", "Any Hispanic", "Any Hispanic"),
      paste(disc_name, ": Effect on Hispanic Speaker Representation"),
      paste0("tab:discipline_", tolower(gsub(" ", "_", disc_name)), "_hispanic"),
      demographic_group = "Hispanic"
    )
    
    # Add Hispanic models to models list
    all_models_list <- append(all_models_list, list(
      list(model = pct_hispanic_m1, analysis = disc_name, outcome = "% Hispanic", model_type = "Simple"),
      list(model = pct_hispanic_m2, analysis = disc_name, outcome = "% Hispanic", model_type = "Extended"),
      list(model = count_hispanic_m1, analysis = disc_name, outcome = "Count Hispanic", model_type = "Simple"),
      list(model = count_hispanic_m2, analysis = disc_name, outcome = "Count Hispanic", model_type = "Extended"),
      list(model = binary_hispanic_m1, analysis = disc_name, outcome = "Any Hispanic", model_type = "Simple"),
      list(model = binary_hispanic_m2, analysis = disc_name, outcome = "Any Hispanic", model_type = "Extended")
    ))
  } else {
    cat("Insufficient observations for regression analysis in", disc_name, "\n\n")
  }
}
```

## Testing for Significant Moderation Across Disciplines

```{r discipline-moderation-test}
# Test whether treatment effects vary significantly across disciplines
# This F-test examines the joint significance of treatment × discipline interactions

# Run full model with treatment × discipline interactions
# Using the same controls as in the main analysis but with interaction terms
# Note: We exclude discipline dummies from base_controls to avoid redundancy
base_controls_no_disc <- setdiff(base_controls, c("disc_mathematics", "disc_physics", 
                                                   "disc_computer_science", "disc_mechanical_engineering"))

full_model_black <- lm(paste("has_any_black ~ treatment * (disc_mathematics + disc_physics + 
                             disc_computer_science + disc_mechanical_engineering) +", 
                             paste(c(base_controls_no_disc, extended_controls), collapse = " + ")), 
                       data = data)

# Run restricted model without interactions (but keeping main effects)
restricted_model_black <- lm(paste("has_any_black ~ treatment + disc_mathematics + disc_physics + 
                                   disc_computer_science + disc_mechanical_engineering +",
                                   paste(c(base_controls_no_disc, extended_controls), collapse = " + ")), 
                            data = data)

# F-test for joint significance of interactions
f_test_black <- anova(restricted_model_black, full_model_black)

cat("\\textbf{F-test for Treatment × Discipline Interactions (Black Speakers):}\n")
cat("F-statistic:", round(f_test_black$F[2], 3), "\n")
cat("p-value:", round(f_test_black$`Pr(>F)`[2], 4), "\n")
cat("Degrees of freedom:", f_test_black$Df[2], "\n\n")

# Interpretation
if (f_test_black$`Pr(>F)`[2] < 0.05) {
  cat("The treatment effect on Black speaker representation varies significantly across disciplines (p < 0.05).\n")
  cat("This indicates that the diversity intervention has heterogeneous effects depending on the academic field.\n")
} else {
  cat("We cannot reject the null hypothesis that treatment effects are equal across disciplines.\n")
  cat("The variation in treatment effects across fields may be due to random chance.\n")
}

# Also test for URM speakers
full_model_urm <- lm(paste("pct_urm ~ treatment * (disc_mathematics + disc_physics + 
                           disc_computer_science + disc_mechanical_engineering) +", 
                           paste(c(base_controls_no_disc, extended_controls), collapse = " + ")), 
                     data = data)

restricted_model_urm <- lm(paste("pct_urm ~ treatment + disc_mathematics + disc_physics + 
                                 disc_computer_science + disc_mechanical_engineering +",
                                 paste(c(base_controls_no_disc, extended_controls), collapse = " + ")), 
                          data = data)

f_test_urm <- anova(restricted_model_urm, full_model_urm)

cat("\n\\textbf{F-test for Treatment × Discipline Interactions (URM Speakers):}\n")
cat("F-statistic:", round(f_test_urm$F[2], 3), "\n")
cat("p-value:", round(f_test_urm$`Pr(>F)`[2], 4), "\n")
cat("Degrees of freedom:", f_test_urm$Df[2], "\n\n")

# Test for percentage of Black speakers
full_model_pct_black <- lm(paste("pct_black ~ treatment * (disc_mathematics + disc_physics + 
                                 disc_computer_science + disc_mechanical_engineering) +", 
                                 paste(c(base_controls_no_disc, extended_controls), collapse = " + ")), 
                          data = data)

restricted_model_pct_black <- lm(paste("pct_black ~ treatment + disc_mathematics + disc_physics + 
                                       disc_computer_science + disc_mechanical_engineering +",
                                       paste(c(base_controls_no_disc, extended_controls), collapse = " + ")), 
                                data = data)

f_test_pct_black <- anova(restricted_model_pct_black, full_model_pct_black)

cat("\\textbf{F-test for Treatment × Discipline Interactions (% Black Speakers):}\n")
cat("F-statistic:", round(f_test_pct_black$F[2], 3), "\n")
cat("p-value:", round(f_test_pct_black$`Pr(>F)`[2], 4), "\n")
cat("Degrees of freedom:", f_test_pct_black$Df[2], "\n\n")

# Test for total number of Black speakers
full_model_num_black <- lm(paste("num_black ~ treatment * (disc_mathematics + disc_physics + 
                                 disc_computer_science + disc_mechanical_engineering) +", 
                                 paste(c(base_controls_no_disc, extended_controls), collapse = " + ")), 
                          data = data)

restricted_model_num_black <- lm(paste("num_black ~ treatment + disc_mathematics + disc_physics + 
                                       disc_computer_science + disc_mechanical_engineering +",
                                       paste(c(base_controls_no_disc, extended_controls), collapse = " + ")), 
                                data = data)

f_test_num_black <- anova(restricted_model_num_black, full_model_num_black)

cat("\\textbf{F-test for Treatment × Discipline Interactions (Total Black Speakers):}\n")
cat("F-statistic:", round(f_test_num_black$F[2], 3), "\n")
cat("p-value:", round(f_test_num_black$`Pr(>F)`[2], 4), "\n")
cat("Degrees of freedom:", f_test_num_black$Df[2], "\n\n")

# Store the interaction effects for reporting
interaction_effects_black <- summary(full_model_black)$coefficients[
  grep("treatment:disc", rownames(summary(full_model_black)$coefficients)), ]

cat("\\textbf{Individual Interaction Effects (Black Speakers):}\n")
print(round(interaction_effects_black, 4))
```

\newpage

# Semester-Specific Analysis

## Fall Semester

```{r fall-semester}
# Fall semester analysis
data_fall <- data %>% filter(has_fall_speakers == 1)

pct_fall_urm_m1 <- run_regression(paste("fall_pct_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
count_fall_urm_m1 <- run_regression(paste("fall_num_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
binary_fall_urm_m1 <- run_regression(paste("fall_has_any_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)


pct_fall_urm_m2 <- run_regression(paste("fall_pct_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
count_fall_urm_m2 <- run_regression(paste("fall_num_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
binary_fall_urm_m2 <- run_regression(paste("fall_has_any_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_fall_urm_m1, analysis = "Fall Semester", outcome = "% URM", model_type = "Simple"),
  list(model = pct_fall_urm_m2, analysis = "Fall Semester", outcome = "% URM", model_type = "Extended"),
  list(model = count_fall_urm_m1, analysis = "Fall Semester", outcome = "Count URM", model_type = "Simple"),
  list(model = count_fall_urm_m2, analysis = "Fall Semester", outcome = "Count URM", model_type = "Extended"),
  list(model = binary_fall_urm_m1, analysis = "Fall Semester", outcome = "Any URM", model_type = "Simple"),
  list(model = binary_fall_urm_m2, analysis = "Fall Semester", outcome = "Any URM", model_type = "Extended")
))

create_stargazer_table(
  list(pct_fall_urm_m1, pct_fall_urm_m2, count_fall_urm_m1, count_fall_urm_m2, binary_fall_urm_m1, binary_fall_urm_m2),
  c("\\\\% URM", "\\\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Fall: Effect on URM Speakers",
  "tab:fall_urm",
  demographic_group = "URM"
)

# Black Analysis
pct_fall_black_m1 <- run_regression(paste("fall_pct_black ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
count_fall_black_m1 <- run_regression(paste("fall_num_black ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
binary_fall_black_m1 <- run_regression(paste("fall_has_any_black ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)

pct_fall_black_m2 <- run_regression(paste("fall_pct_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
count_fall_black_m2 <- run_regression(paste("fall_num_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
binary_fall_black_m2 <- run_regression(paste("fall_has_any_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_fall_black_m1, analysis = "Fall Semester", outcome = "% Black", model_type = "Simple"),
  list(model = pct_fall_black_m2, analysis = "Fall Semester", outcome = "% Black", model_type = "Extended"),
  list(model = count_fall_black_m1, analysis = "Fall Semester", outcome = "Count Black", model_type = "Simple"),
  list(model = count_fall_black_m2, analysis = "Fall Semester", outcome = "Count Black", model_type = "Extended"),
  list(model = binary_fall_black_m1, analysis = "Fall Semester", outcome = "Any Black", model_type = "Simple"),
  list(model = binary_fall_black_m2, analysis = "Fall Semester", outcome = "Any Black", model_type = "Extended")
))

create_stargazer_table(
  list(pct_fall_black_m1, pct_fall_black_m2, count_fall_black_m1, count_fall_black_m2, binary_fall_black_m1, binary_fall_black_m2),
  c("\\\\% Black", "\\\\% Black", "Count Black", "Count Black", "Any Black", "Any Black"),
  "Fall: Effect on Black Speakers",
  "tab:fall_black",
  demographic_group = "Black"
)

# Hispanic Analysis
pct_fall_hispanic_m1 <- run_regression(paste("fall_pct_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
count_fall_hispanic_m1 <- run_regression(paste("fall_num_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)
binary_fall_hispanic_m1 <- run_regression(paste("fall_has_any_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_fall)

pct_fall_hispanic_m2 <- run_regression(paste("fall_pct_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
count_fall_hispanic_m2 <- run_regression(paste("fall_num_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)
binary_fall_hispanic_m2 <- run_regression(paste("fall_has_any_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_fall)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_fall_hispanic_m1, analysis = "Fall Semester", outcome = "% Hispanic", model_type = "Simple"),
  list(model = pct_fall_hispanic_m2, analysis = "Fall Semester", outcome = "% Hispanic", model_type = "Extended"),
  list(model = count_fall_hispanic_m1, analysis = "Fall Semester", outcome = "Count Hispanic", model_type = "Simple"),
  list(model = count_fall_hispanic_m2, analysis = "Fall Semester", outcome = "Count Hispanic", model_type = "Extended"),
  list(model = binary_fall_hispanic_m1, analysis = "Fall Semester", outcome = "Any Hispanic", model_type = "Simple"),
  list(model = binary_fall_hispanic_m2, analysis = "Fall Semester", outcome = "Any Hispanic", model_type = "Extended")
))

create_stargazer_table(
  list(pct_fall_hispanic_m1, pct_fall_hispanic_m2, count_fall_hispanic_m1, count_fall_hispanic_m2, binary_fall_hispanic_m1, binary_fall_hispanic_m2),
  c("\\\\% Hispanic", "\\\\% Hispanic", "Count Hispanic", "Count Hispanic", "Any Hispanic", "Any Hispanic"),
  "Fall: Effect on Hispanic Speakers",
  "tab:fall_hispanic",
  demographic_group = "Hispanic"
)
```

## Spring Semester

```{r spring-semester}
# Spring semester analysis
data_spring <- data %>% filter(has_spring_speakers == 1)

pct_spring_urm_m1 <- run_regression(paste("spring_pct_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
count_spring_urm_m1 <- run_regression(paste("spring_num_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
binary_spring_urm_m1 <- run_regression(paste("spring_has_any_urm ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)

pct_spring_urm_m2 <- run_regression(paste("spring_pct_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
count_spring_urm_m2 <- run_regression(paste("spring_num_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
binary_spring_urm_m2 <- run_regression(paste("spring_has_any_urm ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_spring_urm_m1, analysis = "Spring Semester", outcome = "% URM", model_type = "Simple"),
  list(model = pct_spring_urm_m2, analysis = "Spring Semester", outcome = "% URM", model_type = "Extended"),
  list(model = count_spring_urm_m1, analysis = "Spring Semester", outcome = "Count URM", model_type = "Simple"),
  list(model = count_spring_urm_m2, analysis = "Spring Semester", outcome = "Count URM", model_type = "Extended"),
  list(model = binary_spring_urm_m1, analysis = "Spring Semester", outcome = "Any URM", model_type = "Simple"),
  list(model = binary_spring_urm_m2, analysis = "Spring Semester", outcome = "Any URM", model_type = "Extended")
))

create_stargazer_table(
  list(pct_spring_urm_m1, pct_spring_urm_m2, count_spring_urm_m1, count_spring_urm_m2, binary_spring_urm_m1, binary_spring_urm_m2),
  c("\\\\% URM", "\\\\% URM", "Count URM", "Count URM", "Any URM", "Any URM"),
  "Spring: Effect on URM Speakers",
  "tab:spring_urm",
  demographic_group = "URM"
)

# Black Analysis
pct_spring_black_m1 <- run_regression(paste("spring_pct_black ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
count_spring_black_m1 <- run_regression(paste("spring_num_black ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
binary_spring_black_m1 <- run_regression(paste("spring_has_any_black ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)

pct_spring_black_m2 <- run_regression(paste("spring_pct_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
count_spring_black_m2 <- run_regression(paste("spring_num_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
binary_spring_black_m2 <- run_regression(paste("spring_has_any_black ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_spring_black_m1, analysis = "Spring Semester", outcome = "% Black", model_type = "Simple"),
  list(model = pct_spring_black_m2, analysis = "Spring Semester", outcome = "% Black", model_type = "Extended"),
  list(model = count_spring_black_m1, analysis = "Spring Semester", outcome = "Count Black", model_type = "Simple"),
  list(model = count_spring_black_m2, analysis = "Spring Semester", outcome = "Count Black", model_type = "Extended"),
  list(model = binary_spring_black_m1, analysis = "Spring Semester", outcome = "Any Black", model_type = "Simple"),
  list(model = binary_spring_black_m2, analysis = "Spring Semester", outcome = "Any Black", model_type = "Extended")
))

create_stargazer_table(
  list(pct_spring_black_m1, pct_spring_black_m2, count_spring_black_m1, count_spring_black_m2, binary_spring_black_m1, binary_spring_black_m2),
  c("\\\\% Black", "\\\\% Black", "Count Black", "Count Black", "Any Black", "Any Black"),
  "Spring: Effect on Black Speakers",
  "tab:spring_black",
  demographic_group = "Black"
)

# Hispanic Analysis
pct_spring_hispanic_m1 <- run_regression(paste("spring_pct_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
count_spring_hispanic_m1 <- run_regression(paste("spring_num_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)
binary_spring_hispanic_m1 <- run_regression(paste("spring_has_any_hispanic ~ treatment +", paste(base_controls, collapse = " + ")), data_spring)

pct_spring_hispanic_m2 <- run_regression(paste("spring_pct_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
count_spring_hispanic_m2 <- run_regression(paste("spring_num_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)
binary_spring_hispanic_m2 <- run_regression(paste("spring_has_any_hispanic ~ treatment +", paste(c(base_controls, extended_controls), collapse = " + ")), data_spring)

# Add to models list
all_models_list <- append(all_models_list, list(
  list(model = pct_spring_hispanic_m1, analysis = "Spring Semester", outcome = "% Hispanic", model_type = "Simple"),
  list(model = pct_spring_hispanic_m2, analysis = "Spring Semester", outcome = "% Hispanic", model_type = "Extended"),
  list(model = count_spring_hispanic_m1, analysis = "Spring Semester", outcome = "Count Hispanic", model_type = "Simple"),
  list(model = count_spring_hispanic_m2, analysis = "Spring Semester", outcome = "Count Hispanic", model_type = "Extended"),
  list(model = binary_spring_hispanic_m1, analysis = "Spring Semester", outcome = "Any Hispanic", model_type = "Simple"),
  list(model = binary_spring_hispanic_m2, analysis = "Spring Semester", outcome = "Any Hispanic", model_type = "Extended")
))

create_stargazer_table(
  list(pct_spring_hispanic_m1, pct_spring_hispanic_m2, count_spring_hispanic_m1, count_spring_hispanic_m2, binary_spring_hispanic_m1, binary_spring_hispanic_m2),
  c("\\\\% Hispanic", "\\\\% Hispanic", "Count Hispanic", "Count Hispanic", "Any Hispanic", "Any Hispanic"),
  "Spring: Effect on Hispanic Speakers",
  "tab:spring_hispanic",
  demographic_group = "Hispanic"
)
```

\newpage

# Heterogeneity Analysis

## Moderation by Department Ranking

```{r mod-ranking, results='asis'}
mod_results <- run_comprehensive_moderation_fixed("dept_ranking", "Department Ranking", 
                                                exclude_controls = c("dept_ranking", "missing_dept_rank"))
all_models_list <- append(all_models_list, mod_results)
```

\newpage

## Moderation by Total Faculty Size

```{r mod-faculty-size, results='asis'}
mod_results <- run_comprehensive_moderation_fixed("total_faculty", "Total Faculty", 
                                                exclude_controls = c("total_faculty"))
all_models_list <- append(all_models_list, mod_results)
```

\newpage

## Moderation by URM Faculty in Peer Departments

```{r mod-peer-urm, results='asis'}
mod_results <- run_comprehensive_moderation_fixed("total_urm_peer_faculty", "Peer URM Faculty", 
                                                exclude_controls = c("total_urm_peer_faculty", "total_peer_departments"))
all_models_list <- append(all_models_list, mod_results)
```

\newpage

## Moderation by % Female Email Recipients

```{r mod-female-recipients, results='asis'}
mod_results <- run_comprehensive_moderation_fixed("pct_female_recipients", "\\% Female Recipients", 
                                                exclude_controls = NULL, center = FALSE)
all_models_list <- append(all_models_list, mod_results)
```

\newpage

## Moderation by % URM Email Recipients

```{r mod-urm-recipients, results='asis'}
mod_results <- run_comprehensive_moderation_fixed("pct_urm_recipients", "\\% URM Recipients", 
                                                exclude_controls = NULL, center = FALSE)
all_models_list <- append(all_models_list, mod_results)
```

\newpage

## Moderation by % URM Faculty in Department

```{r mod-urm-faculty, results='asis'}
mod_results <- run_comprehensive_moderation_fixed("frac_urm_faculty", "\\% URM Faculty", 
                                                exclude_controls = c("frac_urm_faculty"), center = FALSE)
all_models_list <- append(all_models_list, mod_results)
```

\newpage

## Moderation by % Women Faculty in Department

```{r mod-women-faculty, results='asis'}
mod_results <- run_comprehensive_moderation_fixed("frac_women_faculty", "\\% Women Faculty", 
                                                exclude_controls = c("frac_women_faculty"), center = FALSE)
all_models_list <- append(all_models_list, mod_results)
```

\newpage

## Moderation by Number of Distinct Seminars

```{r mod-num-seminars, results='asis'}
mod_results <- run_comprehensive_moderation_fixed("num_distinct_seminars", "Number of Seminars", 
                                                exclude_controls = NULL)
all_models_list <- append(all_models_list, mod_results)
```

\newpage

## Junior vs Senior Speaker Analysis

### Analysis: Treatment effects on representation by speaker career stage

This analysis examines whether the treatment differentially affects the representation of junior versus senior speakers.
We define:
- **Junior speakers**: Those below the median years since PhD completion
- **Senior speakers**: Those above the median years since PhD completion

We analyze treatment effects on three types of outcomes for each demographic group (URM, Black, Hispanic):
1. **Percentage**: What percentage of speakers from a demographic group are junior (or senior)?
2. **Count**: How many speakers from a demographic group are junior (or senior)?
3. **Binary**: Does the seminar have any junior (or senior) speakers from this demographic group?

```{r seniority-analysis, warning=FALSE, message=FALSE, results='asis'}
# Create comprehensive seniority analysis table
create_seniority_table <- function(demographic_label, demographic_var) {
  cat("\n\n")
  cat("\\begin{table}[H]\n")
  cat(sprintf("\\caption{Treatment Effects on Junior and Senior %s Speakers}\n", demographic_label))
  cat("\\centering\n")
  cat("\\footnotesize\n")
  cat("\\begin{tabular}{lccccccc}\n")
  cat("\\toprule\n")
  cat(" & \\multicolumn{3}{c}{Junior Speakers} & \\multicolumn{3}{c}{Senior Speakers} \\\\\n")
  cat("Outcome & Model 1 & Model 2 & & Model 1 & Model 2 \\\\\n")
  cat("\\midrule\n")
  
  # Junior speaker outcomes
  junior_outcomes <- list(
    list(dv = paste0("pct_", demographic_var, "_junior"), label = "\\% of speakers"),
    list(dv = paste0("num_", demographic_var, "_junior"), label = "Count"),
    list(dv = paste0("has_any_", demographic_var, "_junior"), label = "Any (0/1)")
  )
  
  # Senior speaker outcomes
  senior_outcomes <- list(
    list(dv = paste0("pct_", demographic_var, "_senior"), label = "\\% of speakers"),
    list(dv = paste0("num_", demographic_var, "_senior"), label = "Count"),
    list(dv = paste0("has_any_", demographic_var, "_senior"), label = "Any (0/1)")
  )
  
  # Store models for all_models_list
  seniority_models <- list()
  
  # Run models for each outcome
  for (i in 1:3) {
    cat(sprintf("%s & ", junior_outcomes[[i]]$label))
    
    # Junior Model 1
    formula_j1 <- as.formula(paste0(junior_outcomes[[i]]$dv, " ~ treatment + ", 
                                   paste(base_controls, collapse = " + ")))
    model_j1 <- run_regression(formula_j1, data)
    
    if (!is.null(model_j1)) {
      coef_j1 <- coef(model_j1)["treatment"]
      se_j1 <- model_j1$cluster_se["treatment"]
      t_j1 <- coef_j1 / se_j1
      p_j1 <- 2 * pt(-abs(t_j1), df = df.residual(model_j1))
      sig_j1 <- ifelse(p_j1 < 0.001, "***", ifelse(p_j1 < 0.01, "**", 
                      ifelse(p_j1 < 0.05, "*", ifelse(p_j1 < 0.1, "+", ""))))
      cat(sprintf("%.4f%s", coef_j1, sig_j1))
      
      seniority_models <- append(seniority_models, list(
        list(model = model_j1, 
             analysis = paste("Junior/Senior", demographic_label, "Speakers"),
             outcome = paste("Junior", junior_outcomes[[i]]$label), 
             model_type = "Simple")
      ))
    } else {
      cat("--")
    }
    
    cat(" & ")
    
    # Junior Model 2
    formula_j2 <- as.formula(paste0(junior_outcomes[[i]]$dv, " ~ treatment + ", 
                                   paste(c(base_controls, extended_controls), collapse = " + ")))
    model_j2 <- run_regression(formula_j2, data)
    
    if (!is.null(model_j2)) {
      coef_j2 <- coef(model_j2)["treatment"]
      se_j2 <- model_j2$cluster_se["treatment"]
      t_j2 <- coef_j2 / se_j2
      p_j2 <- 2 * pt(-abs(t_j2), df = df.residual(model_j2))
      sig_j2 <- ifelse(p_j2 < 0.001, "***", ifelse(p_j2 < 0.01, "**", 
                      ifelse(p_j2 < 0.05, "*", ifelse(p_j2 < 0.1, "+", ""))))
      cat(sprintf("%.4f%s", coef_j2, sig_j2))
      
      seniority_models <- append(seniority_models, list(
        list(model = model_j2, 
             analysis = paste("Junior/Senior", demographic_label, "Speakers"),
             outcome = paste("Junior", junior_outcomes[[i]]$label), 
             model_type = "Extended")
      ))
    } else {
      cat("--")
    }
    
    cat(" & & ")
    
    # Senior Model 1
    formula_s1 <- as.formula(paste0(senior_outcomes[[i]]$dv, " ~ treatment + ", 
                                   paste(base_controls, collapse = " + ")))
    model_s1 <- run_regression(formula_s1, data)
    
    if (!is.null(model_s1)) {
      coef_s1 <- coef(model_s1)["treatment"]
      se_s1 <- model_s1$cluster_se["treatment"]
      t_s1 <- coef_s1 / se_s1
      p_s1 <- 2 * pt(-abs(t_s1), df = df.residual(model_s1))
      sig_s1 <- ifelse(p_s1 < 0.001, "***", ifelse(p_s1 < 0.01, "**", 
                      ifelse(p_s1 < 0.05, "*", ifelse(p_s1 < 0.1, "+", ""))))
      cat(sprintf("%.4f%s", coef_s1, sig_s1))
      
      seniority_models <- append(seniority_models, list(
        list(model = model_s1, 
             analysis = paste("Junior/Senior", demographic_label, "Speakers"),
             outcome = paste("Senior", senior_outcomes[[i]]$label), 
             model_type = "Simple")
      ))
    } else {
      cat("--")
    }
    
    cat(" & ")
    
    # Senior Model 2
    formula_s2 <- as.formula(paste0(senior_outcomes[[i]]$dv, " ~ treatment + ", 
                                   paste(c(base_controls, extended_controls), collapse = " + ")))
    model_s2 <- run_regression(formula_s2, data)
    
    if (!is.null(model_s2)) {
      coef_s2 <- coef(model_s2)["treatment"]
      se_s2 <- model_s2$cluster_se["treatment"]
      t_s2 <- coef_s2 / se_s2
      p_s2 <- 2 * pt(-abs(t_s2), df = df.residual(model_s2))
      sig_s2 <- ifelse(p_s2 < 0.001, "***", ifelse(p_s2 < 0.01, "**", 
                      ifelse(p_s2 < 0.05, "*", ifelse(p_s2 < 0.1, "+", ""))))
      cat(sprintf("%.4f%s", coef_s2, sig_s2))
      
      seniority_models <- append(seniority_models, list(
        list(model = model_s2, 
             analysis = paste("Junior/Senior", demographic_label, "Speakers"),
             outcome = paste("Senior", senior_outcomes[[i]]$label), 
             model_type = "Extended")
      ))
    } else {
      cat("--")
    }
    
    cat(" \\\\\n")
  }
  
  cat("\\midrule\n")
  
  # Add sample statistics
  cat("\\textit{Mean (Control)} & & & & & \\\\\n")
  
  for (i in 1:3) {
    control_data <- data[data$treatment == 0, ]
    
    # Junior control mean
    junior_mean <- mean(control_data[[junior_outcomes[[i]]$dv]], na.rm = TRUE)
    # Senior control mean  
    senior_mean <- mean(control_data[[senior_outcomes[[i]]$dv]], na.rm = TRUE)
    
    cat(sprintf("%s & %.3f & & & %.3f & \\\\\n", 
                junior_outcomes[[i]]$label, junior_mean, senior_mean))
  }
  
  cat("\\bottomrule\n")
  cat("\\end{tabular}\n")
  cat("\\parbox{\\linewidth}{\\footnotesize Note: + p$<$0.1; * p$<$0.05; ** p$<$0.01; *** p$<$0.001. ")
  cat("Standard errors clustered at the department level. ")
  cat("Junior speakers are defined as those below the median years since PhD; senior speakers are above the median. ")
  cat("Model 1 includes baseline controls; Model 2 adds extended controls.}\n")
  cat("\\end{table}\n\n")
  
  # Add to global all_models_list
  all_models_list <<- append(all_models_list, seniority_models)
  
  return(invisible(seniority_models))
}

# Summary statistics
cat("\\subsection{Seniority Data Coverage}\n\n")

seniority_summary <- data %>%
  summarise(
    n_seminars = n(),
    n_with_junior = sum(num_junior_speakers > 0, na.rm = TRUE),
    n_with_senior = sum(num_senior_speakers > 0, na.rm = TRUE),
    mean_junior = mean(num_junior_speakers, na.rm = TRUE),
    mean_senior = mean(num_senior_speakers, na.rm = TRUE),
    median_phd_years = median(median_years_from_phd, na.rm = TRUE)
  )

cat(sprintf("Total seminars analyzed: %d\\\\[0.3em]\n", seniority_summary$n_seminars))
cat(sprintf("Seminars with junior speakers: %d (%.1f\\%%)\\\\[0.3em]\n", 
            seniority_summary$n_with_junior,
            100 * seniority_summary$n_with_junior / seniority_summary$n_seminars))
cat(sprintf("Seminars with senior speakers: %d (%.1f\\%%)\\\\[0.3em]\n",
            seniority_summary$n_with_senior,
            100 * seniority_summary$n_with_senior / seniority_summary$n_seminars))
cat(sprintf("Mean junior speakers per seminar: %.2f\\\\[0.3em]\n", seniority_summary$mean_junior))
cat(sprintf("Mean senior speakers per seminar: %.2f\\\\[0.3em]\n", seniority_summary$mean_senior))
cat(sprintf("Median years since PhD (cutoff): %.1f\\\\[0.5em]\n\n", seniority_summary$median_phd_years))
# Run analyses for each demographic group
cat("\\subsection{URM Speakers by Career Stage}\n\n")
create_seniority_table("URM", "urm")

cat("\\subsection{Black Speakers by Career Stage}\n\n")
create_seniority_table("Black", "black")

cat("\\subsection{Hispanic Speakers by Career Stage}\n\n")
create_seniority_table("Hispanic", "hispanic")
```

```{r final-significant-results, results='asis'}
# Function to extract significant results, focusing on interactions for moderation analyses
extract_all_significant_results <- function() {
  results <- data.frame(
    Analysis = character(),
    Outcome = character(),
    Variable = character(),
    Model = character(),
    Coefficient = numeric(),
    SE = numeric(),
    t_stat = numeric(),
    p_value = numeric(),
    Significance = character(),
    Category = character(),
    stringsAsFactors = FALSE
  )
  
  add_if_significant_any <- function(model, analysis, outcome, model_type, 
                                    var_names = c("treatment"), 
                                    var_labels = c("Treatment")) {
    if (!is.null(model)) {
      model_coefs <- coef(model)
      model_ses <- model$cluster_se 
      
      for (i in seq_along(var_names)) {
        var_name_in_formula <- var_names[i] 
        var_label_for_table <- var_labels[i] 
        
        # Skip non-interaction terms in moderation analyses
        if (grepl("Moderation", analysis) && !grepl("×|:", var_label_for_table)) {
          next
        }
        
        actual_coef_name <- var_name_in_formula
        if (var_name_in_formula == "Constant" && "(Intercept)" %in% names(model_coefs)) {
            actual_coef_name <- "(Intercept)"
        } 

        if (actual_coef_name %in% names(model_coefs)) {
          coef_val <- model_coefs[actual_coef_name]
          
          if (actual_coef_name %in% names(model_ses)) {
            se_val <- model_ses[actual_coef_name]
            t_val <- coef_val / se_val
            p_val <- 2 * pt(-abs(t_val), df = length(model$residuals) - length(model_coefs))
            
            if (p_val < 0.1) {
              # Only include treatment effects or treatment interactions
              if (var_label_for_table != "Constant" && 
                  (var_label_for_table == "Treatment" || 
                   grepl("Treatment|×", var_label_for_table))) {
                sig <- ifelse(p_val < 0.001, "***", 
                             ifelse(p_val < 0.01, "**",
                                   ifelse(p_val < 0.05, "*", "+")))
                
                category <- case_when(
                  grepl("Main Effect|Main Question", analysis) ~ "Main Effects",
                  grepl("Demographic|Black|Hispanic|Female", analysis) && !grepl("Junior/Senior", analysis) ~ "Demographic Subgroups",
                  grepl("Junior/Senior", analysis) ~ "Career Stage Analysis",
                  grepl("Semester", analysis) ~ "Semester Analysis",
                  grepl("Chemistry|Mathematics|Physics|Computer Science|Mechanical Engineering", analysis) ~ "Discipline Analysis",
                  grepl("Moderation", analysis) ~ "Heterogeneity Analysis",
                  TRUE ~ "Other"
                )
                
                results <<- rbind(results, data.frame(
                  Analysis = analysis,
                  Outcome = outcome,
                  Variable = var_label_for_table, 
                  Model = model_type,
                  Coefficient = coef_val,
                  SE = se_val,
                  t_stat = t_val,
                  p_value = p_val,
                  Significance = sig,
                  Category = category,
                  stringsAsFactors = FALSE
                ))
              }
            }
          }
        }
      }
    }
  }
  
  for (model_info in all_models_list) {
    model <- model_info$model
    analysis <- model_info$analysis
    outcome <- model_info$outcome
    model_type <- model_info$model_type
    var_names <- model_info$var_names   
    var_labels <- model_info$var_labels 
    
    if (is.null(var_names)) { 
      var_names <- c("treatment", "Constant") 
      var_labels <- c("Treatment", "Constant")
    }
    
    add_if_significant_any(model, analysis, outcome, model_type, var_names, var_labels)
  }
  
  return(results)
}

all_significant_results <- extract_all_significant_results()

if (nrow(all_significant_results) > 0) {
  all_significant_results <- all_significant_results %>%
    group_by(Analysis, Outcome, Variable) %>%
    arrange(p_value) %>%
    slice(1) %>%
    ungroup()
  
  # Re-create Category column if it doesn't exist
  if (!"Category" %in% names(all_significant_results)) {
    all_significant_results$Category <- NA_character_
    for (i in 1:nrow(all_significant_results)) {
      if (grepl("Main Effect|Main Question", all_significant_results$Analysis[i])) {
        all_significant_results$Category[i] <- "Main Effects"
      } else if (grepl("Demographic|Black|Hispanic|Female|Intersectional", all_significant_results$Analysis[i])) {
        all_significant_results$Category[i] <- "Identity Analysis"
      } else if (grepl("Semester", all_significant_results$Analysis[i])) {
        all_significant_results$Category[i] <- "Semester Analysis"
      } else if (grepl("Chemistry|Mathematics|Physics|Computer Science|Mechanical Engineering", all_significant_results$Analysis[i])) {
        all_significant_results$Category[i] <- "Discipline Analysis"
      } else if (grepl("Moderation|Department Rank|Faculty Size|Peer URM", all_significant_results$Analysis[i])) {
        all_significant_results$Category[i] <- "Moderation Analysis"
      } else {
        all_significant_results$Category[i] <- "Other"
      }
    }
  }
  
  all_significant_results <- all_significant_results %>%
    arrange(Category, Analysis, Outcome, Variable) %>%
    mutate(
      Coefficient = sprintf("%.4f", Coefficient),
      SE = sprintf("%.4f", SE),
      t_stat = sprintf("%.3f", t_stat),
      p_value_formatted = sprintf("%.4f", p_value)
    )
  
  cat("\n\n\\clearpage\n")
  cat("\\section{Summary of All Significant Results}\n\n")
  
  # Split table if more than 45 rows
  split_at <- 45
  n_tables <- ceiling(nrow(all_significant_results) / split_at)
  
  for (table_num in 1:n_tables) {
    start_row <- (table_num - 1) * split_at + 1
    end_row <- min(table_num * split_at, nrow(all_significant_results))
    
    # Use landscape mode for wide table
    cat("\\begin{landscape}\n")
    cat("\\begin{table}[H]\n")
    
    if (n_tables > 1) {
      cat(sprintf("\\caption{All Significant Results (p < 0.1) from All Analyses - Part %d of %d}\n", table_num, n_tables))
    } else {
      cat("\\caption{All Significant Results (p < 0.1) from All Analyses}\n")
    }
    
    cat(sprintf("\\label{tab:all_significant_results%s}\n", ifelse(table_num > 1, paste0("_", table_num), "")))
    cat("\\centering\n")
    cat("\\footnotesize\n") # Use footnotesize instead of tiny
    cat("\\setlength{\\tabcolsep}{4pt}\n") # Slightly larger column separation
    # Adjust column widths
    cat("\\begin{tabular}{p{3.5cm} p{2.2cm} p{3.2cm} p{1.2cm} r r r r c}\n") 
    cat("\\toprule\n")
    cat("Analysis & Outcome & Variable & Model & Coef. & SE & t-stat & p-value & Sig. \\\\\n")
    cat("\\midrule\n")
    
    current_category <- ""
    for (i in start_row:end_row) {
      if (all_significant_results$Category[i] != current_category) {
        if (current_category != "") {
          cat("\\addlinespace[0.5em]\n") 
        }
        current_category <- all_significant_results$Category[i]
        cat(sprintf("\\multicolumn{9}{l}{\\textbf{%s}} \\\\\n", escape_latex(current_category)))
        cat("\\midrule\n")
      }
      
      # Shorten analysis names for moderation
      analysis_text <- all_significant_results$Analysis[i]
      if (grepl("Moderation by", analysis_text)) {
        analysis_text <- gsub("Moderation by ", "", analysis_text)
      }
      
      cat(sprintf("%s & %s & %s & %s & %s & %s & %s & %s & %s \\\\\n",
                  escape_latex(analysis_text),
                  escape_latex(all_significant_results$Outcome[i]),
                  escape_latex(all_significant_results$Variable[i]),
                  escape_latex(all_significant_results$Model[i]),
                  all_significant_results$Coefficient[i],
                  all_significant_results$SE[i],
                  all_significant_results$t_stat[i],
                  all_significant_results$p_value_formatted[i],
                  all_significant_results$Significance[i]))
    }
    
    cat("\\bottomrule\n")
    cat("\\end{tabular}\n")
    
    if (table_num == n_tables) {
      cat("\\parbox{\\linewidth}{\\footnotesize Note: Significance levels: + p<0.1; * p<0.05; ** p<0.01; *** p<0.001. ")
      cat("SE = Clustered standard errors at department level. ")
      cat("For moderation analyses, only significant interaction terms are shown.}\n")
    }
    
    cat("\\end{table}\n")
    cat("\\end{landscape}\n")
    
    if (table_num < n_tables) {
      cat("\\clearpage\n")
    }
  }
  
} else {
  cat("\n\\textit{No significant results (p < 0.1) for treatment or interaction effects found in any of the analyses.}\n\n")
}
```